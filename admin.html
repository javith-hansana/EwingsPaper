<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="admin.css">
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4>Paper Class Admin</h4>
            <div class="sidebar-clock">
                <div id="currentTime" class="clock-time"></div>
                <div id="currentDate" class="clock-date"></div>
            </div>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-group">
                <div class="sidebar-group-title">Dashboard</div>
                <a href="#" class="active" id="dashboardTab"><i class="bi bi-speedometer2"></i> Dashboard</a>
            </div>
            
            <div class="sidebar-group">
                <div class="sidebar-group-title">User Management</div>
                <a href="#" id="userManagementTab"><i class="bi bi-people"></i> User Management</a>
            </div>
            
            <div class="sidebar-group">
                <div class="sidebar-group-title">Online Papers</div>
                <a href="#" id="createPaperTab"><i class="bi bi-file-earmark-plus"></i> Create Paper</a>
                <a href="#" id="viewPapersTab"><i class="bi bi-collection"></i> View Papers</a>
                <a href="#" id="viewSubmissionsTab"><i class="bi bi-list-check"></i> View Submissions</a>
                <a href="#" id="viewRankingsTab"><i class="bi bi-trophy"></i> View Rankings</a>
            </div>
            
            <div class="sidebar-group">
                <div class="sidebar-group-title">Paper Class</div>
                <a href="#" id="paperClassTab"><i class="bi bi-journal-text"></i> Paper Class</a>
                <a href="#" id="viewPaperClassPapersTab"><i class="bi bi-collection"></i> View Papers</a>
                <a href="#" id="viewPaperClassSubmissionsTab"><i class="bi bi-list-check"></i> View Submissions</a>
                <a href="#" id="paperClassRankingsTab"><i class="bi bi-award"></i> View Rankings</a>
            </div>
            
            <div class="sidebar-group">
                <div class="sidebar-group-title">General Forms</div>
                <a href="#" id="generalFormsTab"><i class="bi bi-card-checklist"></i> Create Form</a>
                <a href="#" id="viewFormsTab"><i class="bi bi-collection"></i> View Forms</a>
                <a href="#" id="viewFormSubmissionsTab"><i class="bi bi-list-check"></i> View Submissions</a>
            </div>
            
            <div class="sidebar-group">
                <div class="sidebar-group-title">Discussions</div>
                <a href="#" id="discussionTab"><i class="bi bi-chat-square-text"></i> Paper Discussions</a>
            </div>
            
            <div class="mt-4 px-3">
                <button class="logout-btn" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Dashboard Overview</h3>
                <div class="text-muted" id="dashboardDate"></div>
            </div>

            <!-- Stats Cards -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted">Total Papers</h6>
                                    <h3 id="totalPapers">0</h3>
                                    <div class="stat-details">
                                        <span class="badge bg-primary">Online: <span id="onlinePapersCount">0</span></span>
                                        <span class="badge bg-info">Paper Class: <span id="paperClassPapersCount">0</span></span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="bi bi-collection text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted">Total Submissions</h6>
                                    <h3 id="totalSubmissions">0</h3>
                                    <div class="stat-details">
                                        <span class="badge bg-primary">Online: <span id="onlineSubmissionsCount">0</span></span>
                                        <span class="badge bg-info">Paper Class: <span id="paperClassSubmissionsCount">0</span></span>
                                        <span class="badge bg-success">Forms: <span id="formSubmissionsCount">0</span></span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="bi bi-list-check text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted">Active Papers</h6>
                                    <h3 id="activePapers">0</h3>
                                    <div class="stat-details">
                                        <span class="badge bg-primary">Online: <span id="activeOnlinePapers">0</span></span>
                                        <span class="badge bg-info">Paper Class: <span id="activePaperClassPapers">0</span></span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="bi bi-hourglass-split text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Papers Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="recentPapersTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="online-papers-tab" data-bs-toggle="tab" data-bs-target="#online-papers" type="button" role="tab">Online Papers</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="paperclass-papers-tab" data-bs-toggle="tab" data-bs-target="#paperclass-papers" type="button" role="tab">Paper Class</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="forms-tab" data-bs-toggle="tab" data-bs-target="#forms" type="button" role="tab">General Forms</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="recentPapersContent">
                        <div class="tab-pane fade show active" id="online-papers" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Submissions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOnlinePapers">
                                        <!-- Recent online papers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="paperclass-papers" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Class</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Submissions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentPaperClassPapers">
                                        <!-- Recent paper class papers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="forms" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Submissions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentGeneralForms">
                                        <!-- Recent general forms will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Notes Section -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Admin Notes</h5>
                    <button class="btn btn-sm btn-primary" id="addNoteBtn">
                        <i class="bi bi-plus"></i> Add Note
                    </button>
                </div>
                <div class="card-body">
                    <div id="notesContainer">
                        <!-- Notes will be loaded here -->
                    </div>
                    <div class="input-group mt-3 d-none" id="noteInputGroup">
                        <input type="text" class="form-control" id="noteInput" placeholder="Enter your note...">
                        <button class="btn btn-success" id="saveNoteBtn">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-secondary" id="cancelNoteBtn">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div id="userManagementSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>User Management</h3>
            </div>

            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="addUsersTab">Add Users</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="accountActivationTab">Account Activation</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="manageUsersTab">Manage Users</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="monthlyPaymentsTab">Monthly Payments</a>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body">
                    <!-- Add Users Tab Content -->
                    <div id="addUsersContent">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Add Single User</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="addSingleUserForm">
                                            <div class="mb-3">
                                                <label class="form-label">Full Name*</label>
                                                <input type="text" class="form-control" id="addUserName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">NIC Number*</label>
                                                <input type="text" class="form-control" id="addUserNIC" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Email*</label>
                                                <input type="email" class="form-control" id="addUserEmail" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">District*</label>
                                                <select class="form-select" id="addUserDistrict" required>
                                                    <option value="">Select District</option>
                                                    <option value="Ampara">Ampara</option>
                                                    <option value="Anuradhapura">Anuradhapura</option>
                                                    <option value="Badulla">Badulla</option>
                                                    <option value="Batticaloa">Batticaloa</option>
                                                    <option value="Colombo">Colombo</option>
                                                    <option value="Galle">Galle</option>
                                                    <option value="Gampaha">Gampaha</option>
                                                    <option value="Hambantota">Hambantota</option>
                                                    <option value="Jaffna">Jaffna</option>
                                                    <option value="Kalutara">Kalutara</option>
                                                    <option value="Kandy">Kandy</option>
                                                    <option value="Kegalle">Kegalle</option>
                                                    <option value="Kilinochchi">Kilinochchi</option>
                                                    <option value="Kurunegala">Kurunegala</option>
                                                    <option value="Mannar">Mannar</option>
                                                    <option value="Matale">Matale</option>
                                                    <option value="Matara">Matara</option>
                                                    <option value="Monaragala">Monaragala</option>
                                                    <option value="Mullaitivu">Mullaitivu</option>
                                                    <option value="Nuwara Eliya">Nuwara Eliya</option>
                                                    <option value="Polonnaruwa">Polonnaruwa</option>
                                                    <option value="Puttalam">Puttalam</option>
                                                    <option value="Ratnapura">Ratnapura</option>
                                                    <option value="Trincomalee">Trincomalee</option>
                                                    <option value="Vavuniya">Vavuniya</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Class*</label>
                                                <select class="form-select" id="addUserClass" required>
                                                    <option value="Nugegoda">Nugegoda</option>
                                                    <option value="Kandy">Kandy</option>
                                                    <option value="Kegalle">Kegalle</option>
                                                    <option value="Kurunegala">Kurunegala</option>
                                                    <option value="Gall">Gall</option>
                                                    <option value="Onlin">Onlin</option>
                                                    <option value="All Island">All Island</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Class Type*</label>
                                                <div class="class-type-options">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="addUserTheory" value="Theory">
                                                        <label class="form-check-label" for="addUserTheory">Theory</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="addUserPaperClass" value="Paper Class">
                                                        <label class="form-check-label" for="addUserPaperClass">Paper Class</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="addUserRevision" value="Revision">
                                                        <label class="form-check-label" for="addUserRevision">Revision</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3" id="addUserStudentIdContainer" style="display: none;">
                                                <label class="form-label">Student ID*</label>
                                                <input type="text" class="form-control" id="addUserStudentId">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">School</label>
                                                <input type="text" class="form-control" id="addUserSchool">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Phone*</label>
                                                <input type="tel" class="form-control" id="addUserPhone" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Year*</label>
                                                <select class="form-select" id="addUserYear" required>
                                                    <option value="">Select Year</option>
                                                    <option value="2025">2025</option>
                                                    <option value="2026">2026</option>
                                                    <option value="2027">2027</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Add User</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Bulk Add Users</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="bulkAddUsersForm">
                                            <div class="mb-3">
                                                <label class="form-label">Year*</label>
                                                <select class="form-select" id="bulkAddYear" required>
                                                    <option value="">Select Year</option>
                                                    <option value="2025">2025</option>
                                                    <option value="2026">2026</option>
                                                    <option value="2027">2027</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Class*</label>
                                                <select class="form-select" id="bulkAddClass" required>
                                                    <option value="Nugegoda">Nugegoda</option>
                                                    <option value="Kandy">Kandy</option>
                                                    <option value="Kegalle">Kegalle</option>
                                                    <option value="Kurunegala">Kurunegala</option>
                                                    <option value="Gall">Gall</option>
                                                    <option value="Onlin">Onlin</option>
                                                    <option value="All Island">All Island</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Class Type*</label>
                                                <select class="form-select" id="bulkAddClassType" required>
                                                    <option value="">Select Class Type</option>
                                                    <option value="Theory">Theory</option>
                                                    <option value="Paper Class">Paper Class</option>
                                                    <option value="Revision">Revision</option>
                                                </select>
                                            </div>
                                            <div class="mb-3" id="bulkAddStudentIdRequired" style="display: none;">
                                                <div class="alert alert-info">
                                                    Note: Your Excel file must include a "Student ID" column
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Excel File*</label>
                                                <input type="file" class="form-control" id="bulkAddExcelFile" accept=".xlsx, .xls" required>
                                                <div class="form-text">
                                                    Excel file should contain columns: Name, Email, NIC (and Student ID if required)
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Upload and Add Users</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Activation Tab Content -->
                    <div id="accountActivationContent" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Pending Accounts</span>
                                    <input type="text" class="form-control w-25" id="pendingAccountsSearch" placeholder="Search...">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Student ID</th>
                                                <th>Class</th>
                                                <th>Class Type</th>
                                                <th>Email</th>
                                                <th>NIC</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pendingAccountsList">
                                            <!-- Pending accounts will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manage Users Tab Content -->
                    <div id="manageUsersContent" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>All Users</span>
                                    <div class="input-group w-50">
                                        <input type="text" class="form-control" id="userSearch" placeholder="Search by Student ID or Email">
                                        <button class="btn btn-outline-secondary" type="button" id="searchUserBtn">Search</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Student ID</th>
                                                <th>Class</th>
                                                <th>Class Type</th>
                                                <th>Email</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersList">
                                            <!-- Users will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Monthly payments-->
                    <div id="monthlyPaymentsContent" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Payment Records</span>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary" id="addPaymentsBtn">
                                        <i class="bi bi-upload"></i> Add Payments
                                    </button>
                                    <button class="btn btn-sm btn-success" id="markAllPaidBtn">
                                        <i class="bi bi-check-all"></i> Mark All Paid
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                    <label class="form-label">Filter by Month</label>
                                        <select class="form-select" id="paymentMonthFilter">
                                            <option value="">All Months</option>
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Filter by Year</label>
                                        <select class="form-select" id="paymentYearFilter">
                                            <option value="">All Years</option>
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Filter by Status</label>
                                        <select class="form-select" id="paymentStatusFilter">
                                            <option value="">All Statuses</option>
                                            <option value="paid">Paid</option>
                                            <option value="unpaid">Unpaid</option>
                                        </select>
                                    </div>
                                </div>
            
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Student ID</th>
                                                <th>Name</th>
                                                <th>Class</th>
                                                <th>Payment Status</th>
                                                <th>Last Payment Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paymentsList">
                                            <!-- Payments will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Paper Section -->
        <div id="createPaperSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Create New Paper</h3>
<div class="btn-group" role="group">
  <button type="button" class="btn btn-outline-secondary" id="template15Btn">
    Temp 15MCQ
  </button>
  <button type="button" class="btn btn-outline-secondary" id="template25Btn">
    Temp 25MCQ
  </button>
  <button type="button" class="btn btn-outline-secondary" id="template50Btn">
    Temp 50MCQ
  </button>
</div>
    </div>

    <div class="card">
        <div class="card-header">Paper Details</div>
        <div class="card-body">
            <form id="createPaperForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paperTitle" class="form-label">Paper Title*</label>
                        <input type="text" class="form-control" id="paperTitle" required>
                    </div>
                    <div class="col-md-3">
                        <label for="paperYear" class="form-label">Year*</label>
                        <input type="number" class="form-control" id="paperYear" required>
                    </div>
                    <div class="col-md-3">
                        <label for="paperNumber" class="form-label">Paper Number*</label>
                        <input type="number" class="form-control" id="paperNumber" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paperSubject" class="form-label">Subject*</label>
                        <input type="text" class="form-control" id="paperSubject" value="Physics" required>
                    </div>
                    <div class="col-md-6">
                        <label for="paperMedium" class="form-label">Medium*</label>
                        <select class="form-select" id="paperMedium" required>
                            <option value="All Mediums">All Mediums</option>
                            <option value="Sinhala">Sinhala</option>
                            <option value="English">English</option>
                            <option value="Tamil">Tamil</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="openTime" class="form-label">Open Date & Time*</label>
                        <input type="datetime-local" class="form-control" id="openTime" required>
                    </div>
                    <div class="col-md-6">
                        <label for="closeTime" class="form-label">Close Date & Time*</label>
                        <input type="datetime-local" class="form-control" id="closeTime" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="paperPdf" class="form-label">Upload Paper PDF (Sinhala)*</label>
                    <input type="file" class="form-control" id="paperPdfSinhala" accept=".pdf" required>
                </div>

                <div class="mb-3">
                    <label for="paperPdf" class="form-label">Upload Paper PDF (English)*</label>
                    <input type="file" class="form-control" id="paperPdfEnglish" accept=".pdf" required>
                </div>

                <div class="mb-3">
                    <label for="answerKeyPdf" class="form-label">Upload Answer Key PDF*</label>
                    <input type="file" class="form-control" id="answerKeyPdf" accept=".pdf" required>
                </div>

                <div class="mb-4">
                    <h5 class="border-bottom pb-2">MCQ Questions & Answers</h5>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Just enter the question numbers and correct answers. 
                        The options will be taken from the uploaded PDF.
                    </div>
                    <div id="questionsContainer">
                        <!-- Questions will be loaded here -->
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-2" id="addQuestionBtn">
                        <i class="bi bi-plus-circle"></i> Add Question
                    </button>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="createPaperBtn">
                        <span id="createPaperBtnText">Create Paper</span>
                        <span id="createPaperSpinner" class="loading-spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
        </div>

        <!-- View Papers Section -->
        <div id="viewPapersSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>All Papers</h3>
        <div class="input-group" style="width: 200px;">
            <select class="form-select" id="paperYearFilter">
                <option value="">All Years</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="paperTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-papers" type="button" role="tab">Active</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming-papers" type="button" role="tab">Upcoming</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="closed-tab" data-bs-toggle="tab" data-bs-target="#closed-papers" type="button" role="tab">Closed</button>
        </li>
    </ul>

    <div class="tab-content" id="paperTabsContent">
        <div class="tab-pane fade show active" id="active-papers" role="tabpanel">
            <div class="row" id="activePapersContainer">
                <!-- Active papers will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="upcoming-papers" role="tabpanel">
            <div class="row" id="upcomingPapersContainer">
                <!-- Upcoming papers will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="closed-papers" role="tabpanel">
            <div class="row" id="closedPapersContainer">
                <!-- Closed papers will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>

        <!-- View Submissions Section -->
        <div id="viewSubmissionsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Paper Submissions</h3>
        <div>
            <div class="input-group">
                <select class="form-select" id="submissionYearFilter" style="width: 120px;">
                    <option value="">All Years</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <select class="form-select" id="submissionMonthFilter" style="width: 120px;">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
                <button class="btn btn-outline-secondary" type="button" id="submissionFilterBtn">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div id="submissionPaperCards" class="row">
                <!-- Paper cards will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="submissionsListCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 id="selectedPaperTitle">Submissions</h5>
            <button class="btn btn-sm btn-outline-secondary" id="backToPapersBtn">
                <i class="bi bi-arrow-left"></i> Back to Papers
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>NIC</th>
                            <th>District</th>
                            <th>Class</th>
                            <th>Score</th>
                            <th>Submitted At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsList">
                        <!-- Submissions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>

        <!-- View Rankings Section -->
        <div id="viewRankingsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Paper Rankings</h3>
        <div class="input-group" style="width: 300px;">
            <select class="form-select" id="rankingYearFilter">
                <option value="">All Years</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
            </select>
            <select class="form-select" id="rankingMonthFilter">
                <option value="">All Months</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" id="rankingFilterBtn">
                <i class="bi bi-funnel"></i> Filter
            </button>
        </div>
    </div>

    <div class="row" id="rankingPaperCards">
        <!-- Paper cards will be loaded here -->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="card mt-4" id="rankingsListCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 id="selectedRankingPaperTitle">Rankings</h4>
            <div>
                <button class="btn btn-sm btn-outline-primary" id="backToRankingPapersBtn">
                    <i class="bi bi-arrow-left"></i> Back to Papers
                </button>
                <button class="btn btn-sm btn-primary ms-2" id="downloadRankingPdfBtn">
                    <i class="bi bi-file-earmark-pdf"></i> Download PDF
                </button>
                <button class="btn btn-sm btn-success ms-2" id="classRankingsBtn">
                    <i class="bi bi-people"></i> Class Rankings
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Student</th>
                            <th>NIC</th>
                            <th>District</th>
                            <th>Class</th>
                            <th>School</th>
                            <th>Score</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="rankingsList">
                        <tr id="rankingsLoading">
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>

        <!-- Paper Class Section -->
        <div id="paperClassSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Create Paper Class Paper</h3>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" id="paperClassTemplate15Btn">Temp 15 MCQ</button>
            <button type="button" class="btn btn-outline-secondary" id="paperClassTemplate25Btn">Temp 25 MCQ</button>
            <button type="button" class="btn btn-outline-secondary" id="paperClassTemplate50Btn">Temp 50 MCQ</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Paper Details</div>
        <div class="card-body">
            <form id="createPaperClassForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paperClassTitle" class="form-label">Paper Title*</label>
                        <input type="text" class="form-control" id="paperClassTitle" required>
                    </div>
                    <div class="col-md-3">
                        <label for="paperClassYear" class="form-label">Year*</label>
                        <input type="number" class="form-control" id="paperClassYear" required>
                    </div>
                    <div class="col-md-3">
                        <label for="paperClassNumber" class="form-label">Paper Number*</label>
                        <input type="number" class="form-control" id="paperClassNumber" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paperClassSubject" class="form-label">Subject*</label>
                        <input type="text" class="form-control" id="paperClassSubject" value="Physics" required>
                    </div>
                    <div class="col-md-6">
                        <label for="paperClassMedium" class="form-label">Medium*</label>
                        <select class="form-select" id="paperClassMedium" required>
                            <option value="All Mediums">All Mediums</option>
                            <option value="Sinhala">Sinhala</option>
                            <option value="English">English</option>
                            <option value="Tamil">Tamil</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paperClassOpenTime" class="form-label">Open Date & Time*</label>
                        <input type="datetime-local" class="form-control" id="paperClassOpenTime" required>
                    </div>
                    <div class="col-md-6">
                        <label for="paperClassCloseTime" class="form-label">Close Date & Time*</label>
                        <input type="datetime-local" class="form-control" id="paperClassCloseTime" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="paperClassPdf" class="form-label">Upload Paper PDF (Sinhala)*</label>
                    <input type="file" class="form-control" id="paperClassPdfSinhala" accept=".pdf" required>
                </div>

                <div class="mb-3">
                    <label for="paperClassPdf" class="form-label">Upload Paper PDF (English)*</label>
                    <input type="file" class="form-control" id="paperClassPdfEnglish" accept=".pdf" required>
                </div>

                <div class="mb-3">
                    <label for="paperClassAnswerKeyPdf" class="form-label">Upload Answer Key PDF*</label>
                    <input type="file" class="form-control" id="paperClassAnswerKeyPdf" accept=".pdf" required>
                </div>

                <div class="mb-4">
                    <h5 class="border-bottom pb-2">Questions & Answers</h5>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Enter question details including marks allocation.
                    </div>
                    <div id="paperClassQuestionsContainer">
                        <!-- Questions will be loaded here -->
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-2" id="addPaperClassQuestionBtn">
                        <i class="bi bi-plus-circle"></i> Add Question
                    </button>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="createPaperClassBtn">
                        <span id="createPaperClassBtnText">Create Paper</span>
                        <span id="createPaperClassSpinner" class="loading-spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
        </div>

        <!-- View Paper Class Papers Section -->
        <div id="viewPaperClassPapersSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Paper Class Papers</h3>
        <div class="input-group" style="width: 200px;">
            <select class="form-select" id="paperClassYearFilter">
                <option value="">All Years</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="paperClassTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="paperClassActive-tab" data-bs-toggle="tab" data-bs-target="#paperClassActive-papers" type="button" role="tab">Active</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="paperClassUpcoming-tab" data-bs-toggle="tab" data-bs-target="#paperClassUpcoming-papers" type="button" role="tab">Upcoming</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="paperClassClosed-tab" data-bs-toggle="tab" data-bs-target="#paperClassClosed-papers" type="button" role="tab">Closed</button>
        </li>
    </ul>

    <div class="tab-content" id="paperClassTabsContent">
        <div class="tab-pane fade show active" id="paperClassActive-papers" role="tabpanel">
            <div class="row" id="paperClassActivePapersContainer">
                <!-- Active papers will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="paperClassUpcoming-papers" role="tabpanel">
            <div class="row" id="paperClassUpcomingPapersContainer">
                <!-- Upcoming papers will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="paperClassClosed-papers" role="tabpanel">
            <div class="row" id="paperClassClosedPapersContainer">
                <!-- Closed papers will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>

        <!-- View Paper Class Submissions Section -->
        <div id="viewPaperClassSubmissionsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Paper Class Submissions</h3>
        <div>
            <div class="input-group">
                <select class="form-select" id="paperClassSubmissionYearFilter" style="width: 120px;">
                    <option value="">All Years</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <select class="form-select" id="paperClassSubmissionMonthFilter" style="width: 120px;">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
                <button class="btn btn-outline-secondary" type="button" id="paperClassSubmissionFilterBtn">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div id="paperClassSubmissionPaperCards" class="row">
                <!-- Paper cards will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="paperClassSubmissionsListCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 id="selectedPaperClassPaperTitle">Submissions</h5>
            <button class="btn btn-sm btn-outline-secondary" id="backToPaperClassPapersBtn">
                <i class="bi bi-arrow-left"></i> Back to Papers
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>NIC</th>
                            <th>District</th>
                            <th>Class</th>
                            <th>MCQ Score</th>
                            <th>Submitted At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paperClassSubmissionsList">
                        <!-- Submissions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>

        <!-- Paper Class Rankings Section -->
        <div id="paperClassRankingsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Paper Class Rankings</h3>
    </div>

    <ul class="nav nav-tabs mb-4" id="rankingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="addRankings-tab" data-bs-toggle="tab" data-bs-target="#addRankings" type="button" role="tab">Add Rankings</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="viewRankings-tab" data-bs-toggle="tab" data-bs-target="#viewRankings" type="button" role="tab">View Rankings</button>
        </li>
    </ul>

    <div class="tab-content" id="rankingsTabsContent">
        <!-- Add Rankings Tab -->
        <div class="tab-pane fade show active" id="addRankings" role="tabpanel">
            <div class="card">
                <div class="card-header">Upload Student Scores</div>
                <div class="card-body">
                    <form id="uploadRankingsForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="rankingsPaperSelect" class="form-label">Select Paper*</label>
                                <select class="form-select" id="rankingsPaperSelect" required>
                                    <option value="">Select a paper</option>
                                    <!-- Papers will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="rankingsBatchName" class="form-label">Batch Name*</label>
                                <input type="text" class="form-control" id="rankingsBatchName" placeholder="e.g., First Attempt, Mock Exam" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rankingsFile" class="form-label">Excel File*</label>
                            <input type="file" class="form-control" id="rankingsFile" accept=".xlsx,.xls" required>
                            <div class="form-text">File should have columns: Student ID, Score (and optionally Name)</div>
                        </div>
                        <div class="alert alert-warning mt-3" id="duplicateWarning" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> <span id="duplicateMessage"></span>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="uploadRankingsBtn">
                                <span id="uploadRankingsBtnText">Upload Scores</span>
                                <span id="uploadRankingsSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="uploadPreview" class="mt-4" style="display: none;">
                        <h5>Upload Preview</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="previewTable">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Score</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                    <!-- Preview rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" id="confirmUploadBtn" style="display: none;">
                            <i class="bi bi-check-circle"></i> Confirm Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- View Rankings Tab -->
        <div class="tab-pane fade" id="viewRankings" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>All Paper Rankings</span>
                    <div class="d-flex justify-content-between mb-3">
                        <select class="form-select" id="rankingsPaperFilter" style="width: 300px;">
                            <option value="">All Papers</option>
                        </select>
                        <button class="btn btn-primary" id="publishAllForPaperBtn" style="display: none;">
                            <i class="bi bi-check-all"></i> Publish All Batches for Selected Paper
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="rankingsContainer">
                        <!-- Paper ranking cards will be loaded here -->
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>

        <!--Discussion Section-->
        <div id="discussionSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Paper Discussions</h3>
        <button class="btn btn-primary" id="addDiscussionBtn">
            <i class="bi bi-plus-circle"></i> Add New Discussion
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>All Discussions</span>
                <div class="input-group" style="width: 300px;">
                    <select class="form-select" id="discussionTypeFilter">
                        <option value="all">All Types</option>
                        <option value="paperClass">Paper Class</option>
                        <option value="onlineClass">Online Class</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="filterDiscussionsBtn">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Related Paper</th>
                            <th>Chapters</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="discussionsList">
                        <!-- Discussions will be loaded here -->
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>

        <!-- Create General Form Section -->
        <div id="generalFormsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Create New Form</h3>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" id="templateSurveyBtn">Survey Template</button>
            <button type="button" class="btn btn-outline-secondary" id="templateFeedbackBtn">Feedback Form</button>
            <button type="button" class="btn btn-outline-secondary" id="templateQuizBtn">Quiz Template</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Form Details</div>
        <div class="card-body">
            <form id="createGeneralFormForm">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="formTitle" class="form-label">Form Title*</label>
                        <input type="text" class="form-control" id="formTitle" required>
                    </div>
                    <div class="col-md-4">
                        <label for="formAccess" class="form-label">Access*</label>
                        <select class="form-select" id="formAccess" required>
                            <option value="students">Only Our Students</option>
                            <option value="public">Public (Anyone with link)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="formDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="formDescription" rows="2"></textarea>
                </div>

                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="formRequireLogin">
                    <label class="form-check-label" for="formRequireLogin">Require login to submit (for student forms)</label>
                </div>

                <div class="mb-3">
                    <label for="formCloseTime" class="form-label">Close Date & Time (optional)</label>
                    <input type="datetime-local" class="form-control" id="formCloseTime">
                </div>

                <div class="mb-4">
                    <h5 class="border-bottom pb-2">Form Questions</h5>
                    <div id="formQuestionsContainer">
                        <!-- Questions will be added here -->
                    </div>
                    <div class="dropdown mt-2">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="addQuestionDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-plus-circle"></i> Add Question
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-type="short-answer">Short Answer</a></li>
                            <li><a class="dropdown-item" href="#" data-type="paragraph">Paragraph</a></li>
                            <li><a class="dropdown-item" href="#" data-type="multiple-choice">Multiple Choice</a></li>
                            <li><a class="dropdown-item" href="#" data-type="checkbox">Checkbox</a></li>
                            <li><a class="dropdown-item" href="#" data-type="dropdown">Dropdown</a></li>
                            <li><a class="dropdown-item" href="#" data-type="file-upload">File Upload</a></li>
                            <li><a class="dropdown-item" href="#" data-type="linear-scale">Linear Scale</a></li>
                            <li><a class="dropdown-item" href="#" data-type="rating">Rating</a></li>
                            <li><a class="dropdown-item" href="#" data-type="multiple-choice-grid">Multiple Choice Grid</a></li>
                            <li><a class="dropdown-item" href="#" data-type="checkbox-grid">Checkbox Grid</a></li>
                            <li><a class="dropdown-item" href="#" data-type="date">Date</a></li>
                            <li><a class="dropdown-item" href="#" data-type="time">Time</a></li>
                        </ul>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="createFormBtn">
                        <span id="createFormBtnText">Create Form</span>
                        <span id="createFormSpinner" class="loading-spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
        </div>

        <!-- View General Forms Section -->
        <div id="viewGeneralFormsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>All Forms</h3>
    </div>

    <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="formActive-tab" data-bs-toggle="tab" data-bs-target="#formActive" type="button" role="tab">Active</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="formUpcoming-tab" data-bs-toggle="tab" data-bs-target="#formUpcoming" type="button" role="tab">Upcoming</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="formClosed-tab" data-bs-toggle="tab" data-bs-target="#formClosed" type="button" role="tab">Closed</button>
        </li>
    </ul>

    <div class="tab-content" id="formTabsContent">
        <div class="tab-pane fade show active" id="formActive" role="tabpanel">
            <div class="row" id="activeFormsContainer">
                <!-- Active forms will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="formUpcoming" role="tabpanel">
            <div class="row" id="upcomingFormsContainer">
                <!-- Upcoming forms will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="formClosed" role="tabpanel">
            <div class="row" id="closedFormsContainer">
                <!-- Closed forms will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>

        <!-- View General Form Submissions Section -->
        <div id="viewGeneralFormSubmissionsSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Form Submissions</h3>
        <div>
            <div class="input-group">
                <select class="form-select" id="formSubmissionYearFilter" style="width: 120px;">
                    <option value="">All Years</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <select class="form-select" id="formSubmissionMonthFilter" style="width: 120px;">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
                <button class="btn btn-outline-secondary" type="button" id="formSubmissionFilterBtn">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div id="formSubmissionCards" class="row">
                <!-- Form cards will be loaded here -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="formSubmissionsListCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 id="selectedFormTitle">Submissions</h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary" id="backToFormsBtn">
                    <i class="bi bi-arrow-left"></i> Back to Forms
                </button>
                <button class="btn btn-sm btn-primary ms-2" id="downloadFormSubmissionsBtn">
                    <i class="bi bi-download"></i> Export as CSV
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <label for="questionFilter" class="form-label">Filter by Question:</label>
                        <select class="form-select" id="questionFilter">
                            <option value="">All Questions</option>
                            <!-- Questions will be populated here -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="responseFilter" class="form-label">Filter by Response:</label>
                        <input type="text" class="form-control" id="responseFilter" placeholder="Enter response text">
                    </div>
                </div>
                <button class="btn btn-sm btn-primary mt-2" id="applyFiltersBtn">
                    <i class="bi bi-funnel"></i> Apply Filters
                </button>
                <button class="btn btn-sm btn-outline-secondary mt-2 ms-2" id="resetFiltersBtn">
                    <i class="bi bi-x-circle"></i> Reset
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Submission ID</th>
                            <th>Respondent</th>
                            <th>Submitted At</th>
                            <th>Responses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="formSubmissionsList">
                        <!-- Submissions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>

        <!-- Modals -->
        <!-- Class Rankings Modal -->
        <div class="modal fade" id="classRankingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Class Rankings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="classRankingsContent">
                <!-- Class rankings will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadAllClassRankingsBtn">
                    <i class="bi bi-download"></i> Download All as PDF
                </button>
            </div>
        </div>
    </div>
        </div>


        <!-- Submission Details Modal -->
        <div class="modal fade" id="submissionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Submission Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="submissionDetails">
                    <!-- Submission details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
        </div>

        <!-- Paper Details Modal -->
        <div class="modal fade" id="paperModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Paper Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="paperDetails">
                <!-- Paper details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copyPaperLinkBtn">
                    <i class="bi bi-link-45deg"></i> Copy Paper Link
                </button>
                <button type="button" class="btn btn-danger ms-2" id="deletePaperBtn">
                    <i class="bi bi-trash"></i> Delete Paper
                </button>
            </div>
        </div>
    </div>
        </div>

        <!-- Edit User Modal -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Full Name*</label>
                                <input type="text" class="form-control" id="editUserName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email*</label>
                                <input type="email" class="form-control" id="editUserEmail" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">NIC Number*</label>
                                <input type="text" class="form-control" id="editUserNIC" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="editUserStudentId">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Class*</label>
                                <select class="form-select" id="editUserClass" required>
                                    <option value="Nugegoda">Nugegoda</option>
                                    <option value="Kandy">Kandy</option>
                                    <option value="Kegalle">Kegalle</option>
                                    <option value="Kurunegala">Kurunegala</option>
                                    <option value="Gall">Gall</option>
                                    <option value="Onlin">Onlin</option>
                                    <option value="All Island">All Island</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">District*</label>
                                <select class="form-select" id="editUserDistrict" required>
                                    <option value="">Select District</option>
                                    <option value="Ampara">Ampara</option>
                                    <option value="Anuradhapura">Anuradhapura</option>
                                    <option value="Badulla">Badulla</option>
                                    <option value="Batticaloa">Batticaloa</option>
                                    <option value="Colombo">Colombo</option>
                                    <option value="Galle">Galle</option>
                                    <option value="Gampaha">Gampaha</option>
                                    <option value="Hambantota">Hambantota</option>
                                    <option value="Jaffna">Jaffna</option>
                                    <option value="Kalutara">Kalutara</option>
                                    <option value="Kandy">Kandy</option>
                                    <option value="Kegalle">Kegalle</option>
                                    <option value="Kilinochchi">Kilinochchi</option>
                                    <option value="Kurunegala">Kurunegala</option>
                                    <option value="Mannar">Mannar</option>
                                    <option value="Matale">Matale</option>
                                    <option value="Matara">Matara</option>
                                    <option value="Monaragala">Monaragala</option>
                                    <option value="Mullaitivu">Mullaitivu</option>
                                    <option value="Nuwara Eliya">Nuwara Eliya</option>
                                    <option value="Polonnaruwa">Polonnaruwa</option>
                                    <option value="Puttalam">Puttalam</option>
                                    <option value="Ratnapura">Ratnapura</option>
                                    <option value="Trincomalee">Trincomalee</option>
                                    <option value="Vavuniya">Vavuniya</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Year*</label>
                                <select class="form-select" id="editUserYear" required>
                                    <option value="">Select Year</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">School</label>
                                <input type="text" class="form-control" id="editUserSchool">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone*</label>
                                <input type="tel" class="form-control" id="editUserPhone" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Class Types*</label>
                            <div class="class-type-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editUserTheory" value="Theory">
                                    <label class="form-check-label" for="editUserTheory">Theory</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editUserPaperClass" value="Paper Class">
                                    <label class="form-check-label" for="editUserPaperClass">Paper Class</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editUserRevision" value="Revision">
                                    <label class="form-check-label" for="editUserRevision">Revision</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Account Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editUserActive">
                                <label class="form-check-label" for="editUserActive">Active</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editUserVerified">
                                <label class="form-check-label" for="editUserVerified">Verified</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserChanges">Save Changes</button>
                </div>
            </div>
        </div>
        </div>


        <!-- Paper Class Submission Details Modal -->
        <div class="modal fade" id="paperClassSubmissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Paper Class Submission Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="paperClassSubmissionDetails">
                <!-- Submission details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
        </div>

        <!-- Paper Class Paper Details Modal -->
        <div class="modal fade" id="paperClassPaperModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Paper Class Paper Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="paperClassPaperDetails">
                <!-- Paper details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copyPaperClassLinkBtn">
                    <i class="bi bi-link-45deg"></i> Copy Paper Link
                </button>
                <button type="button" class="btn btn-danger ms-2" id="deletePaperClassBtn">
                    <i class="bi bi-trash"></i> Delete Paper
                </button>
            </div>
        </div>
    </div>
        </div>

        <!-- Form Details Modal -->
        <div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Form Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="formDetails">
                <!-- Form details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger ms-2" id="deleteFormBtn">
                    <i class="bi bi-trash"></i> Delete Form
                </button>
            </div>
        </div>
    </div>
        </div>

        <!-- Submission Details Modal -->
        <div class="modal fade" id="formSubmissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submission Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="formSubmissionDetails">
                <!-- Submission details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
        </div>

        <!-- Add Discussion Modal -->
        <div class="modal fade" id="addDiscussionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Discussion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDiscussionForm">
                    <div class="mb-3">
                        <label for="discussionTitle" class="form-label">Discussion Title*</label>
                        <input type="text" class="form-control" id="discussionTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="discussionType" class="form-label">Discussion Type*</label>
                        <select class="form-select" id="discussionType" required>
                            <option value="">Select Type</option>
                            <option value="paperClass">Paper Class</option>
                            <option value="onlineClass">Online Class</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="relatedPaperContainer" style="display: none;">
                        <label for="relatedPaper" class="form-label">Related Paper*</label>
                        <select class="form-select" id="relatedPaper" required>
                            <option value="">Select Paper</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="discussionDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="discussionDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Video Upload*</label>
                        <div id="videoUploadArea" class="border rounded p-4 text-center mb-3" style="cursor: pointer;">
                            <i class="bi bi-cloud-arrow-up display-4 text-muted mb-2"></i>
                            <p class="mb-1">Drag and drop your video file here</p>
                            <p class="text-muted small mb-0">or</p>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="browseVideoBtn">
                                <i class="bi bi-folder2-open"></i> Browse Files
                            </button>
                            <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
                        </div>
                        
                        <div id="videoPreviewContainer" style="display: none;">
                            <div class="ratio ratio-16x9 mb-2">
                                <video id="videoPreview" controls class="rounded"></video>
                            </div>
                            <p id="videoInfo" class="small text-muted"></p>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeVideoBtn">
                                <i class="bi bi-trash"></i> Remove Video
                            </button>
                        </div>
                        
                        <div id="uploadProgressBar" class="progress mt-2" style="display: none; height: 5px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5 class="border-bottom pb-2">Chapters</h5>
                        <div id="chaptersContainer">
                            <!-- Chapters will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-primary mt-2" id="addChapterBtn">
                            <i class="bi bi-plus-circle"></i> Add Chapter
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDiscussionBtn">
                    <span id="saveDiscussionBtnText">Save Discussion</span>
                    <span id="saveDiscussionSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>
        </div>

        <!-- Rankings Details Modal -->
        <div class="modal fade" id="rankingsDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rankingsModalTitle">Rankings Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="rankingsModalBody">
                <!-- Rankings details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="publishRankingsBtn">
                    <i class="bi bi-check-circle"></i> Publish Rankings
                </button>
                <button type="button" class="btn btn-danger" id="deleteRankingsBtn">
                    <i class="bi bi-trash"></i> Delete Batch
                </button>
            </div>
        </div>
    </div>
        </div>

        <!--Add Payment Model-->
        <div class="modal fade" id="addPaymentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Payment Records</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentsForm">
                    <div class="mb-3">
                        <label class="form-label">Payment Month*</label>
                        <select class="form-select" id="paymentMonth" required>
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Year*</label>
                        <select class="form-select" id="paymentYear" required>
                            <option value="">Select Year</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Excel File*</label>
                        <input type="file" class="form-control" id="paymentExcelFile" accept=".xlsx,.xls" required>
                        <div class="form-text">File should contain a single column with Student IDs</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Only students with existing accounts will be marked as paid
                    </div>
                </form>
                <div id="paymentPreview" style="display: none;">
                    <h6>Preview (First 5 records)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="paymentPreviewBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmPaymentsBtn" disabled>
                    <i class="bi bi-check-circle"></i> Confirm Payments
                </button>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Load jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Optional: jsPDF AutoTable plugin for tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="main.js"></script>
<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyD5SRZWB-QwMg7wmyTjcvHZqP-mEdlll_M",
        authDomain: "paper-class-1ab19.firebaseapp.com",
        databaseURL: "https://paper-class-1ab19-default-rtdb.firebaseio.com",
        projectId: "paper-class-1ab19",
        storageBucket: "paper-class-1ab19.firebasestorage.app",
        messagingSenderId: "83634677566",
        appId: "1:83634677566:web:fb4f7a1fd869c3e82e2e6f"
    };

    // Initialize Firebase with persistence
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    }
    const auth = firebase.auth();
    const database = firebase.database();
    const storage = firebase.storage();

    // DOM elements
    const sections = {
        dashboard: document.getElementById('dashboardSection'),
        createPaper: document.getElementById('createPaperSection'),
        viewPapers: document.getElementById('viewPapersSection'),
        viewSubmissions: document.getElementById('viewSubmissionsSection'),
        viewRankings: document.getElementById('viewRankingsSection'),
        userManagement: document.getElementById('userManagementSection'),
        paperClass: document.getElementById('paperClassSection'),
        viewPaperClassPapers: document.getElementById('viewPaperClassPapersSection'),
        viewPaperClassSubmissions: document.getElementById('viewPaperClassSubmissionsSection'),
        generalForms: document.getElementById('generalFormsSection'),
        viewGeneralForms: document.getElementById('viewGeneralFormsSection'),
        viewGeneralFormSubmissions: document.getElementById('viewGeneralFormSubmissionsSection'),
        discussion : document.getElementById('discussionSection'),
        paperClassRankings: document.getElementById('paperClassRankingsSection')
    };

    // Tab navigation
    document.getElementById('dashboardTab').addEventListener('click', () => showSection('dashboard'));
    document.getElementById('createPaperTab').addEventListener('click', () => showSection('createPaper'));
    document.getElementById('viewPapersTab').addEventListener('click', () => {
        showSection('viewPapers');
        loadPapers();
    });
    document.getElementById('viewSubmissionsTab').addEventListener('click', () => {
        showSection('viewSubmissions');
        loadSubmissionPapers();
    });
    document.getElementById('viewRankingsTab').addEventListener('click', () => {
        showSection('viewRankings');
        loadRankingPapers();
    });
    document.getElementById('paperClassTab').addEventListener('click', () => showSection('paperClass'));
    document.getElementById('viewPaperClassSubmissionsTab').addEventListener('click', () => {
        showSection('viewPaperClassSubmissions');
        loadPaperClassSubmissionPapers(); 
        initPaperClassSection();
    });
    document.getElementById('viewPaperClassPapersTab').addEventListener('click', () => {
        showSection('viewPaperClassPapers');
        loadPaperClassPapers();
    });
    document.getElementById('generalFormsTab').addEventListener('click', () => showSection('generalForms'));
    document.getElementById('viewFormsTab').addEventListener('click', () => {
    showSection('viewGeneralForms');
    loadGeneralForms('active'); // Explicitly load active forms
    initFormSection();
});
    document.getElementById('viewFormSubmissionsTab').addEventListener('click', () => {
    showSection('viewGeneralFormSubmissions');
    loadFormSubmissionForms(true); // Load with default filters
    initFormSection();
});
    document.getElementById('discussionTab').addEventListener('click', () => {
        showSection('discussion');
        loadDiscussions();
        initDiscussionSection(); 
    });
    document.getElementById('paperClassRankingsTab').addEventListener('click', async () => {
        try {
            showSection('paperClassRankings');
            await loadRankingsPapers();
            await initRankingsSection();
        } catch (error) {
            console.error('Error initializing rankings section:', error);
            document.getElementById('rankingsContainer').innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-exclamation-triangle display-5 text-danger mb-3"></i>
                    <p class="text-danger">Failed to load rankings</p>
                    <button class="btn btn-secondary mt-3" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Reload Page
                    </button>
                </div>
            `;
        }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => {
            window.location.href = 'admin-login.html';
        });
    });

    // Show section function
    function showSection(sectionName) {
        // Hide all sections
        Object.values(sections).forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // Show the requested section
        if (sections[sectionName]) {
            sections[sectionName].style.display = 'block';
        }
        
        // Update active tab styling
        document.querySelectorAll('.sidebar-menu a').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(`${sectionName}Tab`).classList.add('active');
    }

    // Initialize dashboard
    function initDashboard() {
        updateClock();
        setInterval(updateClock, 1000);
        
        // Load counts
        loadPaperCounts();
        loadSubmissionCounts();
        loadActivePapersCount();
        
        // Load recent items
        loadRecentOnlinePapers();
        loadRecentPaperClassPapers();
        loadRecentGeneralForms();
        
        // Load admin notes
        loadAdminNotes();
        
        // Set up note event listeners
        setupNoteHandlers();
    }

    // Clock function
    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        const dateStr = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        document.getElementById('currentTime').textContent = timeStr;
        document.getElementById('currentDate').textContent = dateStr;
        document.getElementById('dashboardDate').textContent = dateStr;
    }

    // Load paper counts
    function loadPaperCounts() {
        // Online papers count
        database.ref('papers').on('value', snapshot => {
            const papers = snapshot.val() || {};
            document.getElementById('onlinePapersCount').textContent = Object.keys(papers).length;
            updateTotalPapersCount();
        });
        
        // Paper class papers count
        database.ref('paperClassPapers').on('value', snapshot => {
            const papers = snapshot.val() || {};
            document.getElementById('paperClassPapersCount').textContent = Object.keys(papers).length;
            updateTotalPapersCount();
        });
    }

    function updateTotalPapersCount() {
        const onlineCount = parseInt(document.getElementById('onlinePapersCount').textContent) || 0;
        const paperClassCount = parseInt(document.getElementById('paperClassPapersCount').textContent) || 0;
        document.getElementById('totalPapers').textContent = onlineCount + paperClassCount;
    }

    // Load submission counts
    function loadSubmissionCounts() {
        // Online submissions
        database.ref('submissions').on('value', snapshot => {
            const submissions = snapshot.val() || {};
            let total = 0;
            Object.values(submissions).forEach(paper => {
                total += Object.keys(paper).length;
            });
            document.getElementById('onlineSubmissionsCount').textContent = total;
            updateTotalSubmissionsCount();
        });
        
        // Paper class submissions
        database.ref('paperClassSubmissions').on('value', snapshot => {
            const submissions = snapshot.val() || {};
            let total = 0;
            Object.values(submissions).forEach(paper => {
                total += Object.keys(paper).length;
            });
            document.getElementById('paperClassSubmissionsCount').textContent = total;
            updateTotalSubmissionsCount();
        });
        
        // Form submissions
        database.ref('formSubmissions').on('value', snapshot => {
            const formsSubmissions = snapshot.val() || {};
            let total = 0;
            Object.values(formsSubmissions).forEach(submissions => {
                total += Object.keys(submissions).length;
            });
            document.getElementById('formSubmissionsCount').textContent = total;
            updateTotalSubmissionsCount();
        });
    }

    function updateTotalSubmissionsCount() {
        const onlineCount = parseInt(document.getElementById('onlineSubmissionsCount').textContent) || 0;
        const paperClassCount = parseInt(document.getElementById('paperClassSubmissionsCount').textContent) || 0;
        const formCount = parseInt(document.getElementById('formSubmissionsCount').textContent) || 0;
        document.getElementById('totalSubmissions').textContent = onlineCount + paperClassCount + formCount;
    }

    // Load active papers count
    function loadActivePapersCount() {
        // Online papers
        database.ref('papers').on('value', snapshot => {
            const papers = snapshot.val() || {};
            const now = new Date().getTime();
            const activePapers = Object.values(papers).filter(paper => {
                return now >= new Date(paper.openTime).getTime() && 
                       now <= new Date(paper.closeTime).getTime();
            });
            document.getElementById('activeOnlinePapers').textContent = activePapers.length;
            updateActivePapersCount();
        });
        
        // Paper class papers
        database.ref('paperClassPapers').on('value', snapshot => {
            const papers = snapshot.val() || {};
            const now = new Date().getTime();
            const activePapers = Object.values(papers).filter(paper => {
                return now >= new Date(paper.openTime).getTime() && 
                       now <= new Date(paper.closeTime).getTime();
            });
            document.getElementById('activePaperClassPapers').textContent = activePapers.length;
            updateActivePapersCount();
        });
    }

    function updateActivePapersCount() {
        const onlineCount = parseInt(document.getElementById('activeOnlinePapers').textContent) || 0;
        const paperClassCount = parseInt(document.getElementById('activePaperClassPapers').textContent) || 0;
        document.getElementById('activePapers').textContent = onlineCount + paperClassCount;
    }

    // Load recent online papers
    function loadRecentOnlinePapers() {
        database.ref('papers').orderByChild('createdAt').limitToLast(10).once('value').then(snapshot => {
            const papers = snapshot.val() || {};
            const papersArray = Object.entries(papers).map(([id, paper]) => ({ id, ...paper }));
            papersArray.sort((a, b) => b.createdAt - a.createdAt);
            
            const tbody = document.getElementById('recentOnlinePapers');
            tbody.innerHTML = '';
            
            papersArray.forEach(paper => {
                const now = new Date().getTime();
                const openTime = new Date(paper.openTime).getTime();
                const closeTime = new Date(paper.closeTime).getTime();
                
                let status = 'Pending';
                let statusClass = 'warning';
                
                if (now > closeTime) {
                    status = 'Closed';
                    statusClass = 'secondary';
                } else if (now >= openTime) {
                    status = 'Active';
                    statusClass = 'success';
                }
                
                // Count submissions
                database.ref(`submissions/${paper.id}`).once('value').then(subSnapshot => {
                    const submissions = subSnapshot.val() || {};
                    const submissionCount = Object.keys(submissions).length;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${paper.title}</td>
                        <td>${paper.type || 'Quiz'}</td>
                        <td><span class="badge bg-${statusClass}">${status}</span></td>
                        <td>${new Date(paper.createdAt).toLocaleDateString()}</td>
                        <td>${submissionCount}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        });
    }

    // Load recent paper class papers
    function loadRecentPaperClassPapers() {
        database.ref('paperClassPapers').orderByChild('createdAt').limitToLast(10).once('value').then(snapshot => {
            const papers = snapshot.val() || {};
            const papersArray = Object.entries(papers).map(([id, paper]) => ({ id, ...paper }));
            papersArray.sort((a, b) => b.createdAt - a.createdAt);
            
            const tbody = document.getElementById('recentPaperClassPapers');
            tbody.innerHTML = '';
            
            papersArray.forEach(paper => {
                const now = new Date().getTime();
                const openTime = new Date(paper.openTime).getTime();
                const closeTime = new Date(paper.closeTime).getTime();
                
                let status = 'Pending';
                let statusClass = 'warning';
                
                if (now > closeTime) {
                    status = 'Closed';
                    statusClass = 'secondary';
                } else if (now >= openTime) {
                    status = 'Active';
                    statusClass = 'success';
                }
                
                // Count submissions
                database.ref(`paperClassSubmissions/${paper.id}`).once('value').then(subSnapshot => {
                    const submissions = subSnapshot.val() || {};
                    const submissionCount = Object.keys(submissions).length;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${paper.title}</td>
                        <td>${paper.className || 'General'}</td>
                        <td><span class="badge bg-${statusClass}">${status}</span></td>
                        <td>${new Date(paper.createdAt).toLocaleDateString()}</td>
                        <td>${submissionCount}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        });
    }

    // Load recent general forms
function loadRecentGeneralForms() {
    database.ref('generalForms').orderByChild('createdAt').limitToLast(10).once('value').then(async snapshot => {
        const forms = snapshot.val() || {};
        const formsArray = Object.entries(forms).map(([id, form]) => ({ id, ...form }));
        formsArray.sort((a, b) => b.createdAt - a.createdAt);

        const tbody = document.getElementById('recentGeneralForms');
        tbody.innerHTML = '';

        for (const form of formsArray) {
            const now = Date.now();
            const openTime = new Date(form.openTime || 0).getTime();
            const closeTime = new Date(form.closeTime || 0).getTime();

            let status = 'Always Open';
            let statusClass = 'info';

            if (form.openTime && form.closeTime) {
                if (now > closeTime) {
                    status = 'Closed';
                    statusClass = 'secondary';
                } else if (now >= openTime) {
                    status = 'Active';
                    statusClass = 'success';
                } else {
                    status = 'Pending';
                    statusClass = 'warning';
                }
            }

            // 🛠 Correctly count submissions from formSubmissions/{formId}
            const subSnapshot = await database.ref(`formSubmissions/${form.id}`).once('value');
            const submissions = subSnapshot.val() || {};
            const submissionCount = Object.keys(submissions).length;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${form.title}</td>
                <td>${form.type || 'Form'}</td>
                <td><span class="badge bg-${statusClass}">${status}</span></td>
                <td>${new Date(form.createdAt).toLocaleDateString()}</td>
                <td>${submissionCount}</td>
            `;
            tbody.appendChild(row);
        }
    });
}

    // Admin notes functionality
    function loadAdminNotes() {
        database.ref('adminNotes').orderByChild('timestamp').limitToLast(5).on('value', snapshot => {
            const notes = snapshot.val() || {};
            const notesArray = Object.entries(notes).map(([id, note]) => ({ id, ...note }));
            notesArray.sort((a, b) => b.timestamp - a.timestamp);
            
            const container = document.getElementById('notesContainer');
            container.innerHTML = '';
            
            if (notesArray.length === 0) {
                container.innerHTML = '<p class="text-muted">No notes yet. Add your first note!</p>';
                return;
            }
            
            notesArray.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item mb-2 p-3 bg-light rounded';
                noteElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1">${note.text}</p>
                            <small class="text-muted">${new Date(note.timestamp).toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger delete-note" data-id="${note.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(noteElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-note').forEach(button => {
                button.addEventListener('click', (e) => {
                    const noteId = e.target.closest('button').dataset.id;
                    database.ref(`adminNotes/${noteId}`).remove();
                });
            });
        });
    }

    function setupNoteHandlers() {
        const addNoteBtn = document.getElementById('addNoteBtn');
        const noteInputGroup = document.getElementById('noteInputGroup');
        const noteInput = document.getElementById('noteInput');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const cancelNoteBtn = document.getElementById('cancelNoteBtn');
        
        addNoteBtn.addEventListener('click', () => {
            noteInputGroup.classList.remove('d-none');
            noteInput.focus();
        });
        
        cancelNoteBtn.addEventListener('click', () => {
            noteInputGroup.classList.add('d-none');
            noteInput.value = '';
        });
        
        saveNoteBtn.addEventListener('click', () => {
            const noteText = noteInput.value.trim();
            if (noteText) {
                const newNote = {
                    text: noteText,
                    timestamp: Date.now(),
                    adminId: auth.currentUser.uid
                };
                
                database.ref('adminNotes').push(newNote)
                    .then(() => {
                        noteInput.value = '';
                        noteInputGroup.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error saving note:', error);
                        alert('Failed to save note. Please try again.');
                    });
            }
        });
        
        noteInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveNoteBtn.click();
            }
        });
    }

    //=========================================================
    //Check Auth
    //=========================================================
    let authStateInitialized = false;
    let isCreatingUser = false;
    let authStateChangeBlocked = false;

    auth.onAuthStateChanged(async (user) => {
        if (isCreatingUser || authStateChangeBlocked) return;
        
        if (user) {
            const isAdmin = await database.ref('admins/' + user.uid).once('value')
                .then(snapshot => snapshot.exists());
            
            if (!isAdmin) {
                await auth.signOut();
                window.location.href = 'admin-login.html';
            } else if (!authStateInitialized) {
                initDashboard();
                initPaperClassSection();
                authStateInitialized = true;
                checkPaymentStatuses();
            }
        } else if (!authStateInitialized) {
            window.location.href = 'admin-login.html';
        }
    });

    // Function to block auth state changes during critical operations
function withAuthStateBlocked(callback) {
    authStateChangeBlocked = true;
    return Promise.resolve(callback()).finally(() => {
        authStateChangeBlocked = false;
    });
}

    // Enhanced checkNICExists with retry logic
    async function checkNICExists(nic) {
        let retries = 3;
        while (retries > 0) {
            try {
                const snapshot = await database.ref('userAuthMap/' + nic).once('value');
                return snapshot.exists();
            } catch (error) {
                retries--;
                if (retries === 0) throw error;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    }

//=======================================================
//User Management
//=======================================================

// User Management Tab
document.getElementById('userManagementTab').addEventListener('click', () => {
    showSection('userManagement');
    showUserManagementTab('addUsers');
});

// User Management Tabs
document.getElementById('addUsersTab').addEventListener('click', () => showUserManagementTab('addUsers'));
document.getElementById('accountActivationTab').addEventListener('click', () => {
    showUserManagementTab('accountActivation');
    loadPendingAccounts();
});
document.getElementById('manageUsersTab').addEventListener('click', () => {
    showUserManagementTab('manageUsers');
    loadAllUsers();
});
document.getElementById('monthlyPaymentsTab').addEventListener('click', () => {
    showUserManagementTab('monthlyPayments');
    loadPaymentRecords();
});

function showUserManagementTab(tab) {
    document.getElementById('addUsersContent').style.display = 'none';
    document.getElementById('accountActivationContent').style.display = 'none';
    document.getElementById('manageUsersContent').style.display = 'none';
    document.getElementById('monthlyPaymentsContent').style.display = 'none';
    
    document.getElementById(tab + 'Content').style.display = 'block';
    
    // Update active tab styling
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    document.getElementById(tab + 'Tab').classList.add('active');
}

// Show/hide student ID field based on class type selection
document.getElementById('addUserPaperClass').addEventListener('change', toggleStudentIdField);
document.getElementById('addUserRevision').addEventListener('change', toggleStudentIdField);
document.getElementById('bulkAddClassType').addEventListener('change', function() {
    const showStudentId = this.value === 'Paper Class' || this.value === 'Revision';
    document.getElementById('bulkAddStudentIdRequired').style.display = showStudentId ? 'block' : 'none';
});

function toggleStudentIdField() {
    const paperClassChecked = document.getElementById('addUserPaperClass').checked;
    const revisionChecked = document.getElementById('addUserRevision').checked;
    document.getElementById('addUserStudentIdContainer').style.display = 
        (paperClassChecked || revisionChecked) ? 'block' : 'none';
}

async function promptAdminPassword() {
    return new Promise((resolve, reject) => {
        const password = prompt("Please enter your admin password to confirm:");
        if (!password) return reject(new Error("Admin password is required."));
        resolve(password);
    });
}

// Add Single User Form
document.getElementById('addSingleUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    form.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding User...';

    try {
        const adminUser = auth.currentUser;
        if (!adminUser) throw new Error('Admin session expired. Please login again.');

        const userData = {
            name: document.getElementById('addUserName').value.trim(),
            nic: document.getElementById('addUserNIC').value.trim(),
            email: document.getElementById('addUserEmail').value.trim(),
            district: document.getElementById('addUserDistrict').value,
            class: document.getElementById('addUserClass').value,
            school: document.getElementById('addUserSchool').value.trim(),
            phone: document.getElementById('addUserPhone').value.trim(),
            registeredYear: document.getElementById('addUserYear').value,
            classTypes: [],
            isActive: true,
            verified: true,
            addedByAdmin: true,
            isPaid: false, // Default payment status
            lastPaymentDate: null, // No payment initially
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        if (document.getElementById('addUserTheory').checked) userData.classTypes.push('Theory');
        if (document.getElementById('addUserPaperClass').checked) userData.classTypes.push('Paper Class');
        if (document.getElementById('addUserRevision').checked) userData.classTypes.push('Revision');

        if (document.getElementById('addUserStudentIdContainer').style.display === 'block') {
            userData.studentId = document.getElementById('addUserStudentId').value.trim();
            if (!userData.studentId) throw new Error('Student ID required for selected class types');
        }

        const requiredFields = ['name', 'nic', 'email', 'district', 'class', 'phone', 'registeredYear'];
        const missingFields = requiredFields.filter(field => !userData[field]);
        if (missingFields.length > 0) throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
        if (userData.classTypes.length === 0) throw new Error('At least one class type must be selected');

        const [nicExists, emailExists] = await Promise.all([
            database.ref('userAuthMap/' + userData.nic).once('value').then(snap => snap.exists()),
            checkEmailExists(userData.email)
        ]);

        if (nicExists) throw new Error('This NIC is already registered');
        if (emailExists) throw new Error('This email is already registered');

        const adminEmail = auth.currentUser.email;
        const adminPassword = await promptAdminPassword();

        await withAuthStateBlocked(async () => {
            const userCredential = await auth.createUserWithEmailAndPassword(userData.email, userData.nic);
            const uid = userCredential.user.uid;

            await database.ref('users/' + uid).set(userData);
            await database.ref('userAuthMap/' + userData.nic).set(uid);

            await auth.signOut();
            await auth.signInWithEmailAndPassword(adminEmail, adminPassword);
            sessionStorage.removeItem('adminTempCredentials');
        });

        alert(`User ${userData.name} added successfully!`);
        form.reset();
    } catch (error) {
        console.error('User creation error:', error);
        alert(`Error adding user: ${error.message}`);
    } finally {
        form.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        submitBtn.innerHTML = originalBtnText;
    }
});

// Helper function to check email existence
async function checkEmailExists(email) {
    try {
        const methods = await auth.fetchSignInMethodsForEmail(email);
        return methods && methods.length > 0;
    } catch (error) {
        if (error.code === 'auth/invalid-email') return false;
        throw error;
    }
}

//User bulk
document.getElementById('bulkAddUsersForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

    const modalHTML = `
        <div class="modal fade" id="bulkUploadProgressModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog"><div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Bulk Upload Progress</h5></div>
                <div class="modal-body">
                    <div class="progress mb-3"><div id="bulkUploadProgressBar" class="progress-bar" style="width: 0%"></div></div>
                    <div id="bulkUploadStatus">Starting upload.</div>
                    <div id="bulkUploadDetails" class="small text-muted"></div>
                </div>
            </div></div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = new bootstrap.Modal(document.getElementById('bulkUploadProgressModal'));
    modal.show();

    try {
        const year = document.getElementById('bulkAddYear').value;
        const studentClass = document.getElementById('bulkAddClass').value;
        const classType = document.getElementById('bulkAddClassType').value;
        const excelFile = document.getElementById('bulkAddExcelFile').files[0];
        if (!year || !studentClass || !classType || !excelFile) throw new Error('Please fill all required fields');

        const data = await readExcelFile(excelFile);
        if (!data.length) throw new Error('Excel file is empty or not formatted correctly');

        let successCount = 0, errorCount = 0;
        const errors = [];
        const adminEmail = auth.currentUser.email;
        const adminPassword = await promptAdminPassword();

        for (let i = 0; i < data.length; i++) {
            const row = data[i];
            const rowNum = i + 1;

            try {
                if (!row.name || !row.email || !row.nic) throw new Error('Missing fields');
                if ((classType === 'Paper Class' || classType === 'Revision') && !row.studentId) {
                    throw new Error('Student ID required for this class type');
                }

                const [nicExists, emailExists] = await Promise.all([
                    checkNICExists(row.nic),
                    checkEmailExists(row.email)
                ]);
                if (nicExists) throw new Error('NIC already registered');
                if (emailExists) throw new Error('Email already registered');

                await withAuthStateBlocked(async () => {
                    const userCredential = await auth.createUserWithEmailAndPassword(row.email, row.nic);
                    const user = userCredential.user;

                    const userData = {
                        name: row.name,
                        email: row.email,
                        nic: row.nic,
                        studentId: row.studentId || '',
                        class: studentClass,
                        registeredYear: year,
                        classTypes: [classType],
                        isActive: true,
                        verified: true,
                        addedByAdmin: true,
                        isPaid: false, // Default payment status
                        lastPaymentDate: null, // No payment initially
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    await database.ref('users/' + user.uid).set(userData);
                    await database.ref('userAuthMap/' + row.nic).set(user.uid);

                    await auth.signOut();
                    await auth.signInWithEmailAndPassword(adminEmail, adminPassword);
                    successCount++;
                });

                // Update progress
                const progress = Math.floor(((i + 1) / data.length) * 100);
                document.getElementById('bulkUploadProgressBar').style.width = `${progress}%`;
                document.getElementById('bulkUploadStatus').textContent = `Processed ${i + 1} of ${data.length}`;
                document.getElementById('bulkUploadDetails').textContent = `Success: ${successCount} | Errors: ${errorCount}`;

            } catch (err) {
                errorCount++;
                errors.push(`Row ${rowNum}: ${err.message}`);
                console.error(`Error in row ${rowNum}:`, err);
            }

            await new Promise(r => setTimeout(r, 300)); // delay per user
        }

        document.getElementById('bulkUploadProgressBar').style.width = `100%`;
        document.getElementById('bulkUploadStatus').textContent = `Completed`;
        document.getElementById('bulkUploadDetails').textContent = `Success: ${successCount} | Errors: ${errorCount}`;

        let message = `Bulk import done.\nSuccess: ${successCount}\nErrors: ${errorCount}`;
        if (errors.length) {
            message += '\n\nFirst 5 errors:\n' + errors.slice(0, 5).join('\n');
        }
        alert(message);

        if (successCount > 0) {
            form.reset();
            loadAllUsers();
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        setTimeout(() => {
            const modalElement = document.getElementById('bulkUploadProgressModal');
            if (modalElement) {
                bootstrap.Modal.getInstance(modalElement)?.hide();
                modalElement.remove();
            }
        }, 2000);
    }
});

// Helper function to refresh Firebase token
async function refreshFirebaseToken() {
    try {
        const user = auth.currentUser;
        if (user) {
            await user.getIdToken(true); // Force token refresh
        }
    } catch (error) {
        console.error('Error refreshing token:', error);
        // Don't throw error here as it might not be critical
    }
}

// Load pending accounts (with student IDs)
async function loadPendingAccounts() {
    const tbody = document.getElementById('pendingAccountsList');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border"></div></td></tr>';
    
    try {
        // Verify admin status first
        await verifyAdmin();
        
        // Get ALL users first (since we can't do complex queries with Firebase rules)
        const snapshot = await database.ref('users').once('value');
        const users = snapshot.val() || {};
        
        tbody.innerHTML = '';
        
        // Filter for pending accounts
        const pendingUsers = Object.entries(users)
            .filter(([uid, user]) => {
                // Check if account is pending (using whatever field indicates pending status)
                // This could be: verified === false, isApproved === false, status === 'pending', etc.
                // Adjust based on your actual database structure
                return (
                    (user.verified === false || !user.verified) && // Either false or undefined
                    (user.studentId || user.nic) // Has some identifier
                );
            })
            .map(([uid, user]) => ({ uid, ...user }));
        
        if (pendingUsers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No pending accounts found</td></tr>';
            return;
        }
        
        // Display pending users
        pendingUsers.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name || 'N/A'}</td>
                <td>${user.studentId || user.nic || '-'}</td>
                <td>${user.class || '-'}</td>
                <td>${user.classTypes ? user.classTypes.join(', ') : '-'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>${user.nic || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-success approve-account" data-uid="${user.uid}">
                        <i class="bi bi-check-circle"></i> Approve
                    </button>
                    <button class="btn btn-sm btn-danger reject-account" data-uid="${user.uid}">
                        <i class="bi bi-x-circle"></i> Reject
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listeners
            row.querySelector('.approve-account').addEventListener('click', () => approveAccount(user.uid));
            row.querySelector('.reject-account').addEventListener('click', () => rejectAccount(user.uid));
        });
        
    } catch (error) {
        console.error('Error loading pending accounts:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    Error: ${error.message || 'Failed to load pending accounts'}
                </td>
            </tr>
        `;
    }
}

// Approve account
async function approveAccount(uid) {
    if (!confirm('Are you sure you want to approve this account?')) return;
    
    try {
        await database.ref(`users/${uid}`).update({
            verified: true,
            isActive: true
        });
        
        alert('Account approved successfully');
        loadPendingAccounts();
    } catch (error) {
        console.error('Error approving account:', error);
        alert('Error approving account: ' + error.message);
    }
}

// Reject account
async function rejectAccount(uid) {
    if (!confirm('Are you sure you want to reject this account? This cannot be undone.')) return;
    
    try {
        // First get the user's auth data
        const userSnapshot = await database.ref(`users/${uid}`).once('value');
        const user = userSnapshot.val();
        
        if (!user) {
            alert('User not found');
            return;
        }

        // Delete from Realtime Database first
        await database.ref(`users/${uid}`).remove();
        await database.ref(`userAuthMap/${user.nic}`).remove();
        
        // Then delete the auth account (using client SDK method)
        const currentUser = auth.currentUser;
        
        if (currentUser && currentUser.uid === uid) {
            // If admin is trying to delete themselves
            await auth.signOut();
            await currentUser.delete();
        } else {
            // For other users, you'll need to implement Option 2 (Cloud Function)
            alert('User account deletion requires a server-side function. User data has been removed but auth account remains.');
            // Alternatively, you could implement Option 2 below
        }
        
        alert('Account rejected successfully');
        loadPendingAccounts();
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert(`Error rejecting account: ${error.message}`);
    }
}

// Load all users
async function loadAllUsers(searchTerm = '') {
    const tbody = document.getElementById('usersList');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border"></div></td></tr>';
    
    try {
        const snapshot = await database.ref('users').once('value');
        const users = snapshot.val() || {};
        
        tbody.innerHTML = '';
        
        const usersArray = Object.entries(users).map(([uid, user]) => ({ 
            uid, 
            ...user,
            // Ensure default values
            isActive: user.hasOwnProperty('isActive') ? user.isActive : true,
            verified: user.hasOwnProperty('verified') ? user.verified : false
        }));
        
        // Filter if search term provided
        const filteredUsers = searchTerm 
            ? usersArray.filter(user => 
                (user.studentId && user.studentId.toLowerCase().includes(searchTerm.toLowerCase())) || 
                (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase())))
            : usersArray;
        
        if (filteredUsers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
            return;
        }
        
        filteredUsers.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name || 'N/A'}</td>
                <td>${user.studentId || '-'}</td>
                <td>${user.class || '-'}</td>
                <td>${user.classTypes ? user.classTypes.join(', ') : '-'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>
                    <span class="badge ${user.isActive ? 'bg-success' : 'bg-secondary'}">
                        ${user.isActive ? 'Active' : 'Inactive'}
                    </span>
                    ${user.verified ? '' : '<span class="badge bg-warning ms-1">Pending</span>'}
                    <span class="badge ${user.isPaid ? 'bg-success' : 'bg-danger'} ms-1">
                        ${user.isPaid ? 'Paid' : 'Unpaid'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary edit-user" data-uid="${user.uid}">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger delete-user" data-uid="${user.uid}">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listeners
            row.querySelector('.edit-user').addEventListener('click', () => showEditUserModal(user));
            row.querySelector('.delete-user').addEventListener('click', () => deleteUser(user.uid));
        });
        
    } catch (error) {
        console.error('Error loading users:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading users</td></tr>';
    }
}

// Search users
document.getElementById('searchUserBtn').addEventListener('click', () => {
    const searchTerm = document.getElementById('userSearch').value.trim();
    loadAllUsers(searchTerm);
});

// Show edit modal with user data
async function showEditUserModal(user) {
    try {
        // Load user data
        const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
        const userData = userSnapshot.val();
        
        if (!userData) {
            throw new Error('User data not found');
        }
        
        // Populate form
        document.getElementById('editUserId').value = user.uid;
        document.getElementById('editUserName').value = userData.name || '';
        document.getElementById('editUserEmail').value = userData.email || '';
        document.getElementById('editUserNIC').value = userData.nic || '';
        document.getElementById('editUserStudentId').value = userData.studentId || '';
        document.getElementById('editUserClass').value = userData.class || '';
        document.getElementById('editUserDistrict').value = userData.district || '';
        document.getElementById('editUserSchool').value = userData.school || '';
        document.getElementById('editUserPhone').value = userData.phone || '';
        document.getElementById('editUserYear').value = userData.registeredYear || '';
        
        // Set year value - FIX: Use registeredYear instead of year
        const yearSelect = document.getElementById('editUserYear');
        if (userData.registeredYear) {
            yearSelect.value = userData.registeredYear;
        } else if (userData.year) { // Fallback to year if registeredYear doesn't exist
            yearSelect.value = userData.year;
        } else {
            yearSelect.value = ''; // Default to empty if no year found
        }
        
        // Set class types
        if (userData.classTypes) {
            document.getElementById('editUserTheory').checked = userData.classTypes.includes('Theory');
            document.getElementById('editUserPaperClass').checked = userData.classTypes.includes('Paper Class');
            document.getElementById('editUserRevision').checked = userData.classTypes.includes('Revision');
        }
        
        // Set status toggles
        document.getElementById('editUserActive').checked = userData.isActive !== false;
        document.getElementById('editUserVerified').checked = userData.verified === true;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading user for editing:', error);
        alert(`Error: ${error.message}`);
    }
}

// Save user changes
document.getElementById('saveUserChanges').addEventListener('click', async function() {
    const form = document.getElementById('editUserForm');
    const saveBtn = this;
    const originalBtnText = saveBtn.innerHTML;
    
    // Disable button during save
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    try {
        const uid = document.getElementById('editUserId').value;
        const updates = {
            name: document.getElementById('editUserName').value.trim(),
            email: document.getElementById('editUserEmail').value.trim(),
            nic: document.getElementById('editUserNIC').value.trim(),
            studentId: document.getElementById('editUserStudentId').value.trim(),
            class: document.getElementById('editUserClass').value,
            district: document.getElementById('editUserDistrict').value,
            registeredYear: document.getElementById('editUserYear').value,
            school: document.getElementById('editUserSchool').value.trim(),
            phone: document.getElementById('editUserPhone').value.trim(),
            isActive: document.getElementById('editUserActive').checked,
            verified: document.getElementById('editUserVerified').checked,
            classTypes: []
        };
        
        // Get selected class types
        if (document.getElementById('editUserTheory').checked) {
            updates.classTypes.push('Theory');
        }
        if (document.getElementById('editUserPaperClass').checked) {
            updates.classTypes.push('Paper Class');
        }
        if (document.getElementById('editUserRevision').checked) {
            updates.classTypes.push('Revision');
        }
        
        // Validate required fields
        if (!updates.name || !updates.email || !updates.nic || !updates.class || !updates.district || !updates.registeredYear || !updates.phone) {
            throw new Error('Please fill all required fields');
        }
        
        // Save updates
        await database.ref(`users/${uid}`).update(updates);
        
        // Close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        loadAllUsers();
        
        alert('User updated successfully');
        
    } catch (error) {
        console.error('Error saving user changes:', error);
        alert(`Error: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnText;
    }
});

// Delete user
async function deleteUser(uid) {
    if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) return;
    
    try {
        // First get user data
        const userSnapshot = await database.ref(`users/${uid}`).once('value');
        const user = userSnapshot.val();
        
        if (!user) {
            alert('User not found');
            return;
        }
        
        // Delete from Realtime Database
        await database.ref(`users/${uid}`).remove();
        
        // If userAuthMap exists, delete that too
        if (user.nic) {
            await database.ref(`userAuthMap/${user.nic}`).remove();
        }
        
        // Note: Can't delete auth user from client-side - need a Cloud Function
        alert('User data deleted. Note: Auth account remains (requires server-side deletion).');
        loadAllUsers();
        
    } catch (error) {
        console.error('Error deleting user:', error);
        alert(`Error deleting user: ${error.message}`);
    }
}

// Helper function to check if NIC exists
async function checkNICExists(nic) {
    const snapshot = await database.ref('userAuthMap/' + nic).once('value');
    return snapshot.exists();
}

// Helper function to check if email exists
async function checkEmailExists(email) {
    try {
        const methods = await auth.fetchSignInMethodsForEmail(email);
        return methods && methods.length > 0;
    } catch (error) {
        if (error.code === 'auth/invalid-email') return false;
        throw error;
    }
}

// Helper function to verify admin status
async function verifyAdmin() {
    const user = auth.currentUser;
    if (!user) {
        throw new Error('User not authenticated');
    }
    
    const adminSnapshot = await database.ref(`admins/${user.uid}`).once('value');
    if (!adminSnapshot.exists()) {
        throw new Error('Unauthorized: User is not an admin');
    }
    return true;
}

// Improved Excel file reader function
async function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get the first worksheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Convert to JSON using the first row as headers
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1, // Use first row as headers
                    defval: '', // Default empty string for empty cells
                    raw: false // Get formatted strings
                });

                // Convert array of arrays to array of objects
                if (jsonData.length < 2) {
                    resolve([]);
                    return;
                }

                const headers = jsonData[0].map(h => h.toString().toLowerCase().trim());
                const result = [];

                for (let i = 1; i < jsonData.length; i++) {
                    const row = {};
                    for (let j = 0; j < headers.length; j++) {
                        if (headers[j]) { // Skip empty headers
                            row[headers[j]] = jsonData[i][j] ? jsonData[i][j].toString().trim() : '';
                        }
                    }
                    if (Object.values(row).some(val => val)) { // Skip empty rows
                        result.push(row);
                    }
                }

                resolve(result);
            } catch (error) {
                reject(error);
            }
        };

        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

// Add payment records modal
document.getElementById('addPaymentsBtn').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('addPaymentsModal'));
    modal.show();
    
    // Set default month/year to current
    const now = new Date();
    document.getElementById('paymentMonth').value = now.getMonth() + 1;
    document.getElementById('paymentYear').value = now.getFullYear();
});

// Handle Excel file upload for payments
document.getElementById('paymentExcelFile').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
        const data = await readExcelFile(file);
        if (!data.length) throw new Error('Excel file is empty');
        
        // Extract student IDs from first column
        const studentIds = data.map(row => {
            const firstKey = Object.keys(row)[0];
            return row[firstKey].toString().trim();
        }).filter(id => id);
        
        if (!studentIds.length) throw new Error('No valid student IDs found');
        
        // Show preview
        const previewBody = document.getElementById('paymentPreviewBody');
        previewBody.innerHTML = '';
        
        studentIds.slice(0, 5).forEach(id => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${id}</td><td><span class="badge bg-info">Pending</span></td>`;
            previewBody.appendChild(row);
        });
        
        if (studentIds.length > 5) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="2" class="text-center">+ ${studentIds.length - 5} more records</td>`;
            previewBody.appendChild(row);
        }
        
        document.getElementById('paymentPreview').style.display = 'block';
        document.getElementById('confirmPaymentsBtn').disabled = false;
        document.getElementById('confirmPaymentsBtn').dataset.studentIds = JSON.stringify(studentIds);
        
    } catch (error) {
        console.error('Error processing payment file:', error);
        alert(`Error: ${error.message}`);
        document.getElementById('paymentPreview').style.display = 'none';
        document.getElementById('confirmPaymentsBtn').disabled = true;
    }
});

// Confirm payment records
document.getElementById('confirmPaymentsBtn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
    
    try {
        const month = document.getElementById('paymentMonth').value;
        const year = document.getElementById('paymentYear').value;
        const studentIds = JSON.parse(btn.dataset.studentIds);
        
        if (!month || !year) throw new Error('Please select month and year');
        if (!studentIds || !studentIds.length) throw new Error('No student IDs to process');
        
        // Get all users
        const usersSnapshot = await database.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        // Find matching users
        const updates = {};
        const paymentDate = new Date(year, month - 1, 10).getTime(); // 10th of the month
        
        Object.entries(users).forEach(([uid, user]) => {
            if (studentIds.includes(user.studentId)) {
                updates[`users/${uid}/payments/${year}-${month}`] = {
                    paid: true,
                    paymentDate: firebase.database.ServerValue.TIMESTAMP,
                    recordedBy: auth.currentUser.uid
                };
                updates[`users/${uid}/isPaid`] = true;
                updates[`users/${uid}/lastPaymentDate`] = paymentDate;
            }
        });
        
        if (Object.keys(updates).length === 0) {
            throw new Error('No matching student IDs found in the system');
        }
        
        // Apply updates
        await database.ref().update(updates);
        
        alert(`Successfully updated ${Object.keys(updates).length / 3} payment records`);
        bootstrap.Modal.getInstance(document.getElementById('addPaymentsModal')).hide();
        loadPaymentRecords();
        
    } catch (error) {
        console.error('Error confirming payments:', error);
        alert(`Error: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Load payment records
async function loadPaymentRecords(month = '', year = '', status = '') {
    const tbody = document.getElementById('paymentsList');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border"></div></td></tr>';
    
    try {
        const usersSnapshot = await database.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        tbody.innerHTML = '';
        
        let records = Object.entries(users).map(([uid, user]) => {
            const lastPayment = user.lastPaymentDate ? new Date(user.lastPaymentDate) : null;
            const isPaid = user.isPaid || false;
            
            return {
                uid,
                studentId: user.studentId || '-',
                name: user.name || 'N/A',
                class: user.class || '-',
                isPaid,
                lastPaymentDate: lastPayment,
                lastPaymentMonth: lastPayment ? lastPayment.getMonth() + 1 : null,
                lastPaymentYear: lastPayment ? lastPayment.getFullYear() : null
            };
        });
        
        // Apply filters
        if (month) records = records.filter(r => r.lastPaymentMonth == month);
        if (year) records = records.filter(r => r.lastPaymentYear == year);
        if (status === 'paid') records = records.filter(r => r.isPaid);
        if (status === 'unpaid') records = records.filter(r => !r.isPaid);
        
        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No payment records found</td></tr>';
            return;
        }
        
        // Sort by payment status (unpaid first) then by name
        records.sort((a, b) => {
            if (a.isPaid !== b.isPaid) return a.isPaid ? 1 : -1;
            return a.name.localeCompare(b.name);
        });
        
        // Display records
        records.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${record.studentId}</td>
                <td>${record.name}</td>
                <td>${record.class}</td>
                <td>
                    <span class="badge ${record.isPaid ? 'bg-success' : 'bg-danger'}">
                        ${record.isPaid ? 'Paid' : 'Unpaid'}
                    </span>
                </td>
                <td>
                    ${record.lastPaymentDate ? 
                        record.lastPaymentDate.toLocaleDateString() : 
                        'Never'}
                </td>
                <td>
                    <button class="btn btn-sm ${record.isPaid ? 'btn-warning' : 'btn-success'} toggle-payment" 
                            data-uid="${record.uid}" data-paid="${record.isPaid}">
                        ${record.isPaid ? 'Mark Unpaid' : 'Mark Paid'}
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listener to toggle button
            row.querySelector('.toggle-payment').addEventListener('click', () => 
                togglePaymentStatus(record.uid, !record.isPaid));
        });
        
    } catch (error) {
        console.error('Error loading payment records:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading records</td></tr>';
    }
}

// Toggle payment status
async function togglePaymentStatus(uid, isPaid) {
    if (!confirm(`Are you sure you want to mark this student as ${isPaid ? 'paid' : 'unpaid'}?`)) return;
    
    try {
        const now = new Date();
        const updates = {
            [`users/${uid}/isPaid`]: isPaid,
            [`users/${uid}/lastPaymentDate`]: isPaid ? now.getTime() : null
        };
        
        await database.ref().update(updates);
        loadPaymentRecords(
            document.getElementById('paymentMonthFilter').value,
            document.getElementById('paymentYearFilter').value,
            document.getElementById('paymentStatusFilter').value
        );
        
    } catch (error) {
        console.error('Error toggling payment status:', error);
        alert('Error updating payment status');
    }
}

// Mark all students as paid
document.getElementById('markAllPaidBtn').addEventListener('click', async function() {
    if (!confirm('Are you sure you want to mark ALL students as paid for this month?')) return;
    
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
    
    try {
        const now = new Date();
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        const paymentDate = new Date(year, month - 1, 10).getTime();
        
        const usersSnapshot = await database.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        const updates = {};
        
        Object.keys(users).forEach(uid => {
            updates[`users/${uid}/payments/${year}-${month}`] = {
                paid: true,
                paymentDate: firebase.database.ServerValue.TIMESTAMP,
                recordedBy: auth.currentUser.uid
            };
            updates[`users/${uid}/isPaid`] = true;
            updates[`users/${uid}/lastPaymentDate`] = paymentDate;
        });
        
        await database.ref().update(updates);
        alert(`Successfully marked ${Object.keys(users).length} students as paid`);
        loadPaymentRecords();
        
    } catch (error) {
        console.error('Error marking all as paid:', error);
        alert('Error marking all students as paid');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Payment filters
document.getElementById('paymentMonthFilter').addEventListener('change', () => loadPaymentRecords(
    document.getElementById('paymentMonthFilter').value,
    document.getElementById('paymentYearFilter').value,
    document.getElementById('paymentStatusFilter').value
));

document.getElementById('paymentYearFilter').addEventListener('change', () => loadPaymentRecords(
    document.getElementById('paymentMonthFilter').value,
    document.getElementById('paymentYearFilter').value,
    document.getElementById('paymentStatusFilter').value
));

document.getElementById('paymentStatusFilter').addEventListener('change', () => loadPaymentRecords(
    document.getElementById('paymentMonthFilter').value,
    document.getElementById('paymentYearFilter').value,
    document.getElementById('paymentStatusFilter').value
));

function checkPaymentStatuses() {
    const now = new Date();
    if (now.getDate() > 10) {
        // After 10th of the month, check for unpaid students
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        
        database.ref('users').once('value').then(snapshot => {
            const users = snapshot.val() || {};
            const updates = {};
            
            Object.entries(users).forEach(([uid, user]) => {
                const lastPayment = user.lastPaymentDate ? new Date(user.lastPaymentDate) : null;
                const isCurrentMonth = lastPayment && 
                    lastPayment.getMonth() + 1 === month && 
                    lastPayment.getFullYear() === year;
                
                if (!isCurrentMonth && user.isPaid) {
                    updates[`users/${uid}/isPaid`] = false;
                }
            });
            
            if (Object.keys(updates).length > 0) {
                database.ref().update(updates);
            }
        });
    }
}

function setupPaymentStatusChecks() {
    // Run immediately on load
    checkPaymentStatuses();
    
    // Then run every 24 hours
    setInterval(checkPaymentStatuses, 24 * 60 * 60 * 1000);
    
    // Also run at midnight every day for extra reliability
    const now = new Date();
    const midnight = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate() + 1, // Next day
        0, 0, 0 // Midnight
    );
    const timeToMidnight = midnight - now;
    
    setTimeout(() => {
        checkPaymentStatuses();
        // Then run every 24 hours after that
        setInterval(checkPaymentStatuses, 24 * 60 * 60 * 1000);
    }, timeToMidnight);
}

setupPaymentStatusChecks();

document.addEventListener('DOMContentLoaded', function() {
    
    // Initialize payment status checks
    if (auth.currentUser) {
        checkPaymentStatuses();
        setupPaymentStatusChecks();
    }
    
    // Also check when switching to the payments tab
    document.getElementById('monthlyPaymentsTab').addEventListener('click', function() {
        checkPaymentStatuses();
    });
});

//==================================================
//Online Papers
//==================================================

// Paper templates
const paperTemplates = {
    template15: {
        name: "15 MCQ Template",
        count: 15,
        questions: Array.from({length: 15}, (_, i) => ({
            number: i + 1,
            marks: 1,
            answer: "1" // Default answer
        }))
    },
    template25: {
        name: "25 MCQ Template",
        count: 25,
        questions: Array.from({length: 25}, (_, i) => ({
            number: i + 1,
            marks: 1,
            answer: "1" // Default answer
        }))
    },
    template50: {
        name: "50 MCQ Template",
        count: 50,
        questions: Array.from({length: 50}, (_, i) => ({
            number: i + 1,
            marks: 1,
            answer: "1" // Default answer
        }))
    }
};

// Apply template
function applyTemplate(template) {
    const container = document.getElementById('questionsContainer');
    container.innerHTML = '';
    
    template.questions.forEach((q, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item mb-3 p-3 border rounded';
        questionDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Question ${q.number}</label>
                    <input type="number" class="form-control question-number" value="${q.number}" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Marks</label>
                    <input type="number" class="form-control question-marks" value="${q.marks}" min="1" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Correct Answer</label>
                    <select class="form-select question-answer" required>
                        <option value="1" ${q.answer === "1" ? "selected" : ""}>1</option>
                        <option value="2" ${q.answer === "2" ? "selected" : ""}>2</option>
                        <option value="3" ${q.answer === "3" ? "selected" : ""}>3</option>
                        <option value="4" ${q.answer === "4" ? "selected" : ""}>4</option>
                        <option value="5" ${q.answer === "5" ? "selected" : ""}>5</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-question">
                <i class="bi bi-trash"></i> Remove
            </button>
        `;
        container.appendChild(questionDiv);
    });
    
    // Update question count
    questionCount = template.count;
}

document.addEventListener("DOMContentLoaded", () => {

// Template buttons
document.getElementById('template15Btn').addEventListener('click', (e) => {
    e.preventDefault();
    applyTemplate(paperTemplates.template15);
});

document.getElementById('template25Btn').addEventListener('click', (e) => {
    e.preventDefault();
    applyTemplate(paperTemplates.template25);
});

document.getElementById('template50Btn').addEventListener('click', (e) => {
    e.preventDefault();
    applyTemplate(paperTemplates.template50);
});
document.getElementById('useTemplateBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyTemplate(paperTemplates.template15); // default to 15 MCQ
});

});

// Paper creation functionality
let questionCount = 1;
let isProcessingForm = false;

// Add question button
document.getElementById('addQuestionBtn').addEventListener('click', () => {
    questionCount++;
    const container = document.getElementById('questionsContainer');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item mb-3 p-3 border rounded';
    questionDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Question ${questionCount}</label>
                <input type="number" class="form-control question-number" value="${questionCount}" readonly>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Marks</label>
                <input type="number" class="form-control question-marks" placeholder="Marks" min="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Correct Answer</label>
                <select class="form-select question-answer" required>
                    <option value="">Select</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-question">
            <i class="bi bi-trash"></i> Remove
        </button>
    `;
    container.appendChild(questionDiv);
});

// Remove question event delegation
document.getElementById('questionsContainer').addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-question') || e.target.closest('.remove-question')) {
        e.target.closest('.question-item').remove();
        questionCount--;
        const questions = document.querySelectorAll('.question-item');
        questions.forEach((q, index) => {
            q.querySelector('.form-label').textContent = `Question ${index + 1}`;
        });
    }
});

document.getElementById('createPaperForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isProcessingForm) return;
    isProcessingForm = true;
    
    try {
        const createPaperBtn = document.getElementById('createPaperBtn');
        createPaperBtn.disabled = true;
        createPaperBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

        const title = document.getElementById('paperTitle').value.trim();
        const year = document.getElementById('paperYear').value.trim();
        const paperNumber = document.getElementById('paperNumber').value.trim();
        const subject = document.getElementById('paperSubject').value.trim();
        const medium = document.getElementById('paperMedium').value;
        const openTime = document.getElementById('openTime').value;
        const closeTime = document.getElementById('closeTime').value;
        const pdfFileSinhala = document.getElementById('paperPdfSinhala').files[0];
        const pdfFileEnglish = document.getElementById('paperPdfEnglish').files[0];
        const answerKeyFile = document.getElementById('answerKeyPdf').files[0];
        
        // Validate inputs
        if (!title || !year || !paperNumber || !subject || !medium || !openTime || !closeTime) {
            throw new Error('Please fill in all required fields');
        }

        // Get questions with answers
        const questions = {};
        const questionItems = document.querySelectorAll('.question-item');
        
        questionItems.forEach((item, index) => {
            const number = item.querySelector('.question-number').value.trim();
            const marks = parseInt(item.querySelector('.question-marks').value) || 0;
            const answer = item.querySelector('.question-answer').value;
            
            if (number && !isNaN(marks) && answer) {
                questions[number] = {
                    questionText: `Question ${number}`,
                    marks: marks,
                    answer: answer,
                    options: ["Option 1", "Option 2", "Option 3", "Option 4", "Option 5"] // Placeholder
                };
            }
        });
        
        if (Object.keys(questions).length === 0) {
            throw new Error('Please add at least one valid question');
        }
        
        if (!pdfFileSinhala || !pdfFileEnglish || !answerKeyFile) {
            throw new Error('Please upload all required PDF files');
        }

        // Date validation
        const openDate = new Date(openTime);
        const closeDate = new Date(closeTime);
        const now = new Date();
        
        if (openDate < now) {
            throw new Error('Open time cannot be in the past');
        }
        
        if (closeDate <= openDate) {
            throw new Error('Close time must be after open time');
        }
        
        if ((closeDate - openDate) < (30 * 60 * 1000)) {
            throw new Error('The paper should be available for at least 30 minutes');
        }
        
        // Generate paper ID
        const paperId = `${subject.toLowerCase()}-${year}-${paperNumber}-${Date.now()}`;
        
        // Upload files to storage
        const storageRef = storage.ref();
        const uploadTasks = [
            storageRef.child(`papers/${paperId}/paper-sinhala.pdf`).put(pdfFileSinhala),
            storageRef.child(`papers/${paperId}/paper-english.pdf`).put(pdfFileEnglish),
            storageRef.child(`papers/${paperId}/answers.pdf`).put(answerKeyFile)
        ];
        
        await Promise.all(uploadTasks);
        
        // Get download URLs
        const [sinhalaUrl, englishUrl, answerKeyUrl] = await Promise.all([
            storageRef.child(`papers/${paperId}/paper-sinhala.pdf`).getDownloadURL(),
            storageRef.child(`papers/${paperId}/paper-english.pdf`).getDownloadURL(),
            storageRef.child(`papers/${paperId}/answers.pdf`).getDownloadURL()
        ]);

        // Calculate total marks
        const totalMarks = Object.values(questions).reduce((sum, q) => sum + q.marks, 0);

        // Save paper data
        await database.ref(`papers/${paperId}`).set({
            title,
            year,
            paperNumber,
            subject,
            medium,
            openTime: new Date(openTime).toISOString(),
            closeTime: new Date(closeTime).toISOString(),
            pdfUrlSinhala: sinhalaUrl,
            pdfUrlEnglish: englishUrl,
            answerKeyUrl,
            questions,
            totalMarks,
            type: "online",
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        alert('Paper created successfully!');
        document.getElementById('createPaperForm').reset();
        
        // Reset questions container
        document.getElementById('questionsContainer').innerHTML = '';
        questionCount = 0;

    } catch (error) {
        console.error('Error creating paper:', error);
        alert(`Error: ${error.message}`);
    } finally {
        isProcessingForm = false;
        const createPaperBtn = document.getElementById('createPaperBtn');
        createPaperBtn.disabled = false;
        createPaperBtn.textContent = 'Create Paper';
    }
});

// Load papers for viewing
async function loadPapers() {
    try {
        const yearFilter = document.getElementById('paperYearFilter').value;
        const snapshot = await database.ref('papers').once('value');
        const papers = snapshot.val() || {};
        const now = new Date().getTime();

        // Clear containers properly
        const clearContainer = (id) => {
            const container = document.getElementById(id);
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        };
        
        clearContainer('activePapersContainer');
        clearContainer('upcomingPapersContainer');
        clearContainer('closedPapersContainer');

        let activeCount = 0;
        let upcomingCount = 0;
        let closedCount = 0;

        // Process each paper
        for (const [id, paper] of Object.entries(papers)) {
            // Apply year filter if set
            if (yearFilter && paper.year !== yearFilter) continue;

            const openTime = new Date(paper.openTime).getTime();
            const closeTime = new Date(paper.closeTime).getTime();
            
            // Create paper card
            const card = createPaperCard(id, paper);

            // Categorize paper
            if (now >= openTime && now <= closeTime) {
                document.getElementById('activePapersContainer').appendChild(card);
                activeCount++;
            } else if (now < openTime) {
                document.getElementById('upcomingPapersContainer').appendChild(card);
                upcomingCount++;
            } else {
                document.getElementById('closedPapersContainer').appendChild(card);
                closedCount++;
            }
        }

        // Update tab badges
        updateTabBadges(activeCount, upcomingCount, closedCount);

        // Show empty state if no papers
        showEmptyState('activePapersContainer', activeCount);
        showEmptyState('upcomingPapersContainer', upcomingCount);
        showEmptyState('closedPapersContainer', closedCount);

    } catch (error) {
        console.error('Error loading papers:', error);
        // Show error in all containers
        const errorHtml = '<div class="col-12 text-center text-danger py-5">Error loading papers</div>';
        document.getElementById('activePapersContainer').innerHTML = errorHtml;
        document.getElementById('upcomingPapersContainer').innerHTML = errorHtml;
        document.getElementById('closedPapersContainer').innerHTML = errorHtml;
    }
}

// Helper function to create paper card for View Papers section
function createPaperCard(id, paper) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 paper-card';
    card.setAttribute('data-paper-id', id);
    
    const now = new Date().getTime();
    const openTime = new Date(paper.openTime).getTime();
    const closeTime = new Date(paper.closeTime).getTime();
    const isActive = now >= openTime && now <= closeTime;
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${paper.title}</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Year: ${paper.year}</span>
                    <span class="text-muted">Paper: ${paper.paperNumber}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-${isActive ? 'success' : 'secondary'}">
                        ${isActive ? 'Active' : (now < openTime ? 'Upcoming' : 'Closed')}
                    </span>
                    <small class="text-muted">
                        ${new Date(paper.createdAt || paper.openTime).toLocaleDateString()}
                    </small>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Subject: ${paper.subject}</span>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Medium: ${paper.medium}</span>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Total Marks: ${paper.totalMarks}</span>
                </div>
            </div>
            <div class="card-footer bg-transparent d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary view-paper-btn">
                    <i class="bi bi-eye"></i> View
                </button>
                <button class="btn btn-sm btn-outline-danger delete-paper-btn">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
    
    // Add event listeners
    card.querySelector('.view-paper-btn').addEventListener('click', () => {
        viewPaperDetails(id);
    });
    
    card.querySelector('.delete-paper-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        deletePaper(id, paper.title);
    });
    
    return card;
}

async function deletePaper(paperId, paperTitle) {
    if (!confirm(`Are you sure you want to delete the paper "${paperTitle}"? This action cannot be undone and will also delete all associated submissions.`)) {
        return;
    }

    try {
        // Show loading state
        const deleteBtn = document.querySelector(`.paper-card[data-paper-id="${paperId}"] .delete-paper-btn`);
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        deleteBtn.disabled = true;

        // Delete paper data
        await database.ref(`papers/${paperId}`).remove();

        // Delete submissions (if any)
        await database.ref(`submissions/${paperId}`).remove();

        // Delete storage files if they exist
        const storageRef = storage.ref();
        const filesToDelete = [
            `papers/${paperId}/paper-sinhala.pdf`,
            `papers/${paperId}/paper-english.pdf`,
            `papers/${paperId}/answers.pdf`
        ];

        await Promise.all(filesToDelete.map(async (filePath) => {
            try {
                await storageRef.child(filePath).delete();
            } catch (error) {
                if (error.code !== 'storage/object-not-found') {
                    console.error(`Error deleting file ${filePath}:`, error);
                }
            }
        }));

        // Remove the card from the UI
        const card = document.querySelector(`.paper-card[data-paper-id="${paperId}"]`);
        if (card) {
            card.remove();
        }

        // Show success message
        alert(`Paper "${paperTitle}" deleted successfully.`);
        
        // Reload the counts in the dashboard
        initDashboard();

    } catch (error) {
        console.error('Error deleting paper:', error);
        alert(`Error deleting paper: ${error.message}`);
    }
}

// Update tab badges with counts
function updateTabBadges(active, upcoming, closed) {
    document.getElementById('active-tab').innerHTML = `Active ${active > 0 ? `<span class="badge bg-primary ms-2">${active}</span>` : ''}`;
    document.getElementById('upcoming-tab').innerHTML = `Upcoming ${upcoming > 0 ? `<span class="badge bg-primary ms-2">${upcoming}</span>` : ''}`;
    document.getElementById('closed-tab').innerHTML = `Closed ${closed > 0 ? `<span class="badge bg-primary ms-2">${closed}</span>` : ''}`;
}

// Show empty state message
function showEmptyState(containerId, count) {
    if (count === 0) {
        document.getElementById(containerId).innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                <p class="text-muted">No papers found</p>
            </div>
        `;
    }
}

// Add year filter event listener
document.getElementById('paperYearFilter').addEventListener('change', loadPapers);

// View paper details
async function viewPaperDetails(paperId) {
    try {
        const [paperSnapshot, isAvailable] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            checkPaperAvailability(paperId)
        ]);
        
        const paper = paperSnapshot.val();
        if (!paper) throw new Error('Paper not found');

        const openTime = new Date(paper.openTime);
        const closeTime = new Date(paper.closeTime);
        const now = new Date();
        let status = now < openTime ? 'Upcoming' : now > closeTime ? 'Closed' : 'Active';

        let html = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${paper.title}</h4>
                    <p class="mb-1"><strong>Status:</strong> 
                        <span class="badge ${status === 'Active' ? 'bg-success' : status === 'Upcoming' ? 'bg-warning' : 'bg-secondary'}">
                            ${status}
                        </span>
                    </p>
                    <p class="mb-1"><strong>Available:</strong> ${openTime.toLocaleString()} to ${closeTime.toLocaleString()}</p>
        `;

        if (status !== 'Active') {
            html += `
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> This paper is not currently available for access.
                    ${status === 'Upcoming' ? 'It will become available at the specified open time.' : 'The submission period has ended.'}
                </div>
            `;
        }

        html += `
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Time Remaining</h6>
                            <div id="timeRemaining"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Only show access buttons if paper is active
        if (status === 'Active') {
            html += `
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Paper PDF (Sinhala)</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.pdfUrlSinhala}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Sinhala Paper
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Paper PDF (English)</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.pdfUrlEnglish}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download English Paper
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Answer Key</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.answerKeyUrl}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Answer Key
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        html += `
            <div class="mt-4">
                <h5>Paper Details</h5>
                <table class="table table-bordered">
                    <tr><th>Year</th><td>${paper.year}</td></tr>
                    <tr><th>Paper Number</th><td>${paper.paperNumber}</td></tr>
                    <tr><th>Subject</th><td>${paper.subject}</td></tr>
                    <tr><th>Medium</th><td>${paper.medium}</td></tr>
                    <tr><th>Total Marks</th><td>${paper.totalMarks}</td></tr>
                    <tr><th>Total Questions</th><td>${Object.keys(paper.questions).length}</td></tr>
                </table>
            </div>
        `;

        document.getElementById('paperDetails').innerHTML = html;
        
        // Store paperId for copy link function
        document.getElementById('copyPaperLinkBtn').setAttribute('data-paper-id', paperId);
        
        // Update time remaining counter if paper is active
        if (status === 'Active') {
            updateTimeRemaining(closeTime);
            const timer = setInterval(() => updateTimeRemaining(closeTime), 1000);
            
            // Clear interval when modal is closed
            document.getElementById('paperModal').addEventListener('hidden.bs.modal', () => {
                clearInterval(timer);
            });
        }

        const modal = new bootstrap.Modal(document.getElementById('paperModal'));
        modal.show();

    document.getElementById('deletePaperBtn').addEventListener('click', () => {
        modal.hide();
        deletePaper(paperId, paper.title);
    });

    } catch (error) {
        console.error('Error viewing paper:', error);
        alert(`Error: ${error.message}`);
    }
}

function checkPaperAvailability(paperId) {
    return database.ref(`papers/${paperId}`).once('value').then(snapshot => {
        const paper = snapshot.val();
        if (!paper) return false;
        
        const now = new Date().getTime();
        const openTime = new Date(paper.openTime).getTime();
        const closeTime = new Date(paper.closeTime).getTime();
        
        return now >= openTime && now <= closeTime;
    });
}

function updateTimeRemaining(closeTime) {
    const now = new Date();
    const end = new Date(closeTime);
    const diff = end - now;
    
    if (diff <= 0) {
        document.getElementById('timeRemaining').innerHTML = 'Time expired';
        return;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('timeRemaining').innerHTML = `
        ${hours}h ${minutes}m ${seconds}s remaining
    `;
}

// Copy paper link
document.getElementById('copyPaperLinkBtn').addEventListener('click', function() {
    const paperId = this.getAttribute('data-paper-id');
    if (!paperId) {
        alert('Paper ID not found');
        return;
    }
    
    const paperLink = `${window.location.origin}/student-paper.html?paperId=${paperId}`;
    
    navigator.clipboard.writeText(paperLink).then(() => {
        // Show feedback
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
        
        // Revert after 2 seconds
        setTimeout(() => {
            this.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy link:', err);
        
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = paperLink;
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
            
            // Revert after 2 seconds
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        } catch (err) {
            alert('Failed to copy link. Please try again or copy manually.');
        }
        
        document.body.removeChild(textArea);
    });
});

// Load papers for submissions view
async function loadSubmissionPapers() {
    const yearFilter = document.getElementById('submissionYearFilter').value;
    const monthFilter = document.getElementById('submissionMonthFilter').value;
    
    try {
        const snapshot = await database.ref('papers').once('value');
        const papers = snapshot.val() || {};
        const container = document.getElementById('submissionPaperCards');
        
        // Clear container properly
        container.innerHTML = '';
        
        let papersArray = Object.entries(papers).map(([id, paper]) => ({ id, ...paper }));
        
        // Apply filters
        if (yearFilter) {
            papersArray = papersArray.filter(paper => paper.year === yearFilter);
        }
        
        if (monthFilter) {
            papersArray = papersArray.filter(paper => {
                const paperDate = new Date(paper.createdAt || paper.openTime);
                return (paperDate.getMonth() + 1) === parseInt(monthFilter);
            });
        }
        
        if (papersArray.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No papers found</p>
                </div>
            `;
            return;
        }
        
        // Sort by creation date (newest first)
        papersArray.sort((a, b) => {
            const dateA = new Date(a.createdAt || a.openTime).getTime();
            const dateB = new Date(b.createdAt || b.openTime).getTime();
            return dateB - dateA;
        });
        
        // Create paper cards
        for (const paper of papersArray) {
            // Get submission count
            const submissionsSnapshot = await database.ref(`submissions/${paper.id}`).once('value');
            const submissionCount = submissionsSnapshot.exists() ? Object.keys(submissionsSnapshot.val()).length : 0;
            
            const card = createSubmissionPaperCard(paper.id, paper, submissionCount);
            container.appendChild(card);
        }
        
    } catch (error) {
        console.error('Error loading submission papers:', error);
        document.getElementById('submissionPaperCards').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                Error loading papers
            </div>
        `;
    }
}

// Create a card for submission papers (different from view papers cards)
function createSubmissionPaperCard(id, paper, submissionCount) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 submission-paper-card';
    card.setAttribute('data-paper-id', id);
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${paper.title}</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Year: ${paper.year}</span>
                    <span class="text-muted">Paper: ${paper.paperNumber}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-primary">
                        ${submissionCount} submission${submissionCount !== 1 ? 's' : ''}
                    </span>
                    <small class="text-muted">
                        ${new Date(paper.createdAt || paper.openTime).toLocaleDateString()}
                    </small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-submissions-btn">
                    <i class="bi bi-list-check"></i> View Submissions
                </button>
            </div>
        </div>
    `;
    
    // Add event listener for view submissions
    card.querySelector('.view-submissions-btn').addEventListener('click', () => {
        loadPaperSubmissions(id, paper.title);
    });
    
    return card;
}

// Load submissions for a specific paper
async function loadPaperSubmissions(paperId, paperTitle) {
    try {
        // Show loading state
        const tbody = document.getElementById('submissionsList');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border"></div></td></tr>';
        
        // Set paper title
        document.getElementById('selectedPaperTitle').textContent = `Submissions: ${paperTitle}`;
        
        // Show submissions list and hide paper cards
        document.getElementById('submissionPaperCards').style.display = 'none';
        document.getElementById('submissionsListCard').style.display = 'block';
        
        // Load submissions
        const snapshot = await database.ref(`submissions/${paperId}`).once('value');
        const submissions = snapshot.val() || {};
        
        tbody.innerHTML = '';
        
        if (Object.keys(submissions).length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        // Convert to array and sort by timestamp (newest first)
        const submissionsArray = Object.entries(submissions).map(([nic, submission]) => ({
            nic, ...submission
        })).sort((a, b) => b.timestamp - a.timestamp);
        
        // Display submissions
        submissionsArray.forEach(sub => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.name}</td>
                <td>${sub.nic}</td>
                <td>${sub.district}</td>
                <td>${sub.class}</td>
                <td>${sub.score}</td>
                <td>${new Date(sub.timestamp).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-submission" 
                            data-paper="${paperId}" data-nic="${sub.nic}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add click event to view submission details
            row.querySelector('.view-submission').addEventListener('click', () => {
                viewSubmissionDetails(paperId, sub.nic);
            });
        });
        
    } catch (error) {
        console.error('Error loading paper submissions:', error);
        document.getElementById('submissionsList').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger">Error loading submissions</td></tr>
        `;
        
        // Make sure back button is still visible
        document.getElementById('submissionsListCard').style.display = 'block';
    }
}

// Back to papers button
document.getElementById('backToPapersBtn').addEventListener('click', function() {
    // Show the paper cards container
    document.getElementById('submissionPaperCards').style.display = 'flex';
    
    // Hide the submissions table
    document.getElementById('submissionsListCard').style.display = 'none';
    
    // Reset any scroll positions
    window.scrollTo(0, 0);
});

// Filter submissions button
document.getElementById('submissionFilterBtn').addEventListener('click', loadSubmissionPapers);

// View submission details
async function viewSubmissionDetails(paperId, nic) {
    try {
        const [paperSnapshot, submissionSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}/${nic}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submission = submissionSnapshot.val();
        
        if (!paper || !submission) throw new Error('Submission details not found');
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Paper: ${paper.title}</h6>
                    <h6>Student: ${submission.name} (${nic})</h6>
                </div>
                <div class="col-md-6 text-end">
                    <h5>Score: ${submission.score} / ${paper.totalMarks}</h5>
                    <h6>Submitted: ${new Date(submission.timestamp).toLocaleString()}</h6>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Options</th>
                        <th>Correct Answer</th>
                        <th>Student's Answer</th>
                        <th>Marks</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        for (const [qNum, question] of Object.entries(paper.questions)) {
            const studentAnswer = submission.answers[qNum] || '-';
            const isCorrect = studentAnswer === question.answer;
            const marksEarned = isCorrect ? question.marks : 0;
            
            // Format options
            let optionsHtml = '<ol>';
            if (question.options) {
                question.options.forEach((opt, idx) => {
                    optionsHtml += `<li>${opt}</li>`;
                });
            } else {
                optionsHtml += '<li>Option data not available</li>';
            }
            optionsHtml += '</ol>';
            
            html += `
                <tr>
                    <td>${question.questionText}</td>
                    <td>${optionsHtml}</td>
                    <td>${question.answer}</td>
                    <td>${studentAnswer}</td>
                    <td>${question.marks}</td>
                    <td class="${isCorrect ? 'text-success' : 'text-danger'}">
                        ${isCorrect ? 'Correct' : 'Incorrect'} (${marksEarned}/${question.marks})
                    </td>
                </tr>
            `;
        }
        
        html += `</tbody></table>`;
        document.getElementById('submissionDetails').innerHTML = html;
        new bootstrap.Modal(document.getElementById('submissionModal')).show();

    } catch (error) {
        console.error('Error viewing submission:', error);
        alert(`Error: ${error.message}`);
    }
}

//=====Online Paper Rankings ==========================

// Load ranking papers with filters
async function loadRankingPapers() {
    const yearFilter = document.getElementById('rankingYearFilter').value;
    const monthFilter = document.getElementById('rankingMonthFilter').value;
    const container = document.getElementById('rankingPaperCards');
    
    try {
        // Show loading state
        container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';
        
        const snapshot = await database.ref('papers').once('value');
        const papers = snapshot.val() || {};
        
        console.log('Papers data:', papers); // Debug log
        
        // Clear container
        container.innerHTML = '';
        
        let papersArray = Object.entries(papers).map(([id, paper]) => ({ 
            id, 
            ...paper,
            createdAt: paper.createdAt || paper.openTime // Ensure we have a date
        }));
        
        // Apply filters
        if (yearFilter) {
            papersArray = papersArray.filter(paper => paper.year === yearFilter);
        }
        
        if (monthFilter) {
            papersArray = papersArray.filter(paper => {
                const paperDate = new Date(paper.createdAt);
                return (paperDate.getMonth() + 1) === parseInt(monthFilter);
            });
        }
        
        console.log('Filtered papers:', papersArray); // Debug log
        
        if (papersArray.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No papers found matching your criteria</p>
                </div>
            `;
            return;
        }
        
        // Sort by date (newest first)
        papersArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // Create cards
        for (const paper of papersArray) {
            try {
                // Get submission count
                const submissionsSnapshot = await database.ref(`submissions/${paper.id}`).once('value');
                const submissionCount = submissionsSnapshot.exists() ? Object.keys(submissionsSnapshot.val()).length : 0;
                
                const card = createRankingPaperCard(paper.id, paper, submissionCount);
                container.appendChild(card);
            } catch (error) {
                console.error(`Error processing paper ${paper.id}:`, error);
                // Continue with next paper even if one fails
            }
        }
        
    } catch (error) {
        console.error('Error loading ranking papers:', error);
        container.innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                <i class="bi bi-exclamation-triangle display-5 mb-3"></i>
                <p>Error loading papers. Please try again.</p>
                ${error.message ? `<small>${error.message}</small>` : ''}
            </div>
        `;
    }
}

// Create a card for ranking papers
function createRankingPaperCard(id, paper, submissionCount) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 ranking-paper-card';
    card.setAttribute('data-paper-id', id);
    
    // Format date
    const paperDate = new Date(paper.createdAt || paper.openTime);
    const formattedDate = paperDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${paper.title || 'Untitled Paper'}</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Year: ${paper.year || 'N/A'}</span>
                    <span class="text-muted">Paper: ${paper.paperNumber || 'N/A'}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-primary">
                        ${submissionCount} submission${submissionCount !== 1 ? 's' : ''}
                    </span>
                    <small class="text-muted">${formattedDate}</small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-rankings-btn">
                    <i class="bi bi-trophy"></i> View Rankings
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-2 download-rankings-btn">
                    <i class="bi bi-download"></i> PDF
                </button>
            </div>
        </div>
    `;
    
    // Add event listeners
    card.querySelector('.view-rankings-btn').addEventListener('click', () => {
        viewPaperRankings(id, paper.title);
    });
    
    card.querySelector('.download-rankings-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        generateRankingPdf(id, paper);
    });
    
    return card;
}

// View paper rankings
function viewPaperRankings(paperId, paperTitle) {
    document.getElementById('selectedRankingPaperTitle').textContent = `Rankings: ${paperTitle}`;
    document.getElementById('rankingPaperCards').style.display = 'none';
    document.getElementById('rankingsListCard').style.display = 'block';
    document.getElementById('downloadRankingPdfBtn').setAttribute('data-paper-id', paperId);
    loadRankings(paperId);
}

// Back to papers button - Fixed implementation
document.getElementById('backToRankingPapersBtn').addEventListener('click', function() {
    document.getElementById('rankingPaperCards').style.display = 'flex';
    document.getElementById('rankingsListCard').style.display = 'none';
    window.scrollTo(0, 0);
});

// Filter rankings button
document.getElementById('rankingFilterBtn').addEventListener('click', loadRankingPapers);

// Load rankings for a paper
async function loadRankings(paperId) {
    const tbody = document.getElementById('rankingsList');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';
    
    try {
        const [paperSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submissions = submissionsSnapshot.val() || {};
        
        if (!paper) throw new Error('Paper not found');
        
        const submissionsArray = Object.entries(submissions).map(([nic, submission]) => ({
            nic, ...submission
        }));
        
        submissionsArray.sort((a, b) => b.score - a.score);
        
        let currentRank = 1;
        submissionsArray.forEach((sub, index) => {
            if (index > 0 && sub.score < submissionsArray[index - 1].score) {
                currentRank = index + 1;
            }
            sub.rank = currentRank;
        });
        
        tbody.innerHTML = '';
        if (submissionsArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        submissionsArray.forEach(sub => {
            const percentage = ((sub.score / paper.totalMarks) * 100).toFixed(1);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.rank}</td>
                <td>${sub.name}</td>
                <td>${sub.nic}</td>
                <td>${sub.district}</td>
                <td>${sub.class}</td>
                <td>${sub.school || '-'}</td>
                <td>${sub.score}</td>
                <td>${percentage}%</td>
            `;
            tbody.appendChild(row);
        });
        
        const updates = {};
        submissionsArray.forEach(sub => {
            updates[`submissions/${paperId}/${sub.nic}/rank`] = sub.rank;
        });
        await database.ref().update(updates);

    } catch (error) {
        console.error('Error loading rankings:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading rankings</td></tr>';
    }
}

// Enhanced generateRankingPdf function
async function generateRankingPdf(paperId, paperData) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        // Add a stylish header with background color
        doc.setFillColor(41, 128, 185);
        doc.rect(0, 0, 210, 30, 'F');
        
        // Add logo (if available) or text logo
        try {
            const logoImg = await loadImage('Ukuwela-sir-banner.png');
            doc.addImage(logoImg, 'PNG', 15, 10, 50, 15);
        } catch (e) {
            doc.setFontSize(20);
            doc.setTextColor(255, 255, 255);
            doc.text('eWings Papers', 105, 20, { align: 'center' });
        }

        // Add paper info section with nice styling
        doc.setFontSize(18);
        doc.setTextColor(40, 40, 40);
        doc.text(`${paperData.title}`, 105, 45, { align: 'center' });
        
        doc.setFontSize(16);
        doc.setTextColor(80, 80, 80);
        doc.text('Overall Rankings Report', 105, 55, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Year ${paperData.year} | Paper ${paperData.paperNumber} | ${new Date(paperData.createdAt).toLocaleDateString()}`, 105, 62, { align: 'center' });

        // Get submissions data
        const submissionsSnapshot = await database.ref(`submissions/${paperId}`).once('value');
        const submissions = submissionsSnapshot.val() || {};
        const submissionsArray = Object.entries(submissions).map(([nic, sub]) => ({ nic, ...sub }));
        
        // Sort by score
        submissionsArray.sort((a, b) => b.score - a.score);
        
        // Calculate ranks
        let currentRank = 1;
        submissionsArray.forEach((sub, index) => {
            if (index > 0 && sub.score < submissionsArray[index - 1].score) {
                currentRank = index + 1;
            }
            sub.rank = currentRank;
        });

        // Performance statistics section
        doc.setFontSize(14);
        doc.setTextColor(0, 100, 0);
        doc.text('Performance Statistics', 20, 80);
        
        const totalStudents = submissionsArray.length;
        const averageScore = submissionsArray.reduce((sum, s) => sum + s.score, 0) / totalStudents;
        const maxScore = Math.max(...submissionsArray.map(s => s.score));
        const minScore = Math.min(...submissionsArray.map(s => s.score));
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Total Submissions: ${totalStudents}`, 20, 90);
        doc.text(`Average Score: ${averageScore.toFixed(1)}/${paperData.totalMarks} (${((averageScore / paperData.totalMarks) * 100).toFixed(1)}%)`, 20, 100);
        doc.text(`Highest Score: ${maxScore}/${paperData.totalMarks}`, 20, 110);
        doc.text(`Lowest Score: ${minScore}/${paperData.totalMarks}`, 20, 120);

        // Top schools analysis
        const schoolCounts = {};
        submissionsArray.slice(0, 100).forEach(sub => {
            if (sub.school) {
                schoolCounts[sub.school] = (schoolCounts[sub.school] || 0) + 1;
            }
        });
        
        const topSchools = Object.entries(schoolCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        if (topSchools.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(0, 100, 0);
            doc.text('Top Performing Schools:', 110, 80);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            topSchools.forEach(([school, count], index) => {
                doc.text(`${index + 1}. ${school} (${count} top students)`, 110, 90 + (index * 10));
            });
        }

        // Top students by district
        const districtCounts = {};
        submissionsArray.slice(0, 100).forEach(sub => {
            if (sub.district) {
                districtCounts[sub.district] = (districtCounts[sub.district] || 0) + 1;
            }
        });
        
        const topDistricts = Object.entries(districtCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
        
        if (topDistricts.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(0, 100, 0);
            doc.text('Top Performing Districts:', 110, 140);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            topDistricts.forEach(([district, count], index) => {
                doc.text(`${index + 1}. ${district} (${count} top students)`, 110, 150 + (index * 10));
            });
        }

        // Main rankings table
        doc.setFontSize(14);
        doc.setTextColor(40, 40, 40);
        doc.text('Overall Rankings (Top 100)', 105, 180, { align: 'center' });
        
        doc.autoTable({
            startY: 185,
            head: [
                [
                    { content: 'Rank', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Name', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Class', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Score', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Percentage', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'School', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } }
                ]
            ],
            body: submissionsArray.slice(0, 100).map(sub => [
                sub.rank,
                sub.name,
                sub.class || '-',
                `${sub.score}/${paperData.totalMarks}`,
                `${((sub.score / paperData.totalMarks) * 100).toFixed(1)}%`,
                sub.school || '-'
            ]),
            headStyles: {
                fillColor: [41, 128, 185],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            styles: {
                fontSize: 10,
                cellPadding: 3,
                overflow: 'linebreak',
                halign: 'center'
            },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' }, // Rank
                1: { cellWidth: 40, halign: 'left' },   // Name
                2: { cellWidth: 25, halign: 'center' }, // Class
                3: { cellWidth: 20, halign: 'center' }, // Score
                4: { cellWidth: 25, halign: 'center' }, // Percentage
                5: { cellWidth: 40, halign: 'left' }    // School
            },
            margin: { top: 10 },
            theme: 'grid'
        });

        // Add footer
        doc.setFontSize(10);
        doc.setTextColor(150, 150, 150);
        doc.text('Generated by eWings Papers Admin Panel', 105, 285, { align: 'center' });
        doc.text(new Date().toLocaleString(), 105, 290, { align: 'center' });

        // Save the PDF with a proper filename
        const filename = `Overall_Rankings_${paperData.title.replace(/[^a-z0-9]/gi, '_')}_${paperData.year}_${paperData.paperNumber}.pdf`;
        doc.save(filename);
        
    } catch (error) {
        console.error('Error in PDF generation:', error);
        alert(`Error generating PDF: ${error.message}`);
    }
}

// Helper function to load scripts dynamically
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// Helper function to load images
function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
    });
}

// Helper function to add rankings table to PDF
function addRankingsTable(doc, rankings, startY) {
    doc.autoTable({
        startY: startY,
        head: [['Rank', 'Name', 'NIC', 'District', 'School', 'Score', 'Percentage']],
        body: rankings.map(sub => [
            sub.rank,
            sub.name,
            sub.nic,
            sub.district,
            sub.school || '-',
            sub.score,
            ((sub.score / paper.totalMarks) * 100).toFixed(1) + '%'
        ]),
        headStyles: {
            fillColor: [41, 128, 185],
            textColor: 255,
            fontStyle: 'bold'
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        },
        margin: { top: 10 },
        styles: {
            fontSize: 8,
            cellPadding: 3,
            overflow: 'linebreak'
        },
        columnStyles: {
            0: { cellWidth: 15 }, // Rank
            1: { cellWidth: 40 }, // Name
            2: { cellWidth: 30 }, // NIC
            3: { cellWidth: 30 }, // District
            4: { cellWidth: 40 }, // School
            5: { cellWidth: 20 }, // Score
            6: { cellWidth: 25 }  // Percentage
        }
    });
}

// Download ranking PDF button - Fixed implementation
document.getElementById('downloadRankingPdfBtn').addEventListener('click', async function() {
    const paperId = this.getAttribute('data-paper-id');
    if (!paperId) {
        alert('No paper selected');
        return;
    }
    
    try {
        // Show loading state
        const originalText = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Preparing PDF...';
        this.disabled = true;
        
        // Check if jsPDF is available
        if (typeof window.jspdf === 'undefined') {
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js');
        }
        
        // Get paper data
        const paperSnapshot = await database.ref(`papers/${paperId}`).once('value');
        const paperData = paperSnapshot.val();
        
        if (!paperData) {
            throw new Error('Paper not found');
        }
        
        // Generate PDF
        await generateRankingPdf(paperId, paperData);
        
    } catch (error) {
        console.error('PDF generation error:', error);
        alert(`Error generating PDF: ${error.message}`);
    } finally {
        this.innerHTML = originalText;
        this.disabled = false;
    }
});

// Class rankings button - Fixed implementation
document.getElementById('classRankingsBtn').addEventListener('click', async function() {
    const paperId = document.getElementById('downloadRankingPdfBtn').getAttribute('data-paper-id');
    if (!paperId) {
        alert('Please view rankings for a paper first');
        return;
    }
    
    try {
        // Show loading state
        const originalText = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
        this.disabled = true;
        
        const [paperSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref(`papers/${paperId}`).once('value'),
            database.ref(`submissions/${paperId}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submissions = submissionsSnapshot.val() || {};
        
        if (!paper) {
            throw new Error('Paper not found');
        }
        
        // Process submissions
        const submissionsArray = Object.entries(submissions).map(([nic, submission]) => ({
            nic, 
            ...submission,
            class: submission.class || 'Unknown' // Ensure class exists
        }));
        
        // Group by class
        const classGroups = {};
        submissionsArray.forEach(sub => {
            if (!classGroups[sub.class]) {
                classGroups[sub.class] = [];
            }
            classGroups[sub.class].push(sub);
        });
        
        // Sort each class group
        Object.values(classGroups).forEach(group => {
            group.sort((a, b) => b.score - a.score);
            
            // Calculate class ranks
            let currentRank = 1;
            group.forEach((student, index) => {
                if (index > 0 && student.score < group[index - 1].score) {
                    currentRank = index + 1;
                }
                student.classRank = currentRank;
            });
        });
        
        // Generate HTML for modal
        let html = '';
        for (const [className, students] of Object.entries(classGroups)) {
            html += `
                <div class="mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>${className} Class</h4>
                        <button class="btn btn-sm btn-primary download-class-pdf" 
                                data-class="${className}">
                            <i class="bi bi-file-earmark-pdf"></i> Download
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                    <th>School</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            students.slice(0, 50).forEach(student => {
                const percentage = ((student.score / paper.totalMarks) * 100).toFixed(1);
                html += `
                    <tr>
                        <td>${student.classRank}</td>
                        <td>${student.name}</td>
                        <td>${student.score}/${paper.totalMarks}</td>
                        <td>${percentage}%</td>
                        <td>${student.school || '-'}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div></div>`;
        }
        
        document.getElementById('classRankingsContent').innerHTML = html;
        
        // Add event listeners to class PDF buttons
        document.querySelectorAll('.download-class-pdf').forEach(btn => {
            btn.addEventListener('click', () => {
                const className = btn.getAttribute('data-class');
                generateClassRankingPdf(paperId, paper, classGroups[className], className);
            });
        });
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('classRankingsModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading class rankings:', error);
        alert(`Error: ${error.message}`);
    } finally {
        this.innerHTML = '<i class="bi bi-people"></i> Class Rankings';
        this.disabled = false;
    }
});

// Generate PDF for a single class ranking
async function generateClassRankingPdf(paperId, paperData, students, className) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        // Add a stylish header with background color
        doc.setFillColor(41, 128, 185);
        doc.rect(0, 0, 210, 30, 'F');
        
        // Add logo (if available) or text logo
        try {
            const logoImg = await loadImage('Ukuwela-sir-banner.png');
            doc.addImage(logoImg, 'PNG', 15, 10, 50, 15);
        } catch (e) {
            doc.setFontSize(20);
            doc.setTextColor(255, 255, 255);
            doc.text('eWings Papers', 105, 20, { align: 'center' });
        }

        // Add paper info section with nice styling
        doc.setFontSize(18);
        doc.setTextColor(40, 40, 40);
        doc.text(`${paperData.title}`, 105, 45, { align: 'center' });
        
        doc.setFontSize(16);
        doc.setTextColor(80, 80, 80);
        doc.text(`Class Rankings: ${className}`, 105, 55, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Year ${paperData.year} | Paper ${paperData.paperNumber} | ${new Date(paperData.createdAt).toLocaleDateString()}`, 105, 62, { align: 'center' });

        // Add a divider line
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 70, 190, 70);

        // Performance summary section
        doc.setFontSize(14);
        doc.setTextColor(0, 100, 0);
        doc.text('Performance Summary', 20, 80);
        
        // Calculate statistics
        const totalStudents = students.length;
        const averageScore = students.reduce((sum, s) => sum + s.score, 0) / totalStudents;
        const maxScore = Math.max(...students.map(s => s.score));
        const minScore = Math.min(...students.map(s => s.score));
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Total Students: ${totalStudents}`, 20, 90);
        doc.text(`Average Score: ${averageScore.toFixed(1)}/${paperData.totalMarks} (${((averageScore / paperData.totalMarks) * 100).toFixed(1)}%)`, 20, 100);
        doc.text(`Highest Score: ${maxScore}/${paperData.totalMarks}`, 20, 110);
        doc.text(`Lowest Score: ${minScore}/${paperData.totalMarks}`, 20, 120);

        // Top schools analysis
        const schoolCounts = {};
        students.forEach(sub => {
            if (sub.school) {
                schoolCounts[sub.school] = (schoolCounts[sub.school] || 0) + 1;
            }
        });
        
        const topSchools = Object.entries(schoolCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
        
        if (topSchools.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(0, 100, 0);
            doc.text('Top Performing Schools:', 110, 80);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            topSchools.forEach(([school, count], index) => {
                doc.text(`${index + 1}. ${school} (${count} students)`, 110, 90 + (index * 10));
            });
        }

        // Add rankings table with improved styling
        doc.setFontSize(14);
        doc.setTextColor(40, 40, 40);
        doc.text(`${className} Class Rankings`, 105, 140, { align: 'center' });
        
        doc.autoTable({
            startY: 150,
            head: [
                [
                    { content: 'Rank', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Name', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'NIC', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Score', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'Percentage', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } },
                    { content: 'School', styles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' } }
                ]
            ],
            body: students.slice(0, 100).map(student => [
                student.classRank,
                student.name,
                student.nic,
                `${student.score}/${paperData.totalMarks}`,
                `${((student.score / paperData.totalMarks) * 100).toFixed(1)}%`,
                student.school || '-'
            ]),
            headStyles: {
                fillColor: [41, 128, 185],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            styles: {
                fontSize: 10,
                cellPadding: 3,
                overflow: 'linebreak',
                halign: 'center'
            },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' }, // Rank
                1: { cellWidth: 40, halign: 'left' },   // Name
                2: { cellWidth: 30, halign: 'center' }, // NIC
                3: { cellWidth: 20, halign: 'center' }, // Score
                4: { cellWidth: 25, halign: 'center' }, // Percentage
                5: { cellWidth: 40, halign: 'left' }    // School
            },
            margin: { top: 10 },
            theme: 'grid'
        });

        // Add footer
        doc.setFontSize(10);
        doc.setTextColor(150, 150, 150);
        doc.text('Generated by eWings Papers Admin Panel', 105, 285, { align: 'center' });
        doc.text(new Date().toLocaleString(), 105, 290, { align: 'center' });

        // Save the PDF with a proper filename
        const filename = `Rankings_${paperData.title.replace(/[^a-z0-9]/gi, '_')}_${className}_${paperData.year}_${paperData.paperNumber}.pdf`;
        doc.save(filename);
        
    } catch (error) {
        console.error('Error generating class PDF:', error);
        alert(`Error generating PDF: ${error.message}`);
    }
}

// Ensure all download buttons work properly
document.addEventListener('click', async function(e) {
    // Handle class rankings PDF download
    if (e.target.classList.contains('download-class-pdf') || e.target.closest('.download-class-pdf')) {
        const btn = e.target.classList.contains('download-class-pdf') ? e.target : e.target.closest('.download-class-pdf');
        const className = btn.getAttribute('data-class');
        const paperId = document.getElementById('downloadRankingPdfBtn').getAttribute('data-paper-id');
        
        if (!paperId || !className) {
            alert('Paper data not found');
            return;
        }
        
        try {
            // Get paper data
            const paperSnapshot = await database.ref(`papers/${paperId}`).once('value');
            const paperData = paperSnapshot.val();
            
            if (!paperData) {
                throw new Error('Paper not found');
            }
            
            // Get submissions for this class
            const submissionsSnapshot = await database.ref(`submissions/${paperId}`).once('value');
            const submissions = submissionsSnapshot.val() || {};
            const classSubmissions = Object.entries(submissions)
                .map(([nic, sub]) => ({ nic, ...sub }))
                .filter(sub => sub.class === className);
            
            // Sort by score
            classSubmissions.sort((a, b) => b.score - a.score);
            
            // Calculate class ranks
            let currentRank = 1;
            classSubmissions.forEach((sub, index) => {
                if (index > 0 && sub.score < classSubmissions[index - 1].score) {
                    currentRank = index + 1;
                }
                sub.classRank = currentRank;
            });
            
            // Generate PDF
            await generateClassRankingPdf(paperId, paperData, classSubmissions, className);
            
        } catch (error) {
            console.error('Error generating class PDF:', error);
            alert(`Error: ${error.message}`);
        }
    }
    
    // Handle "Download All as PDF" button
    if (e.target.id === 'downloadAllClassRankingsBtn' || e.target.closest('#downloadAllClassRankingsBtn')) {
        const paperId = document.getElementById('downloadRankingPdfBtn').getAttribute('data-paper-id');
        
        if (!paperId) {
            alert('No paper selected');
            return;
        }
        
        try {
            // Get paper data
            const paperSnapshot = await database.ref(`papers/${paperId}`).once('value');
            const paperData = paperSnapshot.val();
            
            if (!paperData) {
                throw new Error('Paper not found');
            }
            
            // Get all submissions
            const submissionsSnapshot = await database.ref(`submissions/${paperId}`).once('value');
            const submissions = submissionsSnapshot.val() || {};
            const submissionsArray = Object.entries(submissions).map(([nic, sub]) => ({ nic, ...sub }));
            
            // Group by class
            const classGroups = {};
            submissionsArray.forEach(sub => {
                const className = sub.class || 'Unknown';
                if (!classGroups[className]) {
                    classGroups[className] = [];
                }
                classGroups[className].push(sub);
            });
            
            // Sort each class group and calculate ranks
            Object.values(classGroups).forEach(group => {
                group.sort((a, b) => b.score - a.score);
                
                let currentRank = 1;
                group.forEach((student, index) => {
                    if (index > 0 && student.score < group[index - 1].score) {
                        currentRank = index + 1;
                    }
                    student.classRank = currentRank;
                });
            });
            
            // Create a zip file with all class PDFs
            const { JSZip } = window;
            if (!JSZip) {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
            }
            
            const zip = new JSZip();
            const pdfPromises = [];
            
            // Generate PDF for each class
            for (const [className, students] of Object.entries(classGroups)) {
                const pdfPromise = new Promise(async (resolve) => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Generate the PDF content (using our enhanced function)
                    // ... (same content as generateClassRankingPdf)
                    
                    // Add to zip
                    const pdfData = doc.output('arraybuffer');
                    zip.file(`Rankings_${paperData.title.replace(/[^a-z0-9]/gi, '_')}_${className}.pdf`, pdfData);
                    resolve();
                });
                
                pdfPromises.push(pdfPromise);
            }
            
            // Wait for all PDFs to be generated
            await Promise.all(pdfPromises);
            
            // Generate the zip file
            const content = await zip.generateAsync({ type: 'blob' });
            
            // Download the zip file
            const zipUrl = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = zipUrl;
            a.download = `All_Class_Rankings_${paperData.title.replace(/[^a-z0-9]/gi, '_')}_${paperData.year}_${paperData.paperNumber}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(zipUrl);
            
        } catch (error) {
            console.error('Error generating all class PDFs:', error);
            alert(`Error: ${error.message}`);
        }
    }
});

//=================================
//--------Paper Class -------------
//=================================

// Paper Class Templates
const paperClassTemplates = {
    template15: {
        name: "15 Questions Template",
        count: 15,
        questions: Array.from({length: 15}, (_, i) => ({
            number: i + 1,
            marks: 1,
            type: "essay"
        }))
    },
    template25: {
        name: "25 Questions Template",
        count: 25,
        questions: Array.from({length: 25}, (_, i) => ({
            number: i + 1,
            marks: 1,
            type: "essay"
        }))
    },
    template50: {
        name: "50 Questions Template",
        count: 50,
        questions: Array.from({length: 50}, (_, i) => ({
            number: i + 1,
            marks: 1,
            type: "essay"
        }))
    }
};

// Apply Paper Class template
function applyPaperClassTemplate(template) {
    const container = document.getElementById('paperClassQuestionsContainer');
    container.innerHTML = '';
    
    template.questions.forEach((q, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item mb-3 p-3 border rounded';
        questionDiv.innerHTML = `
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Question ${q.number}</label>
                    <input type="number" class="form-control question-number" value="${q.number}" readonly>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Marks</label>
                    <input type="number" class="form-control question-marks" value="${q.marks}" min="1" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Type</label>
                    <select class="form-select question-type" required>
                        <option value="mcq" ${q.type === "mcq" ? "selected" : ""}>MCQ</option>
                        <option value="essay" ${q.type === "essay" ? "selected" : ""}>Essay</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Correct Answer (MCQ)</label>
                    <select class="form-select question-answer" ${q.type === "essay" ? "disabled" : ""}>
                        <option value="">N/A</option>
                        <option value="1" ${q.answer === "1" ? "selected" : ""}>1</option>
                        <option value="2" ${q.answer === "2" ? "selected" : ""}>2</option>
                        <option value="3" ${q.answer === "3" ? "selected" : ""}>3</option>
                        <option value="4" ${q.answer === "4" ? "selected" : ""}>4</option>
                        <option value="5" ${q.answer === "5" ? "selected" : ""}>5</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-question">
                <i class="bi bi-trash"></i> Remove
            </button>
        `;
        container.appendChild(questionDiv);
        
        // Enable/disable answer select based on question type
        questionDiv.querySelector('.question-type').addEventListener('change', function() {
            questionDiv.querySelector('.question-answer').disabled = this.value === 'essay';
        });
    });
    
    // Update question count
    paperClassQuestionCount = template.count;
}

// Template buttons
document.getElementById('paperClassTemplate15Btn').addEventListener('click', (e) => {
    e.preventDefault();
    applyPaperClassTemplate(paperClassTemplates.template15);
});

document.getElementById('paperClassTemplate25Btn').addEventListener('click', (e) => {
    e.preventDefault();
    applyPaperClassTemplate(paperClassTemplates.template25);
});

document.getElementById('paperClassTemplate50Btn').addEventListener('click', (e) => {
    e.preventDefault();
    applyPaperClassTemplate(paperClassTemplates.template50);
});

// Paper Class question management
let paperClassQuestionCount = 1;

document.getElementById('addPaperClassQuestionBtn').addEventListener('click', () => {
    paperClassQuestionCount++;
    const container = document.getElementById('paperClassQuestionsContainer');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item mb-3 p-3 border rounded';
    questionDiv.innerHTML = `
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">Question ${paperClassQuestionCount}</label>
                <input type="number" class="form-control question-number" value="${paperClassQuestionCount}" readonly>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Marks</label>
                <input type="number" class="form-control question-marks" placeholder="Marks" min="1" required>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Type</label>
                <select class="form-select question-type" required>
                    <option value="mcq">MCQ</option>
                    <option value="essay">Essay</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Correct Answer (MCQ)</label>
                <select class="form-select question-answer" disabled>
                    <option value="">N/A</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-question">
            <i class="bi bi-trash"></i> Remove
        </button>
    `;
    container.appendChild(questionDiv);
    
    // Enable/disable answer select based on question type
    questionDiv.querySelector('.question-type').addEventListener('change', function() {
        questionDiv.querySelector('.question-answer').disabled = this.value === 'essay';
    });
});

// Remove question event delegation
document.getElementById('paperClassQuestionsContainer').addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-question') || e.target.closest('.remove-question')) {
        e.target.closest('.question-item').remove();
        paperClassQuestionCount--;
        const questions = document.querySelectorAll('#paperClassQuestionsContainer .question-item');
        questions.forEach((q, index) => {
            q.querySelector('.form-label').textContent = `Question ${index + 1}`;
            q.querySelector('.question-number').value = index + 1;
        });
    }
});

// Create Paper Class Form
document.getElementById('createPaperClassForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isProcessingForm) return;
    isProcessingForm = true;
    
    try {
        const createBtn = document.getElementById('createPaperClassBtn');
        createBtn.disabled = true;
        createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

        const title = document.getElementById('paperClassTitle').value.trim();
        const year = document.getElementById('paperClassYear').value.trim();
        const paperNumber = document.getElementById('paperClassNumber').value.trim();
        const subject = document.getElementById('paperClassSubject').value.trim();
        const medium = document.getElementById('paperClassMedium').value;
        const openTime = document.getElementById('paperClassOpenTime').value;
        const closeTime = document.getElementById('paperClassCloseTime').value;
        const pdfFileSinhala = document.getElementById('paperClassPdfSinhala').files[0];
        const pdfFileEnglish = document.getElementById('paperClassPdfEnglish').files[0];
        const answerKeyFile = document.getElementById('paperClassAnswerKeyPdf').files[0];
        
        // Validate inputs
        if (!title || !year || !paperNumber || !subject || !medium || !openTime || !closeTime) {
            throw new Error('Please fill in all required fields');
        }

        // Get questions
        const questions = {};
        const questionItems = document.querySelectorAll('#paperClassQuestionsContainer .question-item');
        
        questionItems.forEach((item, index) => {
            const number = item.querySelector('.question-number').value.trim();
            const marks = parseInt(item.querySelector('.question-marks').value) || 0;
            const type = item.querySelector('.question-type').value;
            const answer = type === 'mcq' ? item.querySelector('.question-answer').value : '';
            
            if (number && !isNaN(marks)) {
                questions[number] = {
                    questionText: `Question ${number}`,
                    marks: marks,
                    type: type,
                    answer: answer,
                    options: type === 'mcq' ? ["Option 1", "Option 2", "Option 3", "Option 4", "Option 5"] : []
                };
            }
        });
        
        if (Object.keys(questions).length === 0) {
            throw new Error('Please add at least one valid question');
        }
        
        if (!pdfFileSinhala || !pdfFileEnglish || !answerKeyFile) {
            throw new Error('Please upload all required PDF files');
        }

        // Date validation
        const openDate = new Date(openTime);
        const closeDate = new Date(closeTime);
        const now = new Date();
        
        if (openDate < now) {
            throw new Error('Open time cannot be in the past');
        }
        
        if (closeDate <= openDate) {
            throw new Error('Close time must be after open time');
        }
        
        if ((closeDate - openDate) < (30 * 60 * 1000)) {
            throw new Error('The paper should be available for at least 30 minutes');
        }
        
        // Generate paper ID
        const paperId = `paper-class-${subject.toLowerCase()}-${year}-${paperNumber}-${Date.now()}`;
        
        // Upload files to storage
        const storageRef = storage.ref();
        const uploadTasks = [
            storageRef.child(`paperClassPapers/${paperId}/paper-sinhala.pdf`).put(pdfFileSinhala),
            storageRef.child(`paperClassPapers/${paperId}/paper-english.pdf`).put(pdfFileEnglish),
            storageRef.child(`paperClassPapers/${paperId}/answers.pdf`).put(answerKeyFile)
        ];
        
        await Promise.all(uploadTasks);
        
        // Get download URLs
        const [sinhalaUrl, englishUrl, answerKeyUrl] = await Promise.all([
            storageRef.child(`paperClassPapers/${paperId}/paper-sinhala.pdf`).getDownloadURL(),
            storageRef.child(`paperClassPapers/${paperId}/paper-english.pdf`).getDownloadURL(),
            storageRef.child(`paperClassPapers/${paperId}/answers.pdf`).getDownloadURL()
        ]);

        // Calculate total marks
        const totalMarks = Object.values(questions).reduce((sum, q) => sum + q.marks, 0);

        // Save paper data to paperClassPapers path
        await database.ref(`paperClassPapers/${paperId}`).set({
            title,
            year,
            paperNumber,
            subject,
            medium,
            openTime: new Date(openTime).toISOString(),
            closeTime: new Date(closeTime).toISOString(),
            pdfUrlSinhala: sinhalaUrl,
            pdfUrlEnglish: englishUrl,
            answerKeyUrl,
            questions,
            totalMarks,
            type: "paper-class",
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        alert('Paper Class paper created successfully!');
        document.getElementById('createPaperClassForm').reset();
        document.getElementById('paperClassQuestionsContainer').innerHTML = '';
        paperClassQuestionCount = 0;

    } catch (error) {
        console.error('Error creating paper class paper:', error);
        alert(`Error: ${error.message}`);
    } finally {
        isProcessingForm = false;
        const createBtn = document.getElementById('createPaperClassBtn');
        createBtn.disabled = false;
        createBtn.textContent = 'Create Paper';
    }
});

// Load Paper Class papers
async function loadPaperClassPapers() {
    try {
        const yearFilter = document.getElementById('paperClassYearFilter').value;
        const snapshot = await database.ref('paperClassPapers').once('value');
        const papers = snapshot.val() || {};
        const now = new Date().getTime();

        // Clear containers
        const clearContainer = (id) => {
            const container = document.getElementById(id);
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        };
        
        clearContainer('paperClassActivePapersContainer');
        clearContainer('paperClassUpcomingPapersContainer');
        clearContainer('paperClassClosedPapersContainer');

        let activeCount = 0;
        let upcomingCount = 0;
        let closedCount = 0;

        // Process each paper
        for (const [id, paper] of Object.entries(papers)) {
            // Apply year filter if set
            if (yearFilter && paper.year !== yearFilter) continue;

            const openTime = new Date(paper.openTime).getTime();
            const closeTime = new Date(paper.closeTime).getTime();
            
            // Create paper card
            const card = createPaperClassPaperCard(id, paper);

            // Categorize paper
            if (now >= openTime && now <= closeTime) {
                document.getElementById('paperClassActivePapersContainer').appendChild(card);
                activeCount++;
            } else if (now < openTime) {
                document.getElementById('paperClassUpcomingPapersContainer').appendChild(card);
                upcomingCount++;
            } else {
                document.getElementById('paperClassClosedPapersContainer').appendChild(card);
                closedCount++;
            }
        }

        // Update tab badges
        updatePaperClassTabBadges(activeCount, upcomingCount, closedCount);

        // Show empty state if no papers
        showPaperClassEmptyState('paperClassActivePapersContainer', activeCount);
        showPaperClassEmptyState('paperClassUpcomingPapersContainer', upcomingCount);
        showPaperClassEmptyState('paperClassClosedPapersContainer', closedCount);

    } catch (error) {
        console.error('Error loading paper class papers:', error);
        const errorHtml = '<div class="col-12 text-center text-danger py-5">Error loading papers</div>';
        document.getElementById('paperClassActivePapersContainer').innerHTML = errorHtml;
        document.getElementById('paperClassUpcomingPapersContainer').innerHTML = errorHtml;
        document.getElementById('paperClassClosedPapersContainer').innerHTML = errorHtml;
    }
}

//int Paper class Filters 
function initPaperClassSection() {
    // Add year filter event listener
    document.getElementById('paperClassYearFilter').addEventListener('change', loadPaperClassPapers);
    
    // Add submission filter event listener
    document.getElementById('paperClassSubmissionFilterBtn').addEventListener('click', loadPaperClassSubmissionPapers);
    
    // Back to papers button
    document.getElementById('backToPaperClassPapersBtn').addEventListener('click', function() {
        document.getElementById('paperClassSubmissionPaperCards').style.display = 'flex';
        document.getElementById('paperClassSubmissionsListCard').style.display = 'none';
        window.scrollTo(0, 0);
    });
}

// Create Paper Class paper card
function createPaperClassPaperCard(id, paper) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 paper-class-paper-card';
    card.setAttribute('data-paper-id', id);
    
    const now = new Date().getTime();
    const openTime = new Date(paper.openTime).getTime();
    const closeTime = new Date(paper.closeTime).getTime();
    const isActive = now >= openTime && now <= closeTime;
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${paper.title}</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Year: ${paper.year}</span>
                    <span class="text-muted">Paper: ${paper.paperNumber}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-${isActive ? 'success' : 'secondary'}">
                        ${isActive ? 'Active' : (now < openTime ? 'Upcoming' : 'Closed')}
                    </span>
                    <small class="text-muted">
                        ${new Date(paper.createdAt || paper.openTime).toLocaleDateString()}
                    </small>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Subject: ${paper.subject}</span>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Medium: ${paper.medium}</span>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Total Marks: ${paper.totalMarks}</span>
                </div>
                <div class="mb-2">
                    <span class="text-muted">Total Questions: ${Object.keys(paper.questions).length}</span>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-paper-class-btn">
                    <i class="bi bi-eye"></i> View Details
                </button>
                <button class="btn btn-sm btn-outline-danger ms-2 delete-paper-class-btn">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
    
    // Add event listener for view paper details
    card.querySelector('.view-paper-class-btn').addEventListener('click', function() {
        viewPaperClassPaperDetails(id);
    });
    
    card.querySelector('.delete-paper-class-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm(`Are you sure you want to delete "${paper.title}"? This will also delete all submissions for this paper.`)) {
            deletePaperClassPaper(id);
        }
    });

    return card;
}

//delete paper class paper
async function deletePaperClassPaper(paperId) {
    try {
        if (!confirm('Are you absolutely sure? This will permanently delete the paper and all its submissions.')) {
            return;
        }

        // Show loading state
        const card = document.querySelector(`.paper-class-paper-card[data-paper-id="${paperId}"]`);
        const deleteBtn = document.getElementById('deletePaperClassBtn');
        
        if (card) {
            card.querySelector('.delete-paper-class-btn').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            card.querySelector('.delete-paper-class-btn').disabled = true;
        }
        
        if (deleteBtn) {
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
            deleteBtn.disabled = true;
        }

        // Delete from database
        await database.ref(`paperClassPapers/${paperId}`).remove();
        
        // Delete submissions
        await database.ref(`paperClassSubmissions/${paperId}`).remove();
        
        // Delete storage files
        const storageRef = storage.ref();
        await Promise.all([
            storageRef.child(`paperClassPapers/${paperId}/paper-sinhala.pdf`).delete(),
            storageRef.child(`paperClassPapers/${paperId}/paper-english.pdf`).delete(),
            storageRef.child(`paperClassPapers/${paperId}/answers.pdf`).delete()
        ].map(p => p.catch(e => console.log('Error deleting file:', e))));

        // Remove the card from UI
        if (card) {
            card.remove();
        }

        // Show success message
        alert('Paper and all its submissions have been deleted successfully.');
        
        // Reload counts
        loadPaperClassPapers();

    } catch (error) {
        console.error('Error deleting paper:', error);
        alert(`Error: ${error.message}`);
        
        // Reset button states
        const card = document.querySelector(`.paper-class-paper-card[data-paper-id="${paperId}"]`);
        if (card) {
            card.querySelector('.delete-paper-class-btn').innerHTML = '<i class="bi bi-trash"></i> Delete';
            card.querySelector('.delete-paper-class-btn').disabled = false;
        }
        
        const deleteBtn = document.getElementById('deletePaperClassBtn');
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete Paper';
            deleteBtn.disabled = false;
        }
    }
}

// Update Paper Class tab badges
function updatePaperClassTabBadges(active, upcoming, closed) {
    document.getElementById('paperClassActive-tab').innerHTML = `Active ${active > 0 ? `<span class="badge bg-primary ms-2">${active}</span>` : ''}`;
    document.getElementById('paperClassUpcoming-tab').innerHTML = `Upcoming ${upcoming > 0 ? `<span class="badge bg-primary ms-2">${upcoming}</span>` : ''}`;
    document.getElementById('paperClassClosed-tab').innerHTML = `Closed ${closed > 0 ? `<span class="badge bg-primary ms-2">${closed}</span>` : ''}`;
}

// Show Paper Class empty state
function showPaperClassEmptyState(containerId, count) {
    if (count === 0) {
        document.getElementById(containerId).innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                <p class="text-muted">No papers found</p>
            </div>
        `;
    }
}

// View Paper Class paper details
async function viewPaperClassPaperDetails(paperId) {
    try {
        const [paperSnapshot, isAvailable] = await Promise.all([
            database.ref(`paperClassPapers/${paperId}`).once('value'),
            checkPaperClassPaperAvailability(paperId)
        ]);
        
        const paper = paperSnapshot.val();
        if (!paper) throw new Error('Paper not found');

        const openTime = new Date(paper.openTime);
        const closeTime = new Date(paper.closeTime);
        const now = new Date();
        let status = now < openTime ? 'Upcoming' : now > closeTime ? 'Closed' : 'Active';

        let html = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${paper.title}</h4>
                    <p class="mb-1"><strong>Status:</strong> 
                        <span class="badge ${status === 'Active' ? 'bg-success' : status === 'Upcoming' ? 'bg-warning' : 'bg-secondary'}">
                            ${status}
                        </span>
                    </p>
                    <p class="mb-1"><strong>Available:</strong> ${openTime.toLocaleString()} to ${closeTime.toLocaleString()}</p>
        `;

        if (status !== 'Active') {
            html += `
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> This paper is not currently available for access.
                    ${status === 'Upcoming' ? 'It will become available at the specified open time.' : 'The submission period has ended.'}
                </div>
            `;
        }

        html += `
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Time Remaining</h6>
                            <div id="paperClassTimeRemaining"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Only show access buttons if paper is active
        if (status === 'Active') {
            html += `
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Paper PDF (Sinhala)</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.pdfUrlSinhala}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Sinhala Paper
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Paper PDF (English)</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.pdfUrlEnglish}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download English Paper
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Answer Key</h5></div>
                        <div class="card-body text-center">
                            <a href="${paper.answerKeyUrl}" target="_blank" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Answer Key
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        html += `
            <div class="mt-4">
                <h5>Paper Details</h5>
                <table class="table table-bordered">
                    <tr><th>Year</th><td>${paper.year}</td></tr>
                    <tr><th>Paper Number</th><td>${paper.paperNumber}</td></tr>
                    <tr><th>Subject</th><td>${paper.subject}</td></tr>
                    <tr><th>Medium</th><td>${paper.medium}</td></tr>
                    <tr><th>Total Marks</th><td>${paper.totalMarks}</td></tr>
                    <tr><th>Total Questions</th><td>${Object.keys(paper.questions).length}</td></tr>
                </table>
            </div>
            
            <div class="mt-4">
                <h5>Questions Summary</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Type</th>
                            <th>Marks</th>
                            <th>Correct Answer (MCQ)</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Add questions summary
        Object.entries(paper.questions).forEach(([num, q]) => {
            html += `
                <tr>
                    <td>${num}</td>
                    <td>${q.type === 'mcq' ? 'MCQ' : 'Essay'}</td>
                    <td>${q.marks}</td>
                    <td>${q.type === 'mcq' ? q.answer : 'N/A'}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
        document.getElementById('paperClassPaperDetails').innerHTML = html;
        
        // Store paperId for copy link function
        document.getElementById('copyPaperClassLinkBtn').setAttribute('data-paper-id', paperId);
        
        // Update time remaining counter if paper is active
        if (status === 'Active') {
            updatePaperClassTimeRemaining(closeTime);
            const timer = setInterval(() => updatePaperClassTimeRemaining(closeTime), 1000);
            
            // Clear interval when modal is closed
            document.getElementById('paperClassPaperModal').addEventListener('hidden.bs.modal', () => {
                clearInterval(timer);
            });
        }

        const modal = new bootstrap.Modal(document.getElementById('paperClassPaperModal'));
        modal.show();

        document.getElementById('deletePaperClassBtn').addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('paperClassPaperModal'));
            modal.hide();
    
            if (confirm(`Are you sure you want to delete this paper? This will also delete all submissions for this paper.`)) {
                deletePaperClassPaper(paperId);
            }
        });    

    } catch (error) {
        console.error('Error viewing paper class paper:', error);
        alert(`Error: ${error.message}`);
    }
}

function checkPaperClassPaperAvailability(paperId) {
    return database.ref(`paperClassPapers/${paperId}`).once('value').then(snapshot => {
        const paper = snapshot.val();
        if (!paper) return false;
        
        const now = new Date().getTime();
        const openTime = new Date(paper.openTime).getTime();
        const closeTime = new Date(paper.closeTime).getTime();
        
        return now >= openTime && now <= closeTime;
    });
}

function updatePaperClassTimeRemaining(closeTime) {
    const now = new Date();
    const end = new Date(closeTime);
    const diff = end - now;
    
    if (diff <= 0) {
        document.getElementById('paperClassTimeRemaining').innerHTML = 'Time expired';
        return;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('paperClassTimeRemaining').innerHTML = `
        ${hours}h ${minutes}m ${seconds}s remaining
    `;
}

// Copy paper class link
document.getElementById('copyPaperClassLinkBtn').addEventListener('click', function() {
    const paperId = this.getAttribute('data-paper-id');
    if (!paperId) {
        alert('Paper ID not found');
        return;
    }
    
    const paperLink = `${window.location.origin}/paper-class-student.html?paperId=${paperId}`;
    
    navigator.clipboard.writeText(paperLink).then(() => {
        // Show feedback
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
        
        // Revert after 2 seconds
        setTimeout(() => {
            this.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy link:', err);
        
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = paperLink;
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
            
            // Revert after 2 seconds
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        } catch (err) {
            alert('Failed to copy link. Please try again or copy manually.');
        }
        
        document.body.removeChild(textArea);
    });
});

// Load Paper Class submissions
async function loadPaperClassSubmissionPapers() {
    const yearFilter = document.getElementById('paperClassSubmissionYearFilter').value;
    const monthFilter = document.getElementById('paperClassSubmissionMonthFilter').value;
    
    try {
        const snapshot = await database.ref('paperClassPapers').once('value');
        const papers = snapshot.val() || {};
        const container = document.getElementById('paperClassSubmissionPaperCards');
        
        // Clear container
        container.innerHTML = '';
        
        let papersArray = Object.entries(papers).map(([id, paper]) => ({ id, ...paper }));
        
        // Apply filters
        if (yearFilter) {
            papersArray = papersArray.filter(paper => paper.year === yearFilter);
        }
        
        if (monthFilter) {
            papersArray = papersArray.filter(paper => {
                const paperDate = new Date(paper.createdAt || paper.openTime);
                return (paperDate.getMonth() + 1) === parseInt(monthFilter);
            });
        }
        
        if (papersArray.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No papers found</p>
                </div>
            `;
            return;
        }
        
        // Sort by creation date (newest first)
        papersArray.sort((a, b) => {
            const dateA = new Date(a.createdAt || a.openTime).getTime();
            const dateB = new Date(b.createdAt || b.openTime).getTime();
            return dateB - dateA;
        });
        
        // Create paper cards
        for (const paper of papersArray) {
            // Get submission count
            const submissionsSnapshot = await database.ref(`paperClassSubmissions/${paper.id}`).once('value');
            const submissionCount = submissionsSnapshot.exists() ? Object.keys(submissionsSnapshot.val()).length : 0;
            
            const card = createPaperClassSubmissionPaperCard(paper.id, paper, submissionCount);
            container.appendChild(card);
        }
        
    } catch (error) {
        console.error('Error loading paper class submission papers:', error);
        document.getElementById('paperClassSubmissionPaperCards').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                Error loading papers
            </div>
        `;
    }
}

// Create Paper Class submission paper card
function createPaperClassSubmissionPaperCard(id, paper, submissionCount) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 paper-class-submission-paper-card';
    card.setAttribute('data-paper-id', id);
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${paper.title}</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Year: ${paper.year}</span>
                    <span class="text-muted">Paper: ${paper.paperNumber}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-primary">
                        ${submissionCount} submission${submissionCount !== 1 ? 's' : ''}
                    </span>
                    <small class="text-muted">
                        ${new Date(paper.createdAt || paper.openTime).toLocaleDateString()}
                    </small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-paper-class-submissions-btn">
                    <i class="bi bi-list-check"></i> View Submissions
                </button>
            </div>
        </div>
    `;
    
    // Add event listener for view submissions
    card.querySelector('.view-paper-class-submissions-btn').addEventListener('click', () => {
        loadPaperClassSubmissions(id, paper.title);
    });
    
    return card;
}

// Load Paper Class submissions for a paper
async function loadPaperClassSubmissions(paperId, paperTitle) {
    try {
        // Show loading state
        const tbody = document.getElementById('paperClassSubmissionsList');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border"></div></td></tr>';
        
        // Set paper title
        document.getElementById('selectedPaperClassPaperTitle').textContent = `Submissions: ${paperTitle}`;
        
        // Show submissions list and hide paper cards
        document.getElementById('paperClassSubmissionPaperCards').style.display = 'none';
        document.getElementById('paperClassSubmissionsListCard').style.display = 'block';
        
        // Load submissions
        const snapshot = await database.ref(`paperClassSubmissions/${paperId}`).once('value');
        const submissions = snapshot.val() || {};
        
        tbody.innerHTML = '';
        
        if (Object.keys(submissions).length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        // Convert to array and sort by timestamp (newest first)
        const submissionsArray = Object.entries(submissions).map(([nic, submission]) => ({
            nic, ...submission
        })).sort((a, b) => b.timestamp - a.timestamp);
        
        // Display submissions
        submissionsArray.forEach(sub => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.name}</td>
                <td>${sub.nic}</td>
                <td>${sub.district}</td>
                <td>${sub.class}</td>
                <td>${sub.mcqScore || '0'}/${sub.totalMcqMarks || '0'}</td>
                <td>${new Date(sub.timestamp).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-paper-class-submission" 
                            data-paper="${paperId}" data-nic="${sub.nic}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add click event to view submission details
            row.querySelector('.view-paper-class-submission').addEventListener('click', () => {
                viewPaperClassSubmissionDetails(paperId, sub.nic);
            });
        });
        
    } catch (error) {
        console.error('Error loading paper class submissions:', error);
        document.getElementById('paperClassSubmissionsList').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger">Error loading submissions</td></tr>
        `;
        
        // Make sure back button is still visible
        document.getElementById('paperClassSubmissionsListCard').style.display = 'block';
    }
}

// Back to Paper Class papers button
document.getElementById('backToPaperClassPapersBtn').addEventListener('click', function() {
    // Show the paper cards container
    document.getElementById('paperClassSubmissionPaperCards').style.display = 'flex';
    
    // Hide the submissions table
    document.getElementById('paperClassSubmissionsListCard').style.display = 'none';
    
    // Reset any scroll positions
    window.scrollTo(0, 0);
});

// Filter Paper Class submissions button
document.getElementById('paperClassSubmissionFilterBtn').addEventListener('click', loadPaperClassSubmissionPapers);

// View Paper Class submission details
async function viewPaperClassSubmissionDetails(paperId, nic) {
    try {
        const [paperSnapshot, submissionSnapshot] = await Promise.all([
            database.ref(`paperClassPapers/${paperId}`).once('value'),
            database.ref(`paperClassSubmissions/${paperId}/${nic}`).once('value')
        ]);
        
        const paper = paperSnapshot.val();
        const submission = submissionSnapshot.val();
        
        if (!paper || !submission) throw new Error('Submission details not found');
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Paper: ${paper.title}</h6>
                    <h6>Student: ${submission.name} (${nic})</h6>
                </div>
                <div class="col-md-6 text-end">
                    <h5>MCQ Score: ${submission.mcqScore || '0'} / ${submission.totalMcqMarks || '0'}</h5>
                    <h6>Submitted: ${new Date(submission.timestamp).toLocaleString()}</h6>
                </div>
            </div>
        `;
        
        // Add MCQ answers if available
        if (submission.mcqAnswers) {
            html += `
                <div class="mb-4">
                    <h5>MCQ Answers</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Correct Answer</th>
                                <th>Student's Answer</th>
                                <th>Result</th>
                                <th>Marks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(submission.mcqAnswers).forEach(([qNum, answer]) => {
                const question = paper.questions[qNum];
                if (!question || question.type !== 'mcq') return;
                
                const isCorrect = answer === question.answer;
                const marksEarned = isCorrect ? question.marks : 0;
                
                html += `
                    <tr>
                        <td>${qNum}</td>
                        <td>${question.answer}</td>
                        <td>${answer}</td>
                        <td class="${isCorrect ? 'text-success' : 'text-danger'}">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </td>
                        <td>${marksEarned}/${question.marks}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
        }
        
        // Add essay answers if available
        if (submission.essayAnswersUrl) {
            html += `
                <div class="mb-4">
                    <h5>Essay Answers</h5>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Student has uploaded their essay answers as a PDF file.
                    </div>
                    <div class="text-center">
                        <a href="${submission.essayAnswersUrl}" target="_blank" class="btn btn-primary">
                            <i class="bi bi-download"></i> Download Essay Answers
                        </a>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('paperClassSubmissionDetails').innerHTML = html;
        new bootstrap.Modal(document.getElementById('paperClassSubmissionModal')).show();

    } catch (error) {
        console.error('Error viewing paper class submission:', error);
        alert(`Error: ${error.message}`);
    }
}

// Initialize Paper Class section
function initPaperClassSection() {
    // Add year filter event listener
    document.getElementById('paperClassYearFilter').addEventListener('change', loadPaperClassPapers);
}

function showPaperClassEmptyState(containerId, count) {
    if (count === 0) {
        document.getElementById(containerId).innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                <p class="text-muted">No papers found</p>
            </div>
        `;
    }
}

function updatePaperClassTabBadges(active, upcoming, closed) {
    document.getElementById('paperClassActive-tab').innerHTML = `Active ${active > 0 ? `<span class="badge bg-primary ms-2">${active}</span>` : ''}`;
    document.getElementById('paperClassUpcoming-tab').innerHTML = `Upcoming ${upcoming > 0 ? `<span class="badge bg-primary ms-2">${upcoming}</span>` : ''}`;
    document.getElementById('paperClassClosed-tab').innerHTML = `Closed ${closed > 0 ? `<span class="badge bg-primary ms-2">${closed}</span>` : ''}`;
}


//====================================
//general Forms
//====================================

// Question templates for different question types
const questionTemplates = {
    'short-answer': {
        title: 'Short Answer',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="short-answer">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Short Answer" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <input type="text" class="form-control" placeholder="Short answer text" disabled>
                <div class="form-text">Respondents will see a single-line text field</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'paragraph': {
        title: 'Paragraph',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="paragraph">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Paragraph" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <textarea class="form-control" placeholder="Long answer text" rows="3" disabled></textarea>
                <div class="form-text">Respondents will see a multi-line text field</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'multiple-choice': {
        title: 'Multiple Choice',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="multiple-choice">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Multiple Choice" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="options-container mb-2">
                    <div class="option-item mb-2 d-flex align-items-center">
                        <input type="radio" class="form-check-input me-2" disabled>
                        <input type="text" class="form-control option-text" placeholder="Option 1" value="Option 1">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="option-item mb-2 d-flex align-items-center">
                        <input type="radio" class="form-check-input me-2" disabled>
                        <input type="text" class="form-control option-text" placeholder="Option 2" value="Option 2">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary add-option">Add Option</button>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="includeOtherOption">
                    <label class="form-check-label" for="includeOtherOption">Include "Other" option</label>
                </div>
                <div class="form-text">Respondents will select one option from a list</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'checkbox': {
        title: 'Checkbox',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="checkbox">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Checkbox" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="options-container mb-2">
                    <div class="option-item mb-2 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" disabled>
                        <input type="text" class="form-control option-text" placeholder="Option 1" value="Option 1">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="option-item mb-2 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" disabled>
                        <input type="text" class="form-control option-text" placeholder="Option 2" value="Option 2">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary add-option">Add Option</button>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="includeOtherOption">
                    <label class="form-check-label" for="includeOtherOption">Include "Other" option</label>
                </div>
                <div class="form-text">Respondents can select multiple options</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'dropdown': {
        title: 'Dropdown',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="dropdown">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Dropdown" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="options-container mb-2">
                    <div class="option-item mb-2 d-flex align-items-center">
                        <input type="text" class="form-control option-text" placeholder="Option 1" value="Option 1">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="option-item mb-2 d-flex align-items-center">
                        <input type="text" class="form-control option-text" placeholder="Option 2" value="Option 2">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary add-option">Add Option</button>
                <div class="form-text">Respondents will select one option from a dropdown menu</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'file-upload': {
        title: 'File Upload',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="file-upload">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="File Upload" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Allowed File Types</label>
                    <select class="form-select file-types" multiple>
                        <option value="pdf" selected>PDF</option>
                        <option value="doc">Word Documents</option>
                        <option value="image">Images</option>
                        <option value="spreadsheet">Spreadsheets</option>
                        <option value="video">Videos</option>
                        <option value="audio">Audio</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Maximum File Size (MB)</label>
                    <input type="number" class="form-control max-file-size" value="10" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Maximum Number of Files</label>
                    <input type="number" class="form-control max-files" value="1" min="1">
                </div>
                <div class="form-text">Respondents will be able to upload files</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'linear-scale': {
        title: 'Linear Scale',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="linear-scale">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Linear Scale" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Minimum Value</label>
                        <input type="number" class="form-control min-value" value="1" min="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Maximum Value</label>
                        <input type="number" class="form-control max-value" value="5" min="2">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Minimum Label (optional)</label>
                        <input type="text" class="form-control min-label" placeholder="e.g. Strongly Disagree">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Maximum Label (optional)</label>
                        <input type="text" class="form-control max-label" placeholder="e.g. Strongly Agree">
                    </div>
                </div>
                <div class="form-text">Respondents will select a value on a scale</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'rating': {
        title: 'Rating',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="rating">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Rating" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Scale</label>
                    <select class="form-select rating-scale">
                        <option value="5">5 (Excellent to Poor)</option>
                        <option value="10">10 (1 to 10)</option>
                        <option value="stars">Star Rating</option>
                        <option value="smileys">Smiley Rating</option>
                    </select>
                </div>
                <div class="form-text">Respondents will provide a rating</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'multiple-choice-grid': {
        title: 'Multiple Choice Grid',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="multiple-choice-grid">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Multiple Choice Grid" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Rows</label>
                    <div class="rows-container mb-2">
                        <div class="row-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control row-text" placeholder="Row 1" value="Row 1">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-row"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="row-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control row-text" placeholder="Row 2" value="Row 2">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-row"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary add-row">Add Row</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Columns</label>
                    <div class="columns-container mb-2">
                        <div class="column-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control column-text" placeholder="Column 1" value="Option 1">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-column"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="column-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control column-text" placeholder="Column 2" value="Option 2">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-column"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary add-column">Add Column</button>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="limitOneResponsePerColumn">
                    <label class="form-check-label" for="limitOneResponsePerColumn">Limit one response per column</label>
                </div>
                <div class="form-text">Respondents will select one option per row from a grid</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
        'checkbox-grid': {
        title: 'Checkbox Grid',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="checkbox-grid">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Checkbox Grid" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Rows</label>
                    <div class="rows-container mb-2">
                        <div class="row-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control row-text" placeholder="Row 1" value="Row 1">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-row"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="row-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control row-text" placeholder="Row 2" value="Row 2">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-row"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary add-row">Add Row</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Columns</label>
                    <div class="columns-container mb-2">
                        <div class="column-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control column-text" placeholder="Column 1" value="Option 1">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-column"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="column-item mb-2 d-flex align-items-center">
                            <input type="text" class="form-control column-text" placeholder="Column 2" value="Option 2">
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-column"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary add-column">Add Column</button>
                </div>
                <div class="form-text">Respondents can select multiple options per row from a grid</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'date': {
        title: 'Date',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="date">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Date" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Date Format</label>
                    <select class="form-select date-format">
                        <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                        <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                        <option value="yyyy/mm/dd">YYYY/MM/DD</option>
                    </select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeTime">
                    <label class="form-check-label" for="includeTime">Include time</label>
                </div>
                <div class="form-text">Respondents will select a date</div>
            </div>
        `,
        requiredHtml: 'Yes'
    },
    'time': {
        title: 'Time',
        html: `
            <div class="question-item mb-4 p-3 border rounded" data-type="time">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control question-title" placeholder="Question" value="Time" required>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item toggle-required" href="#">Required: <span>No</span></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-question" href="#"><i class="bi bi-trash text-danger"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Time Format</label>
                    <select class="form-select time-format">
                        <option value="12hour">12-hour clock</option>
                        <option value="24hour">24-hour clock</option>
                    </select>
                </div>
                <div class="form-text">Respondents will select a time</div>
            </div>
        `,
        requiredHtml: 'Yes'
    }
};

// Add question event listeners
document.querySelectorAll('.dropdown-menu a[data-type]').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const type = this.getAttribute('data-type');
        addQuestion(type);
    });
});

// Function to add a new question
function addQuestion(type) {
    const template = questionTemplates[type];
    if (!template) return;
    
    const container = document.getElementById('formQuestionsContainer');
    const questionDiv = document.createElement('div');
    questionDiv.innerHTML = template.html;
    
    // Set required state
    const requiredSpan = questionDiv.querySelector('.toggle-required span');
    if (requiredSpan) {
        requiredSpan.textContent = 'No';
    }
    
    container.appendChild(questionDiv);
    
    // Initialize any dynamic elements
    initQuestionElements(questionDiv);
    
    // Scroll to the new question
    questionDiv.scrollIntoView({ behavior: 'smooth' });
}

// Initialize question elements (options, rows, columns, etc.)
function initQuestionElements(questionDiv) {
    const type = questionDiv.getAttribute('data-type');
    
    // Add option button
    if (questionDiv.querySelector('.add-option')) {
        questionDiv.querySelector('.add-option').addEventListener('click', function() {
            const optionsContainer = questionDiv.querySelector('.options-container');
            const optionCount = optionsContainer.querySelectorAll('.option-item').length + 1;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item mb-2 d-flex align-items-center';
            
            if (type === 'multiple-choice' || type === 'checkbox') {
                optionDiv.innerHTML = `
                    <input type="${type === 'multiple-choice' ? 'radio' : 'checkbox'}" class="form-check-input me-2" disabled>
                    <input type="text" class="form-control option-text" placeholder="Option ${optionCount}" value="Option ${optionCount}">
                    <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                `;
            } else {
                optionDiv.innerHTML = `
                    <input type="text" class="form-control option-text" placeholder="Option ${optionCount}" value="Option ${optionCount}">
                    <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                `;
            }
            
            optionsContainer.appendChild(optionDiv);
            
            // Add remove event
            optionDiv.querySelector('.remove-option').addEventListener('click', function() {
                if (optionsContainer.querySelectorAll('.option-item').length > 1) {
                    optionDiv.remove();
                } else {
                    alert('At least one option is required');
                }
            });
        });
    }
    
    // Add row button (for grids)
    if (questionDiv.querySelector('.add-row')) {
        questionDiv.querySelector('.add-row').addEventListener('click', function() {
            const rowsContainer = questionDiv.querySelector('.rows-container');
            const rowCount = rowsContainer.querySelectorAll('.row-item').length + 1;
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row-item mb-2 d-flex align-items-center';
            rowDiv.innerHTML = `
                <input type="text" class="form-control row-text" placeholder="Row ${rowCount}" value="Row ${rowCount}">
                <button class="btn btn-sm btn-outline-danger ms-2 remove-row"><i class="bi bi-trash"></i></button>
            `;
            
            rowsContainer.appendChild(rowDiv);
            
            // Add remove event
            rowDiv.querySelector('.remove-row').addEventListener('click', function() {
                if (rowsContainer.querySelectorAll('.row-item').length > 1) {
                    rowDiv.remove();
                } else {
                    alert('At least one row is required');
                }
            });
        });
    }
    
    // Add column button (for grids)
    if (questionDiv.querySelector('.add-column')) {
        questionDiv.querySelector('.add-column').addEventListener('click', function() {
            const columnsContainer = questionDiv.querySelector('.columns-container');
            const columnCount = columnsContainer.querySelectorAll('.column-item').length + 1;
            
            const columnDiv = document.createElement('div');
            columnDiv.className = 'column-item mb-2 d-flex align-items-center';
            columnDiv.innerHTML = `
                <input type="text" class="form-control column-text" placeholder="Column ${columnCount}" value="Option ${columnCount}">
                <button class="btn btn-sm btn-outline-danger ms-2 remove-column"><i class="bi bi-trash"></i></button>
            `;
            
            columnsContainer.appendChild(columnDiv);
            
            // Add remove event
            columnDiv.querySelector('.remove-column').addEventListener('click', function() {
                if (columnsContainer.querySelectorAll('.column-item').length > 1) {
                    columnDiv.remove();
                } else {
                    alert('At least one column is required');
                }
            });
        });
    }
    
    // Toggle required
    if (questionDiv.querySelector('.toggle-required')) {
        questionDiv.querySelector('.toggle-required').addEventListener('click', function(e) {
            e.preventDefault();
            const span = this.querySelector('span');
            span.textContent = span.textContent === 'No' ? 'Yes' : 'No';
        });
    }
    
    // Delete question
    if (questionDiv.querySelector('.delete-question')) {
        questionDiv.querySelector('.delete-question').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this question?')) {
                questionDiv.remove();
            }
        });
    }
    
    // Initialize existing remove buttons
    questionDiv.querySelectorAll('.remove-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const optionsContainer = questionDiv.querySelector('.options-container');
            if (optionsContainer.querySelectorAll('.option-item').length > 1) {
                this.closest('.option-item').remove();
            } else {
                alert('At least one option is required');
            }
        });
    });
    
    questionDiv.querySelectorAll('.remove-row').forEach(btn => {
        btn.addEventListener('click', function() {
            const rowsContainer = questionDiv.querySelector('.rows-container');
            if (rowsContainer.querySelectorAll('.row-item').length > 1) {
                this.closest('.row-item').remove();
            } else {
                alert('At least one row is required');
            }
        });
    });
    
    questionDiv.querySelectorAll('.remove-column').forEach(btn => {
        btn.addEventListener('click', function() {
            const columnsContainer = questionDiv.querySelector('.columns-container');
            if (columnsContainer.querySelectorAll('.column-item').length > 1) {
                this.closest('.column-item').remove();
            } else {
                alert('At least one column is required');
            }
        });
    });
}

// Form templates
const formTemplates = {
    survey: {
        name: "Survey Template",
        questions: [
            {
                type: "short-answer",
                title: "What is your name?",
                required: true
            },
            {
                type: "multiple-choice",
                title: "How satisfied are you with our service?",
                options: ["Very satisfied", "Satisfied", "Neutral", "Unsatisfied", "Very unsatisfied"],
                required: true
            },
            {
                type: "paragraph",
                title: "Any additional comments?",
                required: false
            }
        ]
    },
    feedback: {
        name: "Feedback Form",
        questions: [
            {
                type: "short-answer",
                title: "Your name (optional)",
                required: false
            },
            {
                type: "rating",
                title: "Rate your experience",
                required: true
            },
            {
                type: "paragraph",
                title: "What did you like most?",
                required: false
            },
            {
                type: "paragraph",
                title: "What can we improve?",
                required: false
            }
        ]
    },
    quiz: {
        name: "Quiz Template",
        questions: [
            {
                type: "multiple-choice",
                title: "What is the capital of France?",
                options: ["London", "Paris", "Berlin", "Madrid"],
                correctAnswer: "Paris",
                required: true
            },
            {
                type: "short-answer",
                title: "What is 2 + 2?",
                correctAnswer: "4",
                required: true
            }
        ]
    }
};

// Apply form template
function applyFormTemplate(template) {
    const container = document.getElementById('formQuestionsContainer');
    container.innerHTML = '';
    
    template.questions.forEach(question => {
        addQuestion(question.type);
        const questionDiv = container.lastChild;
        
        // Set title
        questionDiv.querySelector('.question-title').value = question.title;
        
        // Set required
        if (question.required && questionDiv.querySelector('.toggle-required span')) {
            questionDiv.querySelector('.toggle-required span').textContent = 'Yes';
        }
        
        // Set options for multiple choice
        if (question.options && questionDiv.querySelector('.options-container')) {
            const optionsContainer = questionDiv.querySelector('.options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-item mb-2 d-flex align-items-center';
                
                if (question.type === 'multiple-choice' || question.type === 'checkbox') {
                    optionDiv.innerHTML = `
                        <input type="${question.type === 'multiple-choice' ? 'radio' : 'checkbox'}" class="form-check-input me-2" disabled>
                        <input type="text" class="form-control option-text" placeholder="Option ${index + 1}" value="${option}">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    `;
                } else {
                    optionDiv.innerHTML = `
                        <input type="text" class="form-control option-text" placeholder="Option ${index + 1}" value="${option}">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    `;
                }
                
                optionsContainer.appendChild(optionDiv);
                
                // Set correct answer if exists
                if (question.correctAnswer && option === question.correctAnswer && questionDiv.querySelector('.question-answer')) {
                    questionDiv.querySelector('.question-answer').value = (index + 1).toString();
                }
            });
            
            // Initialize remove buttons
            optionDiv.querySelectorAll('.remove-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (optionsContainer.querySelectorAll('.option-item').length > 1) {
                        this.closest('.option-item').remove();
                    } else {
                        alert('At least one option is required');
                    }
                });
            });
        }
    });
}

// Template buttons
document.getElementById('templateSurveyBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyFormTemplate(formTemplates.survey);
});

document.getElementById('templateFeedbackBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyFormTemplate(formTemplates.feedback);
});

document.getElementById('templateQuizBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyFormTemplate(formTemplates.quiz);
});

// Create form
document.getElementById('createGeneralFormForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const createBtn = document.getElementById('createFormBtn');
        createBtn.disabled = true;
        createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

        const title = document.getElementById('formTitle').value.trim();
        const description = document.getElementById('formDescription').value.trim();
        const access = document.getElementById('formAccess').value;
        const requireLogin = document.getElementById('formRequireLogin').checked;
        const closeTime = document.getElementById('formCloseTime').value;
        
        // Validate inputs
        if (!title) {
            throw new Error('Form title is required');
        }
        
        // Get all questions
        const questions = [];
        const questionItems = document.querySelectorAll('#formQuestionsContainer .question-item');
        
        if (questionItems.length === 0) {
            throw new Error('Please add at least one question');
        }
        
        questionItems.forEach((item, index) => {
            const type = item.getAttribute('data-type');
            const title = item.querySelector('.question-title').value.trim();
            const isRequired = item.querySelector('.toggle-required span')?.textContent === 'Yes';
            
            if (!title) {
                throw new Error(`Question ${index + 1} must have a title`);
            }
            
            const question = {
                type,
                title,
                required: isRequired,
                order: index + 1
            };
            
            // Add type-specific properties
            switch (type) {
                case 'multiple-choice':
                case 'checkbox':
                case 'dropdown':
                    const options = [];
                    item.querySelectorAll('.option-text').forEach(option => {
                        options.push(option.value.trim());
                    });
                    question.options = options;
                    
                    if (item.querySelector('#includeOtherOption')?.checked) {
                        question.includeOther = true;
                    }
                    break;
                    
                case 'file-upload':
                    const fileTypes = [];
                    item.querySelectorAll('.file-types option:checked').forEach(option => {
                        fileTypes.push(option.value);
                    });
                    question.fileTypes = fileTypes;
                    question.maxSize = item.querySelector('.max-file-size').value;
                    question.maxFiles = item.querySelector('.max-files').value;
                    break;
                    
                case 'linear-scale':
                    question.minValue = item.querySelector('.min-value').value;
                    question.maxValue = item.querySelector('.max-value').value;
                    question.minLabel = item.querySelector('.min-label').value;
                    question.maxLabel = item.querySelector('.max-label').value;
                    break;
                    
                case 'rating':
                    question.scale = item.querySelector('.rating-scale').value;
                    break;
                    
                case 'multiple-choice-grid':
                case 'checkbox-grid':
                    const rows = [];
                    item.querySelectorAll('.row-text').forEach(row => {
                        rows.push(row.value.trim());
                    });
                    question.rows = rows;
                    
                    const columns = [];
                    item.querySelectorAll('.column-text').forEach(col => {
                        columns.push(col.value.trim());
                    });
                    question.columns = columns;
                    
                    if (type === 'multiple-choice-grid' && item.querySelector('#limitOneResponsePerColumn')?.checked) {
                        question.limitOnePerColumn = true;
                    }
                    break;
                    
                case 'date':
                    question.format = item.querySelector('.date-format').value;
                    question.includeTime = item.querySelector('#includeTime')?.checked || false;
                    break;
                    
                case 'time':
                    question.format = item.querySelector('.time-format').value;
                    break;
            }
            
            questions.push(question);
        });
        
        // Generate form ID
        const formId = `form-${title.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
        
        // Save form data
        await database.ref(`generalForms/${formId}`).set({
            title,
            description,
            questions,
            access,
            requireLogin,
            closeTime: closeTime ? new Date(closeTime).toISOString() : null,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'active'
        });

        alert('Form created successfully!');
        document.getElementById('createGeneralFormForm').reset();
        document.getElementById('formQuestionsContainer').innerHTML = '';
        
        // Reload forms list
        loadGeneralForms();

    } catch (error) {
        console.error('Error creating form:', error);
        alert(`Error: ${error.message}`);
    } finally {
        const createBtn = document.getElementById('createFormBtn');
        createBtn.disabled = false;
        createBtn.textContent = 'Create Form';
    }
});

// Load general forms
async function loadGeneralForms(status = null) {
    try {
        // Show loading state for all tabs
        ['activeFormsContainer', 'upcomingFormsContainer', 'closedFormsContainer'].forEach(id => {
            document.getElementById(id).innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
        });

        const snapshot = await database.ref('generalForms').once('value');
        const forms = snapshot.val() || {};
        
        // Clear containers
        const clearContainer = (id) => {
            const container = document.getElementById(id);
            container.innerHTML = '';
        };
        
        clearContainer('activeFormsContainer');
        clearContainer('upcomingFormsContainer');
        clearContainer('closedFormsContainer');

        let activeCount = 0;
        let upcomingCount = 0;
        let closedCount = 0;
        const now = new Date().getTime();

        // Process each form
        for (const [id, form] of Object.entries(forms)) {
            // Determine form status
            let formStatus = 'active';
            if (form.closeTime) {
                const closeTime = new Date(form.closeTime).getTime();
                if (now > closeTime) {
                    formStatus = 'closed';
                }
            }
            
            // Skip if we're filtering by status and this form doesn't match
            if (status && formStatus !== status) continue;
            
            // Create form card
            const card = createFormCard(id, form, formStatus);
            
            // Add to appropriate container
            if (formStatus === 'active') {
                document.getElementById('activeFormsContainer').appendChild(card);
                activeCount++;
            } else if (formStatus === 'closed') {
                document.getElementById('closedFormsContainer').appendChild(card);
                closedCount++;
            }
        }
        
        // Update tab badges
        updateFormTabBadges(activeCount, upcomingCount, closedCount);
        
        // Show empty state if no forms
        showFormEmptyState('activeFormsContainer', activeCount);
        showFormEmptyState('upcomingFormsContainer', upcomingCount);
        showFormEmptyState('closedFormsContainer', closedCount);

    } catch (error) {
        console.error('Error loading forms:', error);
        const errorHtml = '<div class="col-12 text-center text-danger py-5">Error loading forms</div>';
        document.getElementById('activeFormsContainer').innerHTML = errorHtml;
        document.getElementById('upcomingFormsContainer').innerHTML = errorHtml;
        document.getElementById('closedFormsContainer').innerHTML = errorHtml;
    }
}

// Create form card
function createFormCard(id, form, status) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 form-card';
    card.setAttribute('data-form-id', id);
    
    // Add year and month data attributes for filtering
    const createdAt = new Date(form.createdAt);
    card.setAttribute('data-year', createdAt.getFullYear().toString());
    card.setAttribute('data-month', (createdAt.getMonth() + 1).toString());
    
    const questionCount = form.questions?.length || 0;
    const createdAtFormatted = createdAt.toLocaleDateString();
    const closeTime = form.closeTime ? new Date(form.closeTime).toLocaleString() : 'No close time';
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${form.title}</h5>
                <p class="card-text text-muted">${form.description || 'No description'}</p>
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge bg-${status === 'active' ? 'success' : 'secondary'}">
                        ${status === 'active' ? 'Active' : 'Closed'}
                    </span>
                    <small class="text-muted">${questionCount} question${questionCount !== 1 ? 's' : ''}</small>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Access: ${form.access === 'students' ? 'Students only' : 'Public'}</small>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Closes: ${closeTime}</small>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Created: ${createdAtFormatted}</small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-form-btn">
                    <i class="bi bi-eye"></i> View
                </button>
                <button class="btn btn-sm btn-outline-danger ms-2 delete-form-btn">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
    
    // Add event listeners
    card.querySelector('.view-form-btn').addEventListener('click', () => {
        viewFormDetails(id);
    });
    
    card.querySelector('.delete-form-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm(`Are you sure you want to delete "${form.title}"? This will also delete all submissions for this form.`)) {
            deleteForm(id);
        }
    });
    
    return card;
}

// View form details
async function viewFormDetails(formId) {
    try {
        const snapshot = await database.ref(`generalForms/${formId}`).once('value');
        const form = snapshot.val();
        
        if (!form) throw new Error('Form not found');
        
        const now = new Date().getTime();
        const closeTime = form.closeTime ? new Date(form.closeTime).getTime() : null;
        const status = closeTime && now > closeTime ? 'Closed' : 'Active';
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${form.title}</h4>
                    <p class="mb-1"><strong>Status:</strong> 
                        <span class="badge ${status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                            ${status}
                        </span>
                    </p>
                    <p class="mb-1"><strong>Access:</strong> ${form.access === 'students' ? 'Only our students' : 'Public (anyone with link)'}</p>
                    <p class="mb-1"><strong>Requires login:</strong> ${form.requireLogin ? 'Yes' : 'No'}</p>
                    ${form.closeTime ? `<p class="mb-1"><strong>Closes:</strong> ${new Date(form.closeTime).toLocaleString()}</p>` : ''}
                    <p class="mb-1"><strong>Created:</strong> ${new Date(form.createdAt).toLocaleString()}</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-primary" id="copyFormLinkBtn">
                        <i class="bi bi-link-45deg"></i> Copy Form Link
                    </button>
                    <button class="btn btn-outline-danger ms-2" id="deleteFormBtn">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
            
            <div class="mb-4">
                <h5>Description</h5>
                <p>${form.description || 'No description provided'}</p>
            </div>
            
            <div class="mb-4">
                <h5>Questions Preview</h5>
        `;
        
        // Add questions preview
        form.questions.forEach((q, index) => {
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${index + 1}. ${q.title} ${q.required ? '<span class="text-danger">*</span>' : ''}</h6>
                        <div class="card-text">
            `;
            
            switch (q.type) {
                case 'short-answer':
                    html += `<input type="text" class="form-control" placeholder="Short answer text" disabled>`;
                    break;
                    
                case 'paragraph':
                    html += `<textarea class="form-control" placeholder="Long answer text" rows="2" disabled></textarea>`;
                    break;
                    
                case 'multiple-choice':
                    html += `<div class="mb-2">`;
                    q.options.forEach((opt, i) => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="q${index}" id="q${index}o${i}" disabled>
                                <label class="form-check-label" for="q${index}o${i}">${opt}</label>
                            </div>
                        `;
                    });
                    if (q.includeOther) {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="q${index}" id="q${index}other" disabled>
                                <label class="form-check-label" for="q${index}other">Other:</label>
                                <input type="text" class="form-control mt-1" disabled>
                            </div>
                        `;
                    }
                    html += `</div>`;
                    break;
                    
                case 'checkbox':
                    html += `<div class="mb-2">`;
                    q.options.forEach((opt, i) => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="q${index}o${i}" disabled>
                                <label class="form-check-label" for="q${index}o${i}">${opt}</label>
                            </div>
                        `;
                    });
                    if (q.includeOther) {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="q${index}other" disabled>
                                <label class="form-check-label" for="q${index}other">Other:</label>
                                <input type="text" class="form-control mt-1" disabled>
                            </div>
                        `;
                    }
                    html += `</div>`;
                    break;
                    
                case 'dropdown':
                    html += `
                        <select class="form-select" disabled>
                            <option selected disabled>Select an option</option>
                            ${q.options.map(opt => `<option>${opt}</option>`).join('')}
                        </select>
                    `;
                    break;
                    
                case 'file-upload':
                    html += `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> File upload field (${q.fileTypes.join(', ')}) - Max ${q.maxSize}MB
                        </div>
                    `;
                    break;
                    
                case 'linear-scale':
                    const minLabel = q.minLabel || q.minValue;
                    const maxLabel = q.maxLabel || q.maxValue;
                    html += `
                        <div class="d-flex justify-content-between mb-1">
                            <span>${minLabel}</span>
                            <span>${maxLabel}</span>
                        </div>
                        <input type="range" class="form-range" min="${q.minValue}" max="${q.maxValue}" disabled>
                    `;
                    break;
                    
                case 'rating':
                    html += `
                        <div class="rating-preview">
                            ${q.scale === 'stars' ? 
                                '<i class="bi bi-star-fill text-warning"></i>'.repeat(5) :
                                q.scale === 'smileys' ?
                                '<i class="bi bi-emoji-smile-fill text-warning"></i>'.repeat(5) :
                                '<span class="badge bg-primary me-1">1</span>'.repeat(q.scale === '10' ? 10 : 5)}
                        </div>
                    `;
                    break;
                    
                case 'multiple-choice-grid':
                case 'checkbox-grid':
                    html += `
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th></th>
                                        ${q.columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${q.rows.map(row => `
                                        <tr>
                                            <td>${row}</td>
                                            ${q.columns.map((col, i) => `
                                                <td class="text-center">
                                                    <input type="${q.type === 'multiple-choice-grid' ? 'radio' : 'checkbox'}" 
                                                           name="row${q.rows.indexOf(row)}" disabled>
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;
                    
                case 'date':
                    html += `<input type="date" class="form-control" disabled>`;
                    if (q.includeTime) {
                        html += `<input type="time" class="form-control mt-2" disabled>`;
                    }
                    break;
                    
                case 'time':
                    html += `<input type="time" class="form-control" disabled>`;
                    break;
            }
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        
        document.getElementById('formDetails').innerHTML = html;

        // Add event listener for copy link button
        document.getElementById('copyFormLinkBtn').addEventListener('click', function() {
            const formLink = `${window.location.origin}/student-form.html?formId=${formId}`;
            
            navigator.clipboard.writeText(formLink).then(() => {
                // Show feedback
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
                
                // Revert after 2 seconds
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy link:', err);
                
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = formLink;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
                    
                    // Revert after 2 seconds
                    setTimeout(() => {
                        this.innerHTML = originalText;
                    }, 2000);
                } catch (err) {
                    alert('Failed to copy link. Please try again or copy manually.');
                }
                
                document.body.removeChild(textArea);
            });
        });
        
        // Add event listener for delete button
        document.getElementById('deleteFormBtn').addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('formModal'));
            modal.hide();
            
            if (confirm(`Are you sure you want to delete this form? This will also delete all submissions.`)) {
                deleteForm(formId);
            }
        });
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('formModal'));
        modal.show();

    } catch (error) {
        console.error('Error viewing form:', error);
        alert(`Error: ${error.message}`);
    }
}

// Delete form
async function deleteForm(formId) {
    try {
        if (!confirm('Are you absolutely sure? This will permanently delete the form and all its submissions.')) {
            return;
        }

        // Show loading state
        const card = document.querySelector(`.form-card[data-form-id="${formId}"]`);
        const deleteBtn = document.getElementById('deleteFormBtn');
        
        if (card) {
            card.querySelector('.delete-form-btn').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            card.querySelector('.delete-form-btn').disabled = true;
        }
        
        if (deleteBtn) {
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
            deleteBtn.disabled = true;
        }

        // Delete from database
        await database.ref(`generalForms/${formId}`).remove();
        
        // Delete submissions
        await database.ref(`formSubmissions/${formId}`).remove();
        
        // Delete any uploaded files from storage
        // Note: This would require tracking file uploads in submissions
        // For now, we'll just delete the form data

        // Remove the card from UI
        if (card) {
            card.remove();
        }

        // Show success message
        alert('Form and all its submissions have been deleted successfully.');
        
        // Reload counts
        loadGeneralForms();

    } catch (error) {
        console.error('Error deleting form:', error);
        alert(`Error: ${error.message}`);
        
        // Reset button states
        const card = document.querySelector(`.form-card[data-form-id="${formId}"]`);
        if (card) {
            card.querySelector('.delete-form-btn').innerHTML = '<i class="bi bi-trash"></i> Delete';
            card.querySelector('.delete-form-btn').disabled = false;
        }
        
        const deleteBtn = document.getElementById('deleteFormBtn');
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
            deleteBtn.disabled = false;
        }
    }
}

// Update form tab badges
function updateFormTabBadges(active, upcoming, closed) {
    document.getElementById('formActive-tab').innerHTML = `Active ${active > 0 ? `<span class="badge bg-primary ms-2">${active}</span>` : ''}`;
    document.getElementById('formUpcoming-tab').innerHTML = `Upcoming ${upcoming > 0 ? `<span class="badge bg-primary ms-2">${upcoming}</span>` : ''}`;
    document.getElementById('formClosed-tab').innerHTML = `Closed ${closed > 0 ? `<span class="badge bg-primary ms-2">${closed}</span>` : ''}`;
}

// Update the tab click handlers
document.getElementById('formActive-tab').addEventListener('click', () => {
    loadFormsByStatus('active');
});

document.getElementById('formUpcoming-tab').addEventListener('click', () => {
    loadFormsByStatus('upcoming');
});

document.getElementById('formClosed-tab').addEventListener('click', () => {
    loadFormsByStatus('closed');
});

async function loadFormsByStatus(status) {
    try {
        const snapshot = await database.ref('generalForms').once('value');
        const forms = snapshot.val() || {};
        const now = new Date().getTime();
        
        const filteredForms = Object.entries(forms).filter(([id, form]) => {
            if (!form.closeTime) return status === 'active';
            
            const closeTime = new Date(form.closeTime).getTime();
            if (status === 'active') return now <= closeTime;
            if (status === 'closed') return now > closeTime;
            return false;
        });
        
        const containerId = `${status}FormsContainer`;
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if (filteredForms.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No ${status} forms found</p>
                </div>
            `;
            return;
        }
        
        filteredForms.forEach(([id, form]) => {
            const card = createFormCard(id, form, status);
            container.appendChild(card);
        });
    } catch (error) {
        console.error(`Error loading ${status} forms:`, error);
        document.getElementById(`${status}FormsContainer`).innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                Error loading forms
            </div>
        `;
    }
}

// Show form empty state
function showFormEmptyState(containerId, count) {
    if (count === 0) {
        document.getElementById(containerId).innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                <p class="text-muted">No forms found</p>
            </div>
        `;
    }
}

// Load form submission forms
async function loadFormSubmissionForms(applyFilters = true) {
    try {
        const container = document.getElementById('formSubmissionCards');
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;

        const snapshot = await database.ref('generalForms').once('value');
        const forms = snapshot.val() || {};
        
        // Clear container
        container.innerHTML = '';
        
        let formsArray = Object.entries(forms).map(([id, form]) => ({ id, ...form }));
        
        // Apply default filters on initial load
        if (applyFilters) {
            const yearFilter = document.getElementById('formSubmissionYearFilter').value;
            const monthFilter = document.getElementById('formSubmissionMonthFilter').value;
            
            if (yearFilter) {
                formsArray = formsArray.filter(form => {
                    const formYear = new Date(form.createdAt).getFullYear().toString();
                    return formYear === yearFilter;
                });
            }
            
            if (monthFilter) {
                formsArray = formsArray.filter(form => {
                    const formDate = new Date(form.createdAt);
                    return (formDate.getMonth() + 1) === parseInt(monthFilter);
                });
            }
        }
        
        if (formsArray.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">${applyFilters ? 'No forms match the selected filters' : 'No forms found'}</p>
                </div>
            `;
            return;
        }
        
        // Sort by creation date (newest first)
        formsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // Create form cards
        for (const form of formsArray) {
            const submissionsSnapshot = await database.ref(`formSubmissions/${form.id}`).once('value');
            const submissionCount = submissionsSnapshot.exists() ? Object.keys(submissionsSnapshot.val()).length : 0;
            
            const card = createFormSubmissionCard(form.id, form, submissionCount);
            container.appendChild(card);
        }
        
    } catch (error) {
        console.error('Error loading form submissions:', error);
        document.getElementById('formSubmissionCards').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                Error loading forms
            </div>
        `;
    }
}
// Create form submission card
function createFormSubmissionCard(id, form, submissionCount) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 form-submission-card';
    card.setAttribute('data-form-id', id);
    
    // Add year and month data attributes for filtering
    const createdAt = new Date(form.createdAt);
    card.setAttribute('data-year', createdAt.getFullYear().toString());
    card.setAttribute('data-month', (createdAt.getMonth() + 1).toString());
    
    const createdAtFormatted = createdAt.toLocaleDateString();
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${form.title}</h5>
                <p class="card-text text-muted">${form.description || 'No description'}</p>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-primary">
                        ${submissionCount} submission${submissionCount !== 1 ? 's' : ''}
                    </span>
                    <small class="text-muted">
                        ${createdAtFormatted}
                    </small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-form-submissions-btn">
                    <i class="bi bi-list-check"></i> View Submissions
                </button>
            </div>
        </div>
    `;
    
    // Add event listener for view submissions
    card.querySelector('.view-form-submissions-btn').addEventListener('click', () => {
        loadFormSubmissions(id, form.title);
    });
    
    return card;
}

// Load form submissions
async function loadFormSubmissions(formId, formTitle) {
    try {
        // Store the form ID in the card element
        const submissionsCard = document.getElementById('formSubmissionsListCard');
        submissionsCard.setAttribute('data-form-id', formId);

        // Show loading state
        const tbody = document.getElementById('formSubmissionsList');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border"></div></td></tr>';
        
        // Set form title
        document.getElementById('selectedFormTitle').textContent = `Submissions: ${formTitle}`;
        document.getElementById('selectedFormTitle').setAttribute('data-form-id', formId);
        
        // Show submissions list and hide form cards
        document.getElementById('formSubmissionCards').style.display = 'none';
        document.getElementById('formSubmissionsListCard').style.display = 'block';
        
        // Load form details to get questions for filtering
        const formSnapshot = await database.ref(`generalForms/${formId}`).once('value');
        const form = formSnapshot.val();
        
        if (!form) {
            throw new Error('Form not found');
        }

        // Update question filter dropdown
        const questionFilter = document.getElementById('questionFilter');
        questionFilter.innerHTML = '<option value="">All Questions</option>';
        
        if (form.questions) {
            form.questions.forEach((q, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${q.title}`;
                questionFilter.appendChild(option);
            });
        }
        
        // Load submissions
        const snapshot = await database.ref(`formSubmissions/${formId}`).once('value');
        const submissions = snapshot.val() || {};
        
        tbody.innerHTML = '';
        
        if (Object.keys(submissions).length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        // Convert to array and sort by timestamp (newest first)
        const submissionsArray = Object.entries(submissions).map(([id, submission]) => ({
            id, ...submission
        })).sort((a, b) => b.timestamp - a.timestamp);
        
        // Display submissions
        submissionsArray.forEach(sub => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.id.substring(0, 8)}</td>
                <td>${sub.name || 'Anonymous'}</td>
                <td>${new Date(sub.timestamp).toLocaleString()}</td>
                <td>${sub.responses ? Object.keys(sub.responses).length : 0} responses</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-submission" 
                            data-form="${formId}" data-submission="${sub.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add click event to view submission details
            row.querySelector('.view-submission').addEventListener('click', () => {
                viewFormSubmissionDetails(formId, sub.id, formTitle, form.questions);
            });
        });
        
    } catch (error) {
        console.error('Error loading form submissions:', error);
        document.getElementById('formSubmissionsList').innerHTML = `
            <tr><td colspan="5" class="text-center text-danger">
                Error loading submissions: ${error.message}
                <button class="btn btn-sm btn-secondary mt-2" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
            </td></tr>
        `;
        
        // Make sure back button is still visible
        document.getElementById('formSubmissionsListCard').style.display = 'block';
    }
}

function addReloadButton(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <p class="text-danger mb-3">Failed to load data</p>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Reload
            </button>
        </div>
    `;
}

async function loadWithRetry(loadFunction, maxRetries = 3) {
    let retries = 0;
    while (retries < maxRetries) {
        try {
            await loadFunction();
            return;
        } catch (error) {
            retries++;
            if (retries >= maxRetries) {
                throw error;
            }
            await new Promise(resolve => setTimeout(resolve, 1000 * retries));
        }
    }
}

document.getElementById('backToFormsBtn').addEventListener('click', function() {
    // Remove any existing chart
    const existingChart = document.getElementById('questionResponseChart');
    if (existingChart) {
        existingChart.remove();
    }
    
    // Remove the chart canvas if it exists separately
    const chartCanvas = document.getElementById('responseChartCanvas');
    if (chartCanvas) {
        chartCanvas.remove();
    }
    
    // Destroy any Chart.js instances
    if (window.responseChart) {
        window.responseChart.destroy();
        window.responseChart = null;
    }
    
    // Show the form cards container
    document.getElementById('formSubmissionCards').style.display = 'flex';
    
    // Hide the submissions table
    document.getElementById('formSubmissionsListCard').style.display = 'none';
    
    // Reset any scroll positions
    window.scrollTo(0, 0);
});

document.getElementById('formSubmissionFilterBtn').addEventListener('click', function() {
    loadFormSubmissionForms(true); // Pass true to apply filters
});

// Apply filters to submissions
document.getElementById('applyFiltersBtn').addEventListener('click', async function() {
    try {
        const submissionsCard = document.getElementById('formSubmissionsListCard');
        const formId = submissionsCard.getAttribute('data-form-id');
        
        if (!formId) {
            alert('Please select a form first by clicking on "View Submissions" for a specific form');
            return;
        }

        const questionIndex = document.getElementById('questionFilter').value;
        const responseText = document.getElementById('responseFilter').value.toLowerCase();
        
        // Show loading state
        const tbody = document.getElementById('formSubmissionsList');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border"></div></td></tr>';
        
        // Get form questions
        const [formSnapshot, submissionsSnapshot] = await Promise.all([
            database.ref(`generalForms/${formId}`).once('value'),
            database.ref(`formSubmissions/${formId}`).once('value')
        ]);
        
        const form = formSnapshot.val();
        const submissions = submissionsSnapshot.val() || {};
        
        if (!form || !form.questions) {
            throw new Error('Form data not found');
        }

        // Convert to array and sort by timestamp (newest first)
        let submissionsArray = Object.entries(submissions).map(([id, submission]) => ({
            id, 
            ...submission,
            responses: submission.responses || {}
        })).sort((a, b) => b.timestamp - a.timestamp);

        // Apply filters
        if (questionIndex !== '' || responseText !== '') {
            submissionsArray = submissionsArray.filter(submission => {
                try {
                    // Filter by question response if question is selected
                    if (questionIndex !== '') {
                        const response = submission.responses[questionIndex];
                        if (response === undefined || response === null) return false;
                        
                        // Check if response matches the filter text
                        if (responseText !== '') {
                            let responseValue;
                            
                            if (Array.isArray(response)) {
                                responseValue = response.join(' ').toLowerCase();
                            } else if (typeof response === 'object') {
                                responseValue = JSON.stringify(response).toLowerCase();
                            } else {
                                responseValue = response.toString().toLowerCase();
                            }
                            
                            return responseValue.includes(responseText);
                        }
                        return true;
                    }
                    
                    // Search all responses if no specific question is selected
                    if (responseText !== '') {
                        for (const key in submission.responses) {
                            const response = submission.responses[key];
                            let responseValue;
                            
                            if (Array.isArray(response)) {
                                responseValue = response.join(' ').toLowerCase();
                            } else if (typeof response === 'object') {
                                responseValue = JSON.stringify(response).toLowerCase();
                            } else {
                                responseValue = response.toString().toLowerCase();
                            }
                            
                            if (responseValue.includes(responseText)) {
                                return true;
                            }
                        }
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error processing submission:', submission.id, error);
                    return false;
                }
            });
        }
        
        // Display filtered submissions
        tbody.innerHTML = '';
        
        if (submissionsArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No matching submissions found</td></tr>';
            return;
        }
        
        submissionsArray.forEach(sub => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.id.substring(0, 8)}</td>
                <td>${sub.name || 'Anonymous'}</td>
                <td>${new Date(sub.timestamp).toLocaleString()}</td>
                <td>${Object.keys(sub.responses).length} responses</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-submission" 
                            data-form="${formId}" data-submission="${sub.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            row.querySelector('.view-submission').addEventListener('click', () => {
                viewFormSubmissionDetails(formId, sub.id, form.title, form.questions);
            });
        });
        
        // Show chart if applicable
        if (questionIndex !== '' && form.questions[questionIndex]) {
            const question = form.questions[questionIndex];
            if (['multiple-choice', 'checkbox', 'linear-scale', 'rating', 'multiple-choice-grid', 'checkbox-grid'].includes(question.type)) {
                showQuestionResponseChart(formId, questionIndex, question, submissionsArray);
            }
        }
        
    } catch (error) {
        console.error('Error applying filters:', error);
        document.getElementById('formSubmissionsList').innerHTML = `
            <tr><td colspan="5" class="text-center text-danger">
                Error: ${error.message}
                <br><button class="btn btn-sm btn-secondary mt-2" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
            </td></tr>
        `;
    }
});

// Show chart for question responses
function showQuestionResponseChart(formId, questionIndex, question, submissions) {
    // Clean up any existing chart first
    const existingChart = document.getElementById('questionResponseChart');
    if (existingChart) {
        existingChart.remove();
    }
    
    // Destroy any existing Chart.js instance
    if (window.responseChart) {
        window.responseChart.destroy();
        window.responseChart = null;
    }

    // Create chart container
    const chartContainer = document.createElement('div');
    chartContainer.id = 'questionResponseChart';
    chartContainer.className = 'card mb-4';
    chartContainer.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Response Analysis: ${question.title}</h5>
            <button class="btn btn-sm btn-outline-secondary" id="closeChartBtn">
                <i class="bi bi-x"></i> Close
            </button>
        </div>
        <div class="card-body">
            <div class="chart-container" style="position: relative; height:300px;">
                <canvas id="responseChartCanvas"></canvas>
            </div>
        </div>
    `;
    
    // Insert before the submissions table
    const submissionsCard = document.getElementById('formSubmissionsListCard');
    submissionsCard.parentNode.insertBefore(chartContainer, submissionsCard);

    // Add close button functionality
    document.getElementById('closeChartBtn').addEventListener('click', function() {
        chartContainer.remove();
        if (window.responseChart) {
            window.responseChart.destroy();
            window.responseChart = null;
        }
    });

    // Prepare chart data based on question type
    let chartData = prepareChartData(question, submissions, questionIndex);

    // Create and store the chart instance
    const ctx = document.getElementById('responseChartCanvas').getContext('2d');
    window.responseChart = new Chart(ctx, {
        type: getChartType(question.type),
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Responses',
                data: chartData.values,
                backgroundColor: getBackgroundColors(chartData.labels.length),
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 1,
                hoverOffset: 10
            }]
        },
        options: getChartOptions(question, submissions.length)
    });

    // Helper functions for chart configuration
    function prepareChartData(question, submissions, questionIndex) {
        const responses = submissions.map(sub => sub.responses[questionIndex]);
        let labels = [];
        let values = [];

        switch (question.type) {
            case 'multiple-choice':
            case 'dropdown':
                question.options.forEach(option => {
                    labels.push(option);
                    values.push(responses.filter(r => r === option).length);
                });
                break;
                
            case 'checkbox':
                question.options.forEach(option => {
                    labels.push(option);
                    values.push(responses.filter(r => Array.isArray(r) && r.includes(option)).length);
                });
                break;
                
            case 'linear-scale':
                const min = parseInt(question.minValue) || 1;
                const max = parseInt(question.maxValue) || 5;
                for (let i = min; i <= max; i++) {
                    labels.push(question.minLabel && i === min ? question.minLabel : 
                               question.maxLabel && i === max ? question.maxLabel : i);
                    values.push(responses.filter(r => parseInt(r) === i).length);
                }
                break;
                
            case 'rating':
                if (question.scale === '5' || question.scale === 'stars' || question.scale === 'smileys') {
                    for (let i = 1; i <= 5; i++) {
                        labels.push(i);
                        values.push(responses.filter(r => parseInt(r) === i).length);
                    }
                } else if (question.scale === '10') {
                    for (let i = 1; i <= 10; i++) {
                        labels.push(i);
                        values.push(responses.filter(r => parseInt(r) === i).length);
                    }
                }
                break;
                
            case 'multiple-choice-grid':
            case 'checkbox-grid':
                if (question.rows.length > 0 && question.columns.length > 0) {
                    question.columns.forEach((col, colIndex) => {
                        labels.push(col);
                        values.push(responses.filter(r => r && r[0] && r[0][colIndex]).length);
                    });
                }
                break;
                
            default:
                labels = ['Responses'];
                values = [responses.length];
        }

        return { labels, values };
    }

    function getChartType(questionType) {
        return ['linear-scale', 'rating'].includes(questionType) ? 'bar' : 'pie';
    }

    function getBackgroundColors(count) {
        const palette = [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)',
            'rgba(83, 102, 255, 0.7)',
            'rgba(255, 99, 255, 0.7)',
            'rgba(99, 255, 132, 0.7)'
        ];
        return palette.slice(0, count);
    }

    function getChartOptions(question, totalResponses) {
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `Response Distribution (${totalResponses} submissions)`,
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            const percentage = Math.round((context.raw / totalResponses) * 100);
                            label += `${context.raw} (${percentage}%)`;
                            return label;
                        }
                    }
                }
            }
        };

        if (['linear-scale', 'rating'].includes(question.type)) {
            return {
                ...baseOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            };
        }
        return baseOptions;
    }
}

// Reset filters
document.getElementById('resetFiltersBtn').addEventListener('click', function() {
    document.getElementById('questionFilter').value = '';
    document.getElementById('responseFilter').value = '';
    
    const rows = document.querySelectorAll('#formSubmissionsList tr');
    rows.forEach(row => {
        row.style.display = '';
    });
});

// Get submission by ID (mock function - in a real app, you'd fetch from Firebase)
function getSubmissionById(submissionId) {
    // In a real implementation, you would fetch this from Firebase
    // For now, we'll just return an empty object
    return {};
}

// View form submission details
async function viewFormSubmissionDetails(formId, submissionId, formTitle, formQuestions) {
    try {
        const [formSnapshot, submissionSnapshot] = await Promise.all([
            database.ref(`generalForms/${formId}`).once('value'),
            database.ref(`formSubmissions/${formId}/${submissionId}`).once('value')
        ]);
        
        const form = formSnapshot.val();
        const submission = submissionSnapshot.val();
        
        if (!form || !submission) throw new Error('Submission details not found');
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${formTitle}</h4>
                    <h6>Submission ID: ${submissionId.substring(0, 8)}</h6>
                    <p class="mb-1"><strong>Submitted by:</strong> ${submission.name || 'Anonymous'}</p>
                    <p class="mb-1"><strong>Submitted at:</strong> ${new Date(submission.timestamp).toLocaleString()}</p>
                    ${submission.email ? `<p class="mb-1"><strong>Email:</strong> ${submission.email}</p>` : ''}
                    ${submission.nic ? `<p class="mb-1"><strong>NIC:</strong> ${submission.nic}</p>` : ''}
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Close
                    </button>
                </div>
            </div>
            
            <div class="mb-4">
                <h5>Responses</h5>
        `;
        
        // Add responses for each question
        formQuestions.forEach((q, index) => {
            const response = submission.responses[index];
            
            if (!response) return;
            
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${index + 1}. ${q.title}</h6>
                        <div class="card-text">
            `;
            
            switch (q.type) {
                case 'short-answer':
                case 'paragraph':
                    html += `<p>${response || 'No response'}</p>`;
                    break;
                    
                case 'multiple-choice':
                case 'dropdown':
                    html += `<p>${response || 'No response selected'}</p>`;
                    break;
                    
                case 'checkbox':
                    if (Array.isArray(response)) {
                        html += `<ul class="mb-0">`;
                        response.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul>`;
                    } else {
                        html += `<p>${response || 'No options selected'}</p>`;
                    }
                    break;
                    
                case 'file-upload':
                    if (Array.isArray(response)) {
                        html += `<ul class="mb-0">`;
                        response.forEach(file => {
                            html += `<li><a href="${file.url}" target="_blank">${file.name}</a> (${formatFileSize(file.size)})</li>`;
                        });
                        html += `</ul>`;
                    } else if (response.url) {
                        html += `<a href="${response.url}" target="_blank">${response.name}</a> (${formatFileSize(response.size)})`;
                    } else {
                        html += `<p>No files uploaded</p>`;
                    }
                    break;
                    
                case 'linear-scale':
                    html += `<p>Selected: ${response}</p>`;
                    break;
                    
                case 'rating':
                    html += `<p>Rating: ${response}</p>`;
                    break;
                    
                case 'multiple-choice-grid':
                case 'checkbox-grid':
                    html += `
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th></th>
                                        ${q.columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    q.rows.forEach((row, rowIndex) => {
                        html += `
                            <tr>
                                <td>${row}</td>
                                ${q.columns.map((col, colIndex) => {
                                    const cellResponse = response[rowIndex]?.[colIndex];
                                    return `<td class="text-center">${cellResponse ? '✓' : ''}</td>`;
                                }).join('')}
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;
                    
                case 'date':
                    html += `<p>${response}</p>`;
                    break;
                    
                case 'time':
                    html += `<p>${response}</p>`;
                    break;
                    
                default:
                    html += `<p>${JSON.stringify(response)}</p>`;
            }
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        
        document.getElementById('formSubmissionDetails').innerHTML = html;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('formSubmissionModal'));
        modal.show();

    } catch (error) {
        console.error('Error viewing form submission:', error);
        alert(`Error: ${error.message}`);
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Download form submissions as CSV
document.getElementById('downloadFormSubmissionsBtn').addEventListener('click', async function() {
    try {
        const formId = document.getElementById('formSubmissionsListCard').getAttribute('data-form-id');
        if (!formId) {
            alert('No form selected');
            return;
        }
        
        // Get form details
        const formSnapshot = await database.ref(`generalForms/${formId}`).once('value');
        const form = formSnapshot.val();
        if (!form) throw new Error('Form not found');
        
        // Get submissions
        const submissionsSnapshot = await database.ref(`formSubmissions/${formId}`).once('value');
        const submissions = submissionsSnapshot.val() || {};
        
        if (Object.keys(submissions).length === 0) {
            alert('No submissions to download');
            return;
        }
        
        // Convert to CSV
        let csv = 'Submission ID,Submitted At,Submitted By,Email,NIC';
        
        // Add question headers
        form.questions.forEach((q, index) => {
            csv += `,"${index + 1}. ${q.title}"`;
        });
        
        csv += '\n';
        
        // Add submission data
        Object.entries(submissions).forEach(([id, sub]) => {
            csv += `"${id.substring(0, 8)}","${new Date(sub.timestamp).toLocaleString()}","${sub.name || ''}","${sub.email || ''}","${sub.nic || ''}"`;
            
            // Add responses
            form.questions.forEach((q, index) => {
                const response = sub.responses ? sub.responses[index] : null;
                let responseText = '';
                
                if (response !== undefined && response !== null) {
                    if (Array.isArray(response)) {
                        responseText = response.join('; ');
                    } else if (typeof response === 'object') {
                        if (response.url) {
                            // File upload response
                            responseText = response.name;
                        } else {
                            // Grid response
                            responseText = JSON.stringify(response);
                        }
                    } else {
                        responseText = response.toString();
                    }
                }
                
                csv += `,"${responseText.replace(/"/g, '""')}"`;
            });
            
            csv += '\n';
        });
        
        // Create download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${form.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_submissions_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
    } catch (error) {
        console.error('Error downloading submissions:', error);
        alert(`Error: ${error.message}`);
    }
});

// Update the initialization code
function initFormSection() {
    // Clear any existing event listeners to prevent duplicates
    document.querySelectorAll('.dropdown-menu a[data-type]').forEach(item => {
        item.removeEventListener('click', addQuestionHandler);
    });
    
    // Add new event listeners
    document.querySelectorAll('.dropdown-menu a[data-type]').forEach(item => {
        item.addEventListener('click', addQuestionHandler);
    });
    
    // Initialize all existing question elements
    document.querySelectorAll('#formQuestionsContainer .question-item').forEach(questionDiv => {
        initQuestionElements(questionDiv);
    });
    
    // Initialize template buttons
    document.getElementById('templateSurveyBtn').addEventListener('click', (e) => {
        e.preventDefault();
        applyFormTemplate(formTemplates.survey);
    });
    
    document.getElementById('templateFeedbackBtn').addEventListener('click', (e) => {
        e.preventDefault();
        applyFormTemplate(formTemplates.feedback);
    });
    
    document.getElementById('templateQuizBtn').addEventListener('click', (e) => {
        e.preventDefault();
        applyFormTemplate(formTemplates.quiz);
    });
}

//Add Question Handler 
function addQuestionHandler(e) {
    e.preventDefault();
    const type = this.getAttribute('data-type');
    addQuestion(type);
}

// Initialize when form section is shown
document.getElementById('generalFormsTab').addEventListener('click', initFormSection);
document.getElementById('viewGeneralFormsTab').addEventListener('click', function() {
    loadGeneralForms();
    initFormSection();
});
document.getElementById('viewGeneralFormSubmissionsTab').addEventListener('click', function() {
    loadFormSubmissionForms();
    initFormSection();
});

// Initialize the form section if it's already active
if (document.getElementById('generalFormsSection').style.display !== 'none') {
    initFormSection();
}
//View General Forms Section
if (document.getElementById('viewGeneralFormsSection').style.display !== 'none') {
    loadGeneralForms();
    initFormSection();
}
if (document.getElementById('viewGeneralFormSubmissionsSection').style.display !== 'none') {
    loadFormSubmissionForms();
    initFormSection();
}

// Load form submission forms
async function loadFormSubmissionForms() {
    const yearFilter = document.getElementById('formSubmissionYearFilter').value;
    const monthFilter = document.getElementById('formSubmissionMonthFilter').value;
    
    try {
        const snapshot = await database.ref('generalForms').once('value');
        const forms = snapshot.val() || {};
        const container = document.getElementById('formSubmissionCards');
        
        // Clear container
        container.innerHTML = '';
        
        let formsArray = Object.entries(forms).map(([id, form]) => ({ id, ...form }));
        
        // Apply filters
        if (yearFilter) {
            formsArray = formsArray.filter(form => {
                const formYear = new Date(form.createdAt).getFullYear().toString();
                return formYear === yearFilter;
            });
        }
        
        if (monthFilter) {
            formsArray = formsArray.filter(form => {
                const formDate = new Date(form.createdAt);
                return (formDate.getMonth() + 1) === parseInt(monthFilter);
            });
        }
        
        if (formsArray.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                    <p class="text-muted">No forms found</p>
                </div>
            `;
            return;
        }
        
        // Sort by creation date (newest first)
        formsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // Create form cards
        for (const form of formsArray) {
            // Get submission count
            const submissionsSnapshot = await database.ref(`formSubmissions/${form.id}`).once('value');
            const submissionCount = submissionsSnapshot.exists() ? Object.keys(submissionsSnapshot.val()).length : 0;
            
            const card = createFormSubmissionCard(form.id, form, submissionCount);
            container.appendChild(card);
        }
        
    } catch (error) {
        console.error('Error loading form submissions:', error);
        document.getElementById('formSubmissionCards').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                Error loading forms
            </div>
        `;
    }
}

// Create form submission card
function createFormSubmissionCard(id, form, submissionCount) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4 form-submission-card';
    card.setAttribute('data-form-id', id);
    
    card.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">${form.title}</h5>
                <p class="card-text text-muted">${form.description || 'No description'}</p>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge bg-primary">
                        ${submissionCount} submission${submissionCount !== 1 ? 's' : ''}
                    </span>
                    <small class="text-muted">
                        ${new Date(form.createdAt).toLocaleDateString()}
                    </small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary view-form-submissions-btn">
                    <i class="bi bi-list-check"></i> View Submissions
                </button>
            </div>
        </div>
    `;
    
    // Add event listener for view submissions
    card.querySelector('.view-form-submissions-btn').addEventListener('click', () => {
        loadFormSubmissions(id, form.title);
    });
    
    return card;
}

// Load form submissions for a specific form
async function loadFormSubmissions(formId, formTitle) {
    try {
        // Store the form ID in the card element
        const submissionsCard = document.getElementById('formSubmissionsListCard');
        submissionsCard.setAttribute('data-form-id', formId);

        // Show loading state
        const tbody = document.getElementById('formSubmissionsList');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border"></div></td></tr>';
        
        // Set form title
        document.getElementById('selectedFormTitle').textContent = `Submissions: ${formTitle}`;
        document.getElementById('selectedFormTitle').setAttribute('data-form-id', formId);
        
        // Show submissions list and hide form cards
        document.getElementById('formSubmissionCards').style.display = 'none';
        document.getElementById('formSubmissionsListCard').style.display = 'block';
        
        // Load form details to get questions for filtering
        const formSnapshot = await database.ref(`generalForms/${formId}`).once('value');
        const form = formSnapshot.val();
        
        // Update question filter dropdown
        const questionFilter = document.getElementById('questionFilter');
        questionFilter.innerHTML = '<option value="">All Questions</option>';
        
        if (form.questions) {
            form.questions.forEach((q, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${q.title}`;
                questionFilter.appendChild(option);
            });
        }
        
        // Load submissions
        const snapshot = await database.ref(`formSubmissions/${formId}`).once('value');
        const submissions = snapshot.val() || {};
        
        tbody.innerHTML = '';
        
        if (Object.keys(submissions).length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No submissions found</td></tr>';
            return;
        }
        
        // Convert to array and sort by timestamp (newest first)
        const submissionsArray = Object.entries(submissions).map(([id, submission]) => ({
            id, ...submission
        })).sort((a, b) => b.timestamp - a.timestamp);
        
        // Display submissions
        submissionsArray.forEach(sub => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sub.id.substring(0, 8)}</td>
                <td>${sub.name || 'Anonymous'}</td>
                <td>${new Date(sub.timestamp).toLocaleString()}</td>
                <td>${sub.responses ? Object.keys(sub.responses).length : 0} responses</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-submission" 
                            data-form="${formId}" data-submission="${sub.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add click event to view submission details
            row.querySelector('.view-submission').addEventListener('click', () => {
                viewFormSubmissionDetails(formId, sub.id, formTitle, form.questions);
            });
        });
        
    } catch (error) {
        console.error('Error loading form submissions:', error);
        document.getElementById('formSubmissionsList').innerHTML = `
            <tr><td colspan="5" class="text-center text-danger">Error loading submissions</td></tr>
        `;
        
        // Make sure back button is still visible
        document.getElementById('formSubmissionsListCard').style.display = 'block';
    }
}

// View form submission details
async function viewFormSubmissionDetails(formId, submissionId, formTitle, formQuestions) {
    try {
        const submissionSnapshot = await database.ref(`formSubmissions/${formId}/${submissionId}`).once('value');
        const submission = submissionSnapshot.val();
        
        if (!submission) throw new Error('Submission details not found');
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${formTitle}</h4>
                    <h6>Submission ID: ${submissionId.substring(0, 8)}</h6>
                    <p class="mb-1"><strong>Submitted by:</strong> ${submission.name || 'Anonymous'}</p>
                    <p class="mb-1"><strong>Submitted at:</strong> ${new Date(submission.timestamp).toLocaleString()}</p>
                    ${submission.email ? `<p class="mb-1"><strong>Email:</strong> ${submission.email}</p>` : ''}
                    ${submission.nic ? `<p class="mb-1"><strong>NIC:</strong> ${submission.nic}</p>` : ''}
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Close
                    </button>
                </div>
            </div>
            
            <div class="mb-4">
                <h5>Responses</h5>
        `;
        
        // Add responses for each question
        if (formQuestions && submission.responses) {
            formQuestions.forEach((q, index) => {
                const response = submission.responses[index];
                
                if (response === undefined) return;
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${index + 1}. ${q.title}</h6>
                            <div class="card-text">
                `;
                
                // Handle different response types
                if (Array.isArray(response)) {
                    html += `<ul class="mb-0">`;
                    response.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += `</ul>`;
                } else if (typeof response === 'object' && response !== null) {
                    html += `<pre>${JSON.stringify(response, null, 2)}</pre>`;
                } else {
                    html += `<p>${response}</p>`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += `</div>`;
        
        document.getElementById('formSubmissionDetails').innerHTML = html;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('formSubmissionModal'));
        modal.show();

    } catch (error) {
        console.error('Error viewing form submission:', error);
        alert(`Error: ${error.message}`);
    }
}

// Add these to your initialization code
document.getElementById('backToFormsBtn').addEventListener('click', function() {
    document.getElementById('formSubmissionCards').style.display = 'flex';
    document.getElementById('formSubmissionsListCard').style.display = 'none';
});

// Apply filters button
document.getElementById('applyFiltersBtn').addEventListener('click', function() {
    const questionFilter = document.getElementById('questionFilter').value;
    const responseFilter = document.getElementById('responseFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#formSubmissionsList tr');
    
    rows.forEach(row => {
        if (row.id === 'submissionsLoading') return;
        
        // You'll need to implement actual filtering logic based on your data structure
        // This is just a basic example
        const shouldShow = true; // Implement your filter logic here
        
        row.style.display = shouldShow ? '' : 'none';
    });
});

// Reset filters button
document.getElementById('resetFiltersBtn').addEventListener('click', function() {
    document.getElementById('questionFilter').value = '';
    document.getElementById('responseFilter').value = '';
    
    const rows = document.querySelectorAll('#formSubmissionsList tr');
    rows.forEach(row => {
        row.style.display = '';
    });
});

// Update template application
document.getElementById('templateSurveyBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyFormTemplate(formTemplates.survey);
});

document.getElementById('templateFeedbackBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyFormTemplate(formTemplates.feedback);
});

document.getElementById('templateQuizBtn').addEventListener('click', (e) => {
    e.preventDefault();
    applyFormTemplate(formTemplates.quiz);
});

// Improved applyFormTemplate function
function applyFormTemplate(template) {
    const container = document.getElementById('formQuestionsContainer');
    container.innerHTML = '';
    
    template.questions.forEach(question => {
        addQuestion(question.type);
        const questionDiv = container.lastChild;
        
        // Set title
        questionDiv.querySelector('.question-title').value = question.title;
        
        // Set required
        if (question.required && questionDiv.querySelector('.toggle-required span')) {
            questionDiv.querySelector('.toggle-required span').textContent = 'Yes';
        }
        
        // Set options for multiple choice
        if (question.options && questionDiv.querySelector('.options-container')) {
            const optionsContainer = questionDiv.querySelector('.options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-item mb-2 d-flex align-items-center';
                
                if (question.type === 'multiple-choice' || question.type === 'checkbox') {
                    optionDiv.innerHTML = `
                        <input type="${question.type === 'multiple-choice' ? 'radio' : 'checkbox'}" class="form-check-input me-2" disabled>
                        <input type="text" class="form-control option-text" placeholder="Option ${index + 1}" value="${option}">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    `;
                } else {
                    optionDiv.innerHTML = `
                        <input type="text" class="form-control option-text" placeholder="Option ${index + 1}" value="${option}">
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-option"><i class="bi bi-trash"></i></button>
                    `;
                }
                
                optionsContainer.appendChild(optionDiv);
                
                // Initialize remove button
                optionDiv.querySelector('.remove-option').addEventListener('click', function() {
                    if (optionsContainer.querySelectorAll('.option-item').length > 1) {
                        optionDiv.remove();
                    } else {
                        alert('At least one option is required');
                    }
                });
            });
        }
    });
}

// Add this to your initialization code
function initFormSections() {
    // Initialize form creation section
    document.querySelectorAll('.dropdown-menu a[data-type]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-type');
            addQuestion(type);
        });
    });

    // Initialize form templates
    document.getElementById('templateSurveyBtn').addEventListener('click', (e) => {
        e.preventDefault();
        applyFormTemplate(formTemplates.survey);
    });
    
    document.getElementById('templateFeedbackBtn').addEventListener('click', (e) => {
        e.preventDefault();
        applyFormTemplate(formTemplates.feedback);
    });
    
    document.getElementById('templateQuizBtn').addEventListener('click', (e) => {
        e.preventDefault();
        applyFormTemplate(formTemplates.quiz);
    });

    // Initialize form submission filtering
    document.getElementById('formSubmissionFilterBtn').addEventListener('click', loadFormSubmissionForms);
    document.getElementById('applyFiltersBtn').addEventListener('click', applySubmissionFilters);
    document.getElementById('resetFiltersBtn').addEventListener('click', resetSubmissionFilters);
}

// Call this when the page loads and when forms tab is clicked
document.addEventListener('DOMContentLoaded', initFormSections);
document.getElementById('viewFormsTab').addEventListener('click', initFormSections);
document.getElementById('viewFormSubmissionsTab').addEventListener('click', initFormSections);


//====================================
//paper class rankings
//===================================


// Paper Class Rankings Functions
async function initRankingsSection() {
    // Initialize form with proper event listener
    const uploadForm = document.getElementById('uploadRankingsForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleFileUpload();
        });
    }
    
    // Initialize confirm button
    const confirmBtn = document.getElementById('confirmUploadBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmUpload);
    }
    
    // Initialize paper filter
    const paperFilter = document.getElementById('rankingsPaperFilter');
    if (paperFilter) {
        paperFilter.addEventListener('change', loadRankingsData);
    }
    
    // Initialize publish all button
    const publishAllBtn = document.getElementById('publishAllForPaperBtn');
    if (publishAllBtn) {
        publishAllBtn.addEventListener('click', publishAllBatchesForPaper);
    }
    
    // Load papers when section initializes
    await loadRankingsPapers();
}

async function loadRankingsPapers() {
    try {
        // Load papers for both select elements
        const snapshot = await database.ref('paperClassPapers').once('value');
        const papers = snapshot.val() || {};
        
        const paperSelect = document.getElementById('rankingsPaperSelect');
        const paperFilter = document.getElementById('rankingsPaperFilter');
        
        // Clear existing options except the first one
        while (paperSelect.options.length > 1) paperSelect.remove(1);
        while (paperFilter.options.length > 1) paperFilter.remove(1);
        
        // Add papers to both selects
        Object.entries(papers).forEach(([id, paper]) => {
            const option1 = document.createElement('option');
            option1.value = id;
            option1.textContent = paper.title;
            paperSelect.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = id;
            option2.textContent = paper.title;
            paperFilter.appendChild(option2);
        });
        
        // Load rankings data if in view tab
        if (document.getElementById('viewRankings').classList.contains('active')) {
            loadRankingsData();
        }
    } catch (error) {
        console.error('Error loading papers:', error);
        alert('Error loading papers');
    }
}

async function handleFileUpload() {
    const fileInput = document.getElementById('rankingsFile');
    const file = fileInput.files[0];
    const paperId = document.getElementById('rankingsPaperSelect').value;
    
    if (!file) {
        showAlert('Please select a file first', 'danger');
        return;
    }
    
    if (!paperId) {
        showAlert('Please select a paper first', 'danger');
        return;
    }

    // 1. First check existing records for this paper
    const existingBatchesSnapshot = await database.ref(`paperClassRankings/${paperId}/batches`).once('value');
    const existingBatches = existingBatchesSnapshot.val() || {};
    
    // Collect all existing student IDs
    const existingStudentIds = new Set();
    Object.values(existingBatches).forEach(batch => {
        if (batch.scores) {
            Object.values(batch.scores).forEach(score => {
                if (score.studentId) existingStudentIds.add(score.studentId.toString());
            });
        }
    });

    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            // Process Excel file
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            // Validate data
            if (jsonData.length === 0) throw new Error('No data found in the Excel file');
            if (!jsonData[0]['Student ID'] || !jsonData[0]['Score']) {
                throw new Error('Excel file must contain "Student ID" and "Score" columns');
            }
            
            // Check for duplicates in existing batches
            const duplicateIds = jsonData
                .map(row => row['Student ID']?.toString().trim())
                .filter(id => id && existingStudentIds.has(id));
            
            if (duplicateIds.length > 0) {
                document.getElementById('duplicateWarning').style.display = 'block';
                document.getElementById('duplicateMessage').textContent = 
                    `Warning: ${duplicateIds.length} students already have scores in other batches (IDs: ${duplicateIds.slice(0, 5).join(', ')}${duplicateIds.length > 5 ? '...' : ''})`;
            } else {
                document.getElementById('duplicateWarning').style.display = 'none';
            }
            
            // Proceed with preview
            showUploadPreview(jsonData);
        } catch (error) {
            console.error('Error processing file:', error);
            showAlert(`Error: ${error.message}`, 'danger');
        }
    };
    
    reader.onerror = function() {
        showAlert('Error reading file', 'danger');
    };
    
    reader.readAsArrayBuffer(file);
}

function showUploadPreview(data) {
    const previewTable = document.getElementById('previewTableBody');
    previewTable.innerHTML = '';
    
    // Show the preview section
    const uploadPreview = document.getElementById('uploadPreview');
    uploadPreview.style.display = 'block';
    
    // Clear any existing skip button
    const existingSkipBtn = document.getElementById('skipAllDuplicatesBtn');
    if (existingSkipBtn) {
        existingSkipBtn.remove();
    }
    
    // Create new skip button
    const skipAllBtn = document.createElement('button');
    skipAllBtn.id = 'skipAllDuplicatesBtn';
    skipAllBtn.className = 'btn btn-warning btn-sm mb-3';
    skipAllBtn.innerHTML = '<i class="bi bi-skip-forward-circle"></i> Skip All Duplicates';
    skipAllBtn.addEventListener('click', skipAllDuplicates);
    
    // Insert the button before the table
    const previewTableElement = document.getElementById('previewTable');
    if (previewTableElement && previewTableElement.parentNode) {
        previewTableElement.parentNode.insertBefore(skipAllBtn, previewTableElement);
    }
    
    // Process data
    data.forEach((row, index) => {
        const studentId = row['Student ID']?.toString().trim() || '';
        const score = parseFloat(row['Score']) || 0;
        const name = row['Name'] || '';
        
        const tr = document.createElement('tr');
        tr.dataset.originalData = JSON.stringify(row);
        tr.innerHTML = `
            <td>${studentId}</td>
            <td>${name || 'N/A'}</td>
            <td>${score}</td>
            <td class="match-status">Checking...</td>
            <td>
                <button class="btn btn-sm btn-outline-secondary skip-row" ${index === 0 ? 'disabled' : ''}>
                    <i class="bi bi-skip-forward"></i> Skip
                </button>
            </td>
        `;
        previewTable.appendChild(tr);
    });

    // Verify matches
    checkStudentMatches();
}

async function checkStudentMatches() {
    const previewRows = document.querySelectorAll('#previewTableBody tr');
    const studentIds = Array.from(previewRows).map(row => row.cells[0].textContent.trim());
    
    // Fetch all matching students
    const studentsSnapshot = await database.ref('users').once('value');
    const allStudents = studentsSnapshot.val() || {};
    
    const matchedStudents = {};
    Object.entries(allStudents).forEach(([uid, student]) => {
        if (student.studentId && studentIds.includes(student.studentId.toString())) {
            matchedStudents[student.studentId] = {
                uid,
                name: student.name,
                class: student.class,
                district: student.district
            };
        }
    });
    
    // Update UI
    previewRows.forEach(row => {
        const studentId = row.cells[0].textContent.trim();
        const statusCell = row.querySelector('.match-status');
        const skipBtn = row.querySelector('.skip-row');
        
        if (matchedStudents[studentId]) {
            statusCell.innerHTML = '<span class="text-success">Matched</span>';
            row.dataset.uid = matchedStudents[studentId].uid;
            row.dataset.name = matchedStudents[studentId].name;
            row.dataset.class = matchedStudents[studentId].class;
            row.dataset.district = matchedStudents[studentId].district;
            skipBtn.disabled = true;
        } else {
            statusCell.innerHTML = '<span class="text-danger">Not found</span>';
            skipBtn.addEventListener('click', () => {
                row.remove();
                updateConfirmButton();
            });
        }
    });
    
    updateConfirmButton();
}

function skipAllDuplicates() {
    const previewRows = document.querySelectorAll('#previewTableBody tr');
    let skippedCount = 0;
    
    previewRows.forEach(row => {
        if (row.querySelector('.match-status').textContent === 'Not found') {
            row.remove();
            skippedCount++;
        }
    });
    
    updateConfirmButton();
    document.getElementById('duplicateWarning').style.display = 'none';
    
    // Show feedback
    if (skippedCount > 0) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '11';
        toast.innerHTML = `
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto">Success</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Skipped ${skippedCount} unmatched records.
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
}

function updateConfirmButton() {
    const validRows = document.querySelectorAll('#previewTableBody tr[data-uid]');
    const confirmBtn = document.getElementById('confirmUploadBtn');
    
    if (validRows.length > 0) {
        confirmBtn.style.display = 'block';
        confirmBtn.textContent = `Confirm Upload (${validRows.length} students)`;
    } else {
        confirmBtn.style.display = 'none';
    }
}

async function publishAllBatchesForPaper() {
    const paperId = document.getElementById('rankingsPaperFilter').value;
    if (!paperId) {
        alert('Please select a paper first');
        return;
    }

    if (!confirm(`This will publish ALL unpublished batches for "${document.getElementById('rankingsPaperFilter').options[document.getElementById('rankingsPaperFilter').selectedIndex].text}". Continue?`)) {
        return;
    }

    const btn = document.getElementById('publishAllForPaperBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

    try {
        // Get paper data
        const snapshot = await database.ref(`paperClassRankings/${paperId}/batches`).once('value');
        const batches = snapshot.val() || {};
        
        let publishedCount = 0;
        let errors = 0;
        
        // Process each batch
        for (const [batchId, batch] of Object.entries(batches)) {
            if (!batch.published) {
                try {
                    // Calculate class rankings
                    const classGroups = {};
                    Object.values(batch.scores || {}).forEach(student => {
                        if (!classGroups[student.class]) {
                            classGroups[student.class] = [];
                        }
                        classGroups[student.class].push(student);
                    });
                    
                    // Calculate rankings for each class
                    const classRankings = {};
                    Object.entries(classGroups).forEach(([className, students]) => {
                        const sorted = students.sort((a, b) => b.score - a.score);
                        let rank = 1;
                        sorted.forEach((student, index) => {
                            if (index > 0 && student.score < sorted[index - 1].score) {
                                rank = index + 1;
                            }
                            student.rank = rank;
                        });
                        classRankings[className] = sorted;
                    });
                    
                    // Update batch
                    await database.ref(`paperClassRankings/${paperId}/batches/${batchId}`).update({
                        published: true,
                        classRankings
                    });
                    
                    publishedCount++;
                } catch (error) {
                    console.error(`Error publishing batch ${batchId}:`, error);
                    errors++;
                }
            }
        }
        
        if (publishedCount > 0 || errors > 0) {
            alert(`Published ${publishedCount} batches successfully. ${errors > 0 ? `${errors} batches had errors.` : ''}`);
            loadRankingsData();
        } else {
            alert('No unpublished batches found for this paper');
        }
    } catch (error) {
        console.error('Error publishing batches:', error);
        alert(`Error: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function confirmUpload() {
    const paperId = document.getElementById('rankingsPaperSelect').value;
    const batchName = document.getElementById('rankingsBatchName').value.trim();
    
    if (!paperId || !batchName) {
        showAlert('Please select a paper and enter a batch name', 'danger');
        return;
    }
    
    const previewRows = document.querySelectorAll('#previewTableBody tr[data-uid]');
    if (previewRows.length === 0) {
        showAlert('No valid student records to upload', 'warning');
        return;
    }

    try {
        // Show loading state
        const btn = document.getElementById('confirmUploadBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
        
        // 1. First get all existing scores for this paper
        const existingBatchesSnapshot = await database.ref(`paperClassRankings/${paperId}/batches`).once('value');
        const existingBatches = existingBatchesSnapshot.val() || {};
        
        // Collect all existing student IDs across all batches for this paper
        const existingStudentIds = new Set();
        Object.values(existingBatches).forEach(batch => {
            if (batch.scores) {
                Object.values(batch.scores).forEach(score => {
                    if (score.studentId) {
                        existingStudentIds.add(score.studentId.toString());
                    }
                });
            }
        });

        // Prepare data to upload
        const timestamp = Date.now();
        const batchId = `batch-${timestamp}`;
        const uploadData = {
            paperId,
            batchName,
            timestamp,
            published: false,
            scores: {}
        };

        // Process each valid row
        const processedStudents = new Set();
        let duplicateCount = 0;
        let newRecordsCount = 0;
        
        for (const row of previewRows) {
            const studentId = row.cells[0].textContent.trim();
            const uid = row.dataset.uid;
            
            // Skip if already processed in this batch
            if (processedStudents.has(studentId)) {
                duplicateCount++;
                continue;
            }
            
            // Skip if student already has a record in any batch for this paper
            if (existingStudentIds.has(studentId)) {
                duplicateCount++;
                continue;
            }
            
            processedStudents.add(studentId);
            
            const score = parseFloat(row.cells[2].textContent);
            const name = row.dataset.name || row.cells[1].textContent;
            const studentClass = row.dataset.class || 'N/A';
            const district = row.dataset.district || 'N/A';

            // Validate score
            if (isNaN(score)) {
                console.error(`Invalid score for student ${studentId}`);
                continue;
            }

            uploadData.scores[uid] = {
                score: score,
                studentId: studentId,
                name: name,
                class: studentClass,
                district: district
            };
            newRecordsCount++;
        }

        // Check if we have any valid data to upload
        if (newRecordsCount === 0) {
            if (duplicateCount > 0) {
                throw new Error(`All ${duplicateCount} records are duplicates of existing submissions for this paper`);
            }
            throw new Error('No valid student scores to upload');
        }

        // Show warning about duplicates if any
        if (duplicateCount > 0) {
            showAlert(`Skipped ${duplicateCount} duplicate records (existing in other batches)`, 'warning');
        }

        // Save to database
        await database.ref(`paperClassRankings/${paperId}/batches/${batchId}`).set(uploadData);
        
        // Update UI
        showAlert(`Successfully uploaded ${newRecordsCount} new student scores`, 'success');
        document.getElementById('uploadPreview').style.display = 'none';
        document.getElementById('uploadRankingsForm').reset();
        
        // Reload rankings data if in view tab
        if (document.getElementById('viewRankings').classList.contains('active')) {
            await loadRankingsData();
        }
    } catch (error) {
        console.error('Error uploading scores:', error);
        showAlert(error.message, 'danger');
    } finally {
        const btn = document.getElementById('confirmUploadBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Upload';
        }
    }
}

// Helper function to show alerts
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '1000';
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

async function loadRankingsData() {
    try {
        const container = document.getElementById('rankingsContainer');
        container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';
        
        const paperId = document.getElementById('rankingsPaperFilter').value;
        const snapshot = await database.ref('paperClassRankings').once('value');
        const allRankings = snapshot.val() || {};
        
        container.innerHTML = '';
        
        // Update publish button visibility
        document.getElementById('publishAllForPaperBtn').style.display = paperId ? 'block' : 'none';
        document.getElementById('publishAllForPaperBtn').dataset.paperId = paperId;
        
        if (paperId) {
            // Show data for selected paper only
            const paperRankings = allRankings[paperId];
            if (paperRankings && paperRankings.batches) {
                await createPaperRankingCard(paperId, paperRankings);
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                        <p class="text-muted">No rankings data found for this paper</p>
                    </div>
                `;
            }
        } else {
            // Show all papers with rankings
            if (Object.keys(allRankings).length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-file-earmark-text display-5 text-muted mb-3"></i>
                        <p class="text-muted">No rankings data found</p>
                    </div>
                `;
                return;
            }
            
            // Load paper titles first
            const papersSnapshot = await database.ref('paperClassPapers').once('value');
            const papers = papersSnapshot.val() || {};
            
            for (const [paperId, paperData] of Object.entries(allRankings)) {
                if (paperData.batches) {
                    const paperTitle = papers[paperId]?.title || 'Unknown Paper';
                    await createPaperRankingCard(paperId, paperData, paperTitle);
                }
            }
        }
    } catch (error) {
        console.error('Error loading rankings:', error);
        document.getElementById('rankingsContainer').innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-exclamation-triangle display-5 text-danger mb-3"></i>
                <p class="text-danger">Error loading rankings data</p>
                <button class="btn btn-secondary mt-3" onclick="loadRankingsData()">
                    <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
            </div>
        `;
    }
}

async function createPaperRankingCard(paperId, paperData, paperTitle = null) {
    try {
        // If paperTitle not provided, fetch it
        if (!paperTitle) {
            const paperSnapshot = await database.ref(`paperClassPapers/${paperId}/title`).once('value');
            paperTitle = paperSnapshot.val() || 'Unknown Paper';
        }

        const card = document.createElement('div');
        card.className = 'col-12 mb-4';
        
        card.innerHTML = `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">${paperTitle}</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary view-class-rankings-btn" data-paper-id="${paperId}">
                            <i class="bi bi-trophy"></i> View Class Rankings
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    ${paperData.batches ? `
                    <ul class="nav nav-tabs" id="paperTabs-${paperId.replace(/[^a-zA-Z0-9]/g, '-')}" role="tablist">
                        ${Object.entries(paperData.batches).map(([batchId, batch], index) => `
                            <li class="nav-item" role="presentation">
                                <button class="nav-link ${index === 0 ? 'active' : ''}" 
                                        id="tab-${batchId}" 
                                        data-bs-toggle="tab" 
                                        data-bs-target="#batch-${batchId}" 
                                        type="button" 
                                        role="tab">
                                    ${batch.batchName || 'Unnamed Batch'}
                                    ${batch.published ? '<span class="badge bg-success ms-2">Published</span>' : ''}
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="tab-content p-3 border border-top-0" id="paperTabContent-${paperId.replace(/[^a-zA-Z0-9]/g, '-')}">
                        ${Object.entries(paperData.batches).map(([batchId, batch], index) => `
                            <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                                 id="batch-${batchId}" 
                                 role="tabpanel">
                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <strong>Uploaded:</strong> ${new Date(batch.timestamp || Date.now()).toLocaleString()}
                                        <span class="ms-3"><strong>Scores:</strong> ${Object.keys(batch.scores || {}).length}</span>
                                    </div>
                                    <div>
                                        ${!batch.published ? `
                                            <button class="btn btn-sm btn-success publish-batch-btn" data-paper-id="${paperId}" data-batch-id="${batchId}">
                                                <i class="bi bi-check-circle"></i> Publish
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-sm btn-outline-danger ms-2 delete-batch-btn" data-paper-id="${paperId}" data-batch-id="${batchId}">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Student ID</th>
                                                <th>Name</th>
                                                <th>Class</th>
                                                <th>District</th>
                                                <th>Score</th>
                                            </tr>
                                        </thead>
                                        <tbody id="batchContent-${batchId}">
                                            <!-- Scores will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : `
                    <div class="alert alert-warning">
                        No batches found for this paper
                    </div>
                    `}
                </div>
            </div>
        `;
        
        document.getElementById('rankingsContainer').appendChild(card);
        
        // Initialize Bootstrap tabs
        const tab = new bootstrap.Tab(card.querySelector('.nav-link.active'));
        tab.show();
        
        // Load scores for each batch
        if (paperData.batches) {
            for (const [batchId, batch] of Object.entries(paperData.batches)) {
                await loadBatchScores(paperId, batchId, batch);
            }
        }
        
        // Add event listeners
        card.querySelectorAll('.publish-batch-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                publishBatch(this.dataset.paperId, this.dataset.batchId);
            });
        });
        
        card.querySelectorAll('.delete-batch-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this batch? This cannot be undone.')) {
                    deleteBatch(this.dataset.paperId, this.dataset.batchId);
                }
            });
        });
        
        card.querySelectorAll('.view-class-rankings-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                viewClassRankings(this.dataset.paperId);
            });
        });
        
    } catch (error) {
        console.error('Error creating ranking card:', error);
        throw error;
    }
}

async function loadBatchScores(paperId, batchId, batch) {
    try {
        const tbody = document.getElementById(`batchContent-${batchId}`);
        if (!tbody) {
            console.warn(`Table body not found for batch ${batchId}`);
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';
        
        // Convert scores to array and sort by score (descending)
        const scoresArray = batch.scores ? Object.entries(batch.scores).map(([uid, data]) => ({
            uid,
            ...data
        })).sort((a, b) => b.score - a.score) : [];
        
        tbody.innerHTML = '';
        
        if (scoresArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No scores found in this batch</td></tr>';
            return;
        }
        
        // Display scores with rankings
        scoresArray.forEach((student, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.studentId || 'N/A'}</td>
                <td>${student.name || 'N/A'}</td>
                <td>${student.class || 'N/A'}</td>
                <td>${student.district || 'N/A'}</td>
                <td>${student.score !== undefined ? student.score : 'N/A'}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading batch scores:', error);
        const tbody = document.getElementById(`batchContent-${batchId}`);
        if (tbody) {
            tbody.innerHTML = `
                <tr><td colspan="6" class="text-center text-danger">
                    Error loading scores
                    <button class="btn btn-sm btn-secondary mt-2" onclick="loadBatchScores('${paperId}', '${batchId}', ${JSON.stringify(batch)})">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </td></tr>
            `;
        }
    }
}

async function publishBatch(paperId, batchId) {
    try {
        if (!confirm('Publishing will calculate final rankings for all classes. Continue?')) {
            return;
        }
        
        // Show loading state
        const btn = document.querySelector(`.publish-batch-btn[data-batch-id="${batchId}"]`);
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Publishing...';
        }
        
        // Mark batch as published
        await database.ref(`paperClassRankings/${paperId}/batches/${batchId}/published`).set(true);
        
        // Calculate class rankings
        const batchSnapshot = await database.ref(`paperClassRankings/${paperId}/batches/${batchId}`).once('value');
        const batch = batchSnapshot.val();
        
        if (!batch || !batch.scores) {
            throw new Error('Batch data not found');
        }
        
        // Group scores by class
        const classGroups = {};
        Object.values(batch.scores).forEach(student => {
            if (!classGroups[student.class]) {
                classGroups[student.class] = [];
            }
            classGroups[student.class].push(student);
        });
        
        // Calculate rankings for each class
        const classRankings = {};
        Object.entries(classGroups).forEach(([className, students]) => {
            // Sort students by score (descending)
            const sorted = students.sort((a, b) => b.score - a.score);
            
            // Assign ranks (handling ties)
            let rank = 1;
            sorted.forEach((student, index) => {
                if (index > 0 && student.score < sorted[index - 1].score) {
                    rank = index + 1;
                }
                student.rank = rank;
            });
            
            classRankings[className] = sorted;
        });
        
        // Save class rankings
        await database.ref(`paperClassRankings/${paperId}/batches/${batchId}/classRankings`).set(classRankings);
        
        // Update UI
        if (btn) {
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Published';
        }
        
        // Reload the batch to show published status
        loadBatchScores(paperId, batchId, { ...batch, published: true });
        
        alert('Batch published successfully! Class rankings have been calculated.');
    } catch (error) {
        console.error('Error publishing batch:', error);
        alert('Error publishing batch');
        
        const btn = document.querySelector(`.publish-batch-btn[data-batch-id="${batchId}"]`);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Publish';
        }
    }
}

async function deleteBatch(paperId, batchId) {
    try {
        // Show loading state
        const btn = document.querySelector(`.delete-batch-btn[data-batch-id="${batchId}"]`);
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }
        
        // Delete from database
        await database.ref(`paperClassRankings/${paperId}/batches/${batchId}`).remove();
        
        // Remove from UI
        const tabPane = document.getElementById(`batch-${batchId}`);
        if (tabPane) {
            tabPane.remove();
        }
        
        // If no batches left, remove the entire paper card
        const paperSnapshot = await database.ref(`paperClassRankings/${paperId}/batches`).once('value');
        if (!paperSnapshot.exists() || Object.keys(paperSnapshot.val()).length === 0) {
            const paperCard = document.querySelector(`.view-class-rankings-btn[data-paper-id="${paperId}"]`)?.closest('.card');
            if (paperCard) {
                paperCard.remove();
            }
        }
    } catch (error) {
        console.error('Error deleting batch:', error);
        alert('Error deleting batch');
        
        const btn = document.querySelector(`.delete-batch-btn[data-batch-id="${batchId}"]`);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash"></i> Delete';
        }
    }
}

async function viewClassRankings(paperId) {
    try {
        // Show loading state in modal
        const modalContent = document.getElementById('classRankingsContent');
        modalContent.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Loading class rankings...</p>
            </div>
        `;
        
        // Get paper title
        const paperSnapshot = await database.ref(`paperClassPapers/${paperId}/title`).once('value');
        const paperTitle = paperSnapshot.val() || 'Unknown Paper';
        
        // Get all published batches for this paper
        const rankingsSnapshot = await database.ref(`paperClassRankings/${paperId}/batches`).once('value');
        const batches = rankingsSnapshot.val() || {};
        
        // Filter published batches and get their class rankings
        const publishedBatches = Object.entries(batches)
            .filter(([_, batch]) => batch.published && batch.classRankings)
            .sort((a, b) => b.timestamp - a.timestamp);
        
        if (publishedBatches.length === 0) {
            modalContent.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-info-circle display-5 text-muted"></i>
                    <p class="mt-3">No published rankings found for this paper</p>
                </div>
            `;
        } else {
            // Use the most recent published batch
            const [batchId, batch] = publishedBatches[0];
            
            modalContent.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>${paperTitle} - Class Rankings</h4>
                    <button class="btn btn-primary" id="downloadClassRankingsBtn">
                        <i class="bi bi-download"></i> Download as PDF
                    </button>
                </div>
                
                <ul class="nav nav-tabs" id="classRankingsTabs">
                    ${Object.keys(batch.classRankings || {}).map(className => `
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#class-${className.replace(/\s+/g, '-')}">
                                ${className}
                            </button>
                        </li>
                    `).join('')}
                </ul>
                
                <div class="tab-content p-3 border border-top-0" id="classRankingsTabContent">
                    ${Object.entries(batch.classRankings || {}).map(([className, students]) => `
                        <div class="tab-pane fade" id="class-${className.replace(/\s+/g, '-')}">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Student ID</th>
                                            <th>Name</th>
                                            <th>Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${students.map(student => `
                                            <tr>
                                                <td>${student.rank}</td>
                                                <td>${student.studentId}</td>
                                                <td>${student.name}</td>
                                                <td>${student.score}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Make first tab active
            const firstTab = modalContent.querySelector('#classRankingsTabs .nav-link:first-child');
            const firstPane = modalContent.querySelector('#classRankingsTabContent .tab-pane:first-child');
            if (firstTab && firstPane) {
                firstTab.classList.add('active');
                firstPane.classList.add('show', 'active');
            }
            
            // Add download button event
            document.getElementById('downloadClassRankingsBtn').addEventListener('click', () => {
                downloadClassRankingsAsPDF(paperTitle, batch.classRankings);
            });
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('classRankingsModal'));
        modal.show();
    } catch (error) {
        console.error('Error viewing class rankings:', error);
        modalContent.innerHTML = `
            <div class="text-center py-5 text-danger">
                <i class="bi bi-exclamation-triangle display-5"></i>
                <p class="mt-3">Error loading class rankings</p>
            </div>
        `;
    }
}

function downloadClassRankingsAsPDF(paperTitle, classRankings) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(18);
    doc.text(`${paperTitle} - Class Rankings`, 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
    
    let yPosition = 30;
    
    // Add each class table
    Object.entries(classRankings).forEach(([className, students], index) => {
        if (index > 0) {
            doc.addPage();
            yPosition = 20;
        }
        
        // Class title
        doc.setFontSize(14);
        doc.text(className, 14, yPosition);
        yPosition += 10;
        
        // Table headers
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('Rank', 14, yPosition);
        doc.text('Student ID', 40, yPosition);
        doc.text('Name', 80, yPosition);
        doc.text('Score', 160, yPosition);
        
        // Table rows
        doc.setFont(undefined, 'normal');
        yPosition += 7;
        
        students.forEach(student => {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.text(student.rank.toString(), 14, yPosition);
            doc.text(student.studentId, 40, yPosition);
            doc.text(student.name, 80, yPosition);
            doc.text(student.score.toString(), 160, yPosition);
            
            yPosition += 7;
        });
        
        yPosition += 10;
    });
    
    // Save the PDF
    doc.save(`${paperTitle.replace(/[^a-z0-9]/gi, '_')}_class_rankings.pdf`);
}

//Publish All Batches 
document.getElementById('publishAllForPaperBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const paperId = this.dataset.paperId;
    if (paperId) {
        publishAllBatchesForPaper(paperId);
    } else {
        console.error('No paper ID found');
        alert('No paper selected');
    }
});

async function publishAllBatchesForPaper(paperId) {
    // Validate paperId first
    if (!paperId || typeof paperId !== 'string' || paperId.trim() === '') {
        console.error('Invalid paper ID:', paperId);
        alert('Invalid paper selection');
        return;
    }

    if (!confirm(`This will publish ALL unpublished batches for the selected paper. Continue?`)) {
        return;
    }

    const btn = document.getElementById('publishAllForPaperBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

    try {
        // Get all batches for the paper
        const batchesSnapshot = await database.ref(`paperClassRankings/${paperId}/batches`).once('value');
        const batches = batchesSnapshot.val() || {};
        
        let publishedCount = 0;
        let errors = [];
        
        // Process each batch
        for (const [batchId, batch] of Object.entries(batches)) {
            if (!batch.published) {
                try {
                    // Calculate class rankings
                    const classGroups = {};
                    Object.values(batch.scores || {}).forEach(student => {
                        if (!classGroups[student.class]) {
                            classGroups[student.class] = [];
                        }
                        classGroups[student.class].push(student);
                    });
                    
                    // Calculate rankings for each class
                    const classRankings = {};
                    Object.entries(classGroups).forEach(([className, students]) => {
                        // Sort students by score (descending)
                        const sorted = students.sort((a, b) => b.score - a.score);
                        
                        // Assign ranks (handling ties)
                        let rank = 1;
                        sorted.forEach((student, index) => {
                            if (index > 0 && student.score < sorted[index - 1].score) {
                                rank = index + 1;
                            }
                            student.rank = rank;
                        });
                        
                        classRankings[className] = sorted;
                    });
                    
                    // Update batch in database
                    await database.ref(`paperClassRankings/${paperId}/batches/${batchId}`).update({
                        published: true,
                        classRankings
                    });
                    
                    publishedCount++;
                } catch (error) {
                    console.error(`Error publishing batch ${batchId}:`, error);
                    errors.push(`Batch ${batch.batchName || batchId}: ${error.message}`);
                }
            }
        }
        
        // Show results
        if (publishedCount > 0) {
            let message = `Successfully published ${publishedCount} batches`;
            if (errors.length > 0) {
                message += ` (${errors.length} errors)`;
            }
            alert(message);
            
            // Reload the rankings data
            loadRankingsData();
        } else if (errors.length > 0) {
            alert(`Failed to publish batches:\n${errors.join('\n')}`);
        } else {
            alert('No unpublished batches found for this paper');
        }
    } catch (error) {
        console.error('Error in publishAllBatchesForPaper:', error);
        alert(`Error: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Initialize when rankings section is shown
document.getElementById('paperClassRankingsTab').addEventListener('click', initRankingsSection);
document.getElementById('rankingsPaperFilter').addEventListener('change', function() {
    const paperId = this.value;
    const publishBtn = document.getElementById('publishAllForPaperBtn');
    publishBtn.style.display = paperId ? 'block' : 'none';
    publishBtn.dataset.paperId = paperId;
});



//======================================================================
//paper discussion
//======================================================================

// Initialize discussion section
function initDiscussionSection() {
    // Add event listener for the "Add Discussion" button
    document.getElementById('addDiscussionBtn').addEventListener('click', () => {
        showAddDiscussionModal();
    });
    
    document.getElementById('saveDiscussionBtn').addEventListener('click', saveDiscussion);

    // Add event listener for discussion type change
    document.getElementById('discussionType').addEventListener('change', function() {
        const relatedPaperContainer = document.getElementById('relatedPaperContainer');
        const relatedPaperSelect = document.getElementById('relatedPaper');
        
        if (this.value) {
            relatedPaperContainer.style.display = 'block';
            loadPapersForDiscussion(this.value);
        } else {
            relatedPaperContainer.style.display = 'none';
        }
    });
    
    // Add event listener for filter button
    document.getElementById('filterDiscussionsBtn').addEventListener('click', loadDiscussions);
    
    // Initialize video upload functionality
    initVideoUpload();
    
    // Initialize chapter management
    initChapterManagement();
}

// Show the add discussion modal
function showAddDiscussionModal() {
    // Reset form
    document.getElementById('addDiscussionForm').reset();
    document.getElementById('relatedPaperContainer').style.display = 'none';
    document.getElementById('videoPreviewContainer').style.display = 'none';
    document.getElementById('videoUploadArea').style.display = 'block';
    document.getElementById('uploadProgressBar').style.display = 'none';
    document.getElementById('chaptersContainer').innerHTML = '';
    
    // Clear any existing video
    const videoPreview = document.getElementById('videoPreview');
    videoPreview.src = '';
    videoPreview.load();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addDiscussionModal'));
    modal.show();
}

// Load papers for discussion based on type
async function loadPapersForDiscussion(type) {
    const relatedPaperSelect = document.getElementById('relatedPaper');
    relatedPaperSelect.innerHTML = '<option value="">Loading papers...</option>';
    
    try {
        let papersRef;
        if (type === 'paperClass') {
            papersRef = database.ref('paperClassPapers');
        } else if (type === 'onlineClass') {
            papersRef = database.ref('papers');
        } else {
            relatedPaperSelect.innerHTML = '<option value="">Select a paper</option>';
            return;
        }
        
        const snapshot = await papersRef.once('value');
        const papers = snapshot.val() || {};
        
        relatedPaperSelect.innerHTML = '<option value="">Select a paper</option>';
        
        Object.entries(papers).forEach(([id, paper]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = paper.title || `Paper ${id.substring(0, 8)}...`;
            relatedPaperSelect.appendChild(option);
        });
        
        if (Object.keys(papers).length === 0) {
            relatedPaperSelect.innerHTML = '<option value="">No papers found</option>';
        }
    } catch (error) {
        console.error('Error loading papers:', error);
        relatedPaperSelect.innerHTML = '<option value="">Error loading papers</option>';
    }
}

// Initialize video upload functionality
function initVideoUpload() {
    const videoUploadArea = document.getElementById('videoUploadArea');
    const videoFileInput = document.getElementById('videoFileInput');
    const videoPreview = document.getElementById('videoPreview');
    const videoInfo = document.getElementById('videoInfo');
    const removeVideoBtn = document.getElementById('removeVideoBtn');
    const browseVideoBtn = document.getElementById('browseVideoBtn');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    
    // Handle drag and drop
    videoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        videoUploadArea.classList.add('bg-light');
    });
    
    videoUploadArea.addEventListener('dragleave', () => {
        videoUploadArea.classList.remove('bg-light');
    });
    
    videoUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        videoUploadArea.classList.remove('bg-light');
        
        if (e.dataTransfer.files.length) {
            videoFileInput.files = e.dataTransfer.files;
            handleVideoFileSelect();
        }
    });
    
    // Handle browse button
    browseVideoBtn.addEventListener('click', () => {
        videoFileInput.click();
    });
    
    // Handle file selection
    videoFileInput.addEventListener('change', handleVideoFileSelect);
    
    // Handle remove video button
    removeVideoBtn.addEventListener('click', () => {
        videoPreview.src = '';
        videoPreview.load();
        videoFileInput.value = '';
        videoPreviewContainer.style.display = 'none';
        videoUploadArea.style.display = 'block';
    });
    
    function handleVideoFileSelect() {
        const file = videoFileInput.files[0];
        if (!file) return;
        
        // Check if file is a video
        if (!file.type.startsWith('video/')) {
            alert('Please select a valid video file');
            return;
        }
        
        // Check file size (limit to 500MB)
        if (file.size > 500 * 1024 * 1024) {
            alert('Video file size should be less than 500MB');
            return;
        }
        
        // Show preview
        videoPreview.src = URL.createObjectURL(file);
        videoInfo.textContent = `${file.name} (${formatFileSize(file.size)})`;
        videoPreviewContainer.style.display = 'block';
        videoUploadArea.style.display = 'none';
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i]);
}

// Initialize chapter management
function initChapterManagement() {
    const chaptersContainer = document.getElementById('chaptersContainer');
    const addChapterBtn = document.getElementById('addChapterBtn');
    
    // Add new chapter
    addChapterBtn.addEventListener('click', () => {
        const chapterId = Date.now();
        const chapterDiv = document.createElement('div');
        chapterDiv.className = 'chapter-item mb-3 p-3 border rounded';
        chapterDiv.dataset.chapterId = chapterId;
        
        chapterDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6>Chapter <span class="chapter-number">${chaptersContainer.children.length + 1}</span></h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-chapter">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="mb-3">
                <label class="form-label">Chapter Title*</label>
                <input type="text" class="form-control chapter-title" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control chapter-description" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Questions Covered</label>
                <input type="text" class="form-control chapter-questions" 
                       placeholder="e.g., 1-5, 8, 10-12">
                <div class="form-text">Enter question numbers separated by commas or ranges with hyphen</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Start Time (in video)</label>
                <input type="text" class="form-control chapter-start-time" 
                       placeholder="HH:MM:SS or MM:SS">
            </div>
        `;
        
        chaptersContainer.appendChild(chapterDiv);
        
        // Add event listener for remove button
        chapterDiv.querySelector('.remove-chapter').addEventListener('click', () => {
            chapterDiv.remove();
            updateChapterNumbers();
        });
    });
    
    // Update chapter numbers when one is removed
    function updateChapterNumbers() {
        const chapters = chaptersContainer.querySelectorAll('.chapter-item');
        chapters.forEach((chapter, index) => {
            chapter.querySelector('.chapter-number').textContent = index + 1;
        });
    }
}

// Save discussion
async function saveDiscussion(e) {
    e.preventDefault();
    
    const saveBtn = document.getElementById('saveDiscussionBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    try {
        // Validate form
        const title = document.getElementById('discussionTitle').value.trim();
        const type = document.getElementById('discussionType').value;
        const relatedPaper = document.getElementById('relatedPaper').value;
        const description = document.getElementById('discussionDescription').value.trim();
        const videoFile = document.getElementById('videoFileInput').files[0];
        
        if (!title) throw new Error('Discussion title is required');
        if (!type) throw new Error('Discussion type is required');
        if (!relatedPaper) throw new Error('Related paper is required');
        if (!videoFile) throw new Error('Video file is required');
        
        // Validate chapters
        const chapters = [];
        const chapterItems = document.querySelectorAll('.chapter-item');
        
        if (chapterItems.length === 0) {
            throw new Error('Please add at least one chapter');
        }
        
        chapterItems.forEach((chapter, index) => {
            const chapterTitle = chapter.querySelector('.chapter-title').value.trim();
            const chapterDesc = chapter.querySelector('.chapter-description').value.trim();
            const chapterQuestions = chapter.querySelector('.chapter-questions').value.trim();
            const chapterStartTime = chapter.querySelector('.chapter-start-time').value.trim();
            
            if (!chapterTitle) {
                throw new Error(`Chapter ${index + 1} title is required`);
            }
            
            chapters.push({
                title: chapterTitle,
                description: chapterDesc,
                questions: chapterQuestions,
                startTime: chapterStartTime,
                order: index + 1
            });
        });
        
        // Show upload progress
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const progressBar = document.querySelector('#uploadProgressBar .progress-bar');
        uploadProgressBar.style.display = 'block';
        progressBar.style.width = '0%';
        
        // Upload video to Firebase Storage
        const videoPath = `discussions/videos/${Date.now()}_${videoFile.name}`;
        const videoRef = storage.ref(videoPath);
        const uploadTask = videoRef.put(videoFile);
        
        // Wait for upload to complete
        const snapshot = await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Update progress bar
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = `${progress}%`;
                },
                (error) => {
                    reject(error);
                },
                () => {
                    resolve(uploadTask.snapshot);
                }
            );
        });
        
        // Get video URL
        const videoUrl = await videoRef.getDownloadURL();
        
        // Create discussion data
        const discussionData = {
            title,
            type,
            relatedPaper,
            description,
            videoUrl,
            videoPath,
            chapters,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            createdBy: auth.currentUser.uid
        };
        
        // Save to database
        const newDiscussionRef = database.ref('discussions').push();
        await newDiscussionRef.set(discussionData);
        
        // Show success and close modal
        alert('Discussion saved successfully!');
        const modal = bootstrap.Modal.getInstance(document.getElementById('addDiscussionModal'));
        if (modal) modal.hide();
        
        // Reload discussions list
        loadDiscussions();
        
    } catch (error) {
        console.error('Error saving discussion:', error);
        alert(`Error: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        if (uploadProgressBar) uploadProgressBar.style.display = 'none';
    }
}

// Load all discussions
async function loadDiscussions() {
    const tbody = document.getElementById('discussionsList');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';
    
    try {
        const typeFilter = document.getElementById('discussionTypeFilter').value;
        const snapshot = await database.ref('discussions').once('value');
        const discussions = snapshot.val() || {};
        
        // Convert to array and filter by type if needed
        let discussionsArray = Object.entries(discussions).map(([id, discussion]) => ({
            id,
            ...discussion
        }));
        
        if (typeFilter !== 'all') {
            discussionsArray = discussionsArray.filter(d => d.type === typeFilter);
        }
        
        // Sort by creation date (newest first)
        discussionsArray.sort((a, b) => b.createdAt - a.createdAt);
        
        // Clear table
        tbody.innerHTML = '';
        
        if (discussionsArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No discussions found</td></tr>';
            return;
        }
        
        // Load related paper titles in bulk
        const paperIds = [...new Set(discussionsArray.map(d => d.relatedPaper))];
        const paperTitles = {};
        
        await Promise.all(paperIds.map(async (paperId) => {
            let paperRef;
            if (discussionsArray.some(d => d.type === 'paperClass' && d.relatedPaper === paperId)) {
                paperRef = database.ref(`paperClassPapers/${paperId}/title`);
            } else {
                paperRef = database.ref(`papers/${paperId}/title`);
            }
            
            const paperSnapshot = await paperRef.once('value');
            paperTitles[paperId] = paperSnapshot.val() || 'Unknown Paper';
        }));
        
        // Populate table
        discussionsArray.forEach(discussion => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${discussion.title}</td>
                <td>${discussion.type === 'paperClass' ? 'Paper Class' : 'Online Class'}</td>
                <td>${paperTitles[discussion.relatedPaper] || 'Unknown Paper'}</td>
                <td>
                    ${discussion.chapters.map(c => c.questions).filter(Boolean).join(', ')}
                </td>
                <td>${new Date(discussion.createdAt).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-discussion" data-id="${discussion.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2 delete-discussion" data-id="${discussion.id}">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listeners
            row.querySelector('.view-discussion').addEventListener('click', () => {
                viewDiscussionDetails(discussion.id);
            });
            
            row.querySelector('.delete-discussion').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteDiscussion(discussion.id, discussion.title);
            });
        });
        
    } catch (error) {
        console.error('Error loading discussions:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading discussions</td></tr>';
    }
}

// View discussion details
async function viewDiscussionDetails(discussionId) {
    try {
        const snapshot = await database.ref(`discussions/${discussionId}`).once('value');
        const discussion = snapshot.val();
        
        if (!discussion) {
            throw new Error('Discussion not found');
        }
        
        // Get paper title
        let paperTitle = 'Unknown Paper';
        if (discussion.type === 'paperClass') {
            const paperSnapshot = await database.ref(`paperClassPapers/${discussion.relatedPaper}/title`).once('value');
            paperTitle = paperSnapshot.val() || paperTitle;
        } else {
            const paperSnapshot = await database.ref(`papers/${discussion.relatedPaper}/title`).once('value');
            paperTitle = paperSnapshot.val() || paperTitle;
        }
        
        // Create HTML for discussion details
        let html = `
            <div class="mb-4">
                <h4>${discussion.title}</h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Type:</strong> ${discussion.type === 'paperClass' ? 'Paper Class' : 'Online Class'}</p>
                        <p><strong>Related Paper:</strong> ${paperTitle}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Created:</strong> ${new Date(discussion.createdAt).toLocaleString()}</p>
                    </div>
                </div>
                ${discussion.description ? `<p class="mt-3">${discussion.description}</p>` : ''}
            </div>
            
            <div class="ratio ratio-16x9 mb-4">
                <video src="${discussion.videoUrl}" controls class="rounded"></video>
            </div>
            
            <h5 class="border-bottom pb-2 mb-3">Chapters</h5>
            <div class="list-group">
        `;
        
        // Add chapters
        discussion.chapters.forEach((chapter, index) => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-1">${index + 1}. ${chapter.title}</h6>
                        ${chapter.startTime ? `<small class="text-muted">Start: ${chapter.startTime}</small>` : ''}
                    </div>
                    ${chapter.description ? `<p class="mb-1 small">${chapter.description}</p>` : ''}
                    ${chapter.questions ? `<small class="text-muted">Questions: ${chapter.questions}</small>` : ''}
                </div>
            `;
        });
        
        html += `</div>`;
        
        // Create a modal to show details
        const modalDiv = document.createElement('div');
        modalDiv.className = 'modal fade';
        modalDiv.id = 'discussionDetailsModal';
        modalDiv.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Discussion Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modalDiv);
        const modal = new bootstrap.Modal(modalDiv);
        modal.show();
        
        // Remove modal from DOM after it's closed
        modalDiv.addEventListener('hidden.bs.modal', () => {
            modalDiv.remove();
        });
        
    } catch (error) {
        console.error('Error viewing discussion:', error);
        alert(`Error: ${error.message}`);
    }
}

// Delete discussion
async function deleteDiscussion(discussionId, discussionTitle) {
    if (!confirm(`Are you sure you want to delete the discussion "${discussionTitle}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        // Get discussion data first to delete the video file
        const snapshot = await database.ref(`discussions/${discussionId}`).once('value');
        const discussion = snapshot.val();
        
        if (!discussion) {
            throw new Error('Discussion not found');
        }
        
        // Delete video from storage
        if (discussion.videoPath) {
            await storage.ref(discussion.videoPath).delete();
        }
        
        // Delete discussion from database
        await database.ref(`discussions/${discussionId}`).remove();
        
        // Show success and reload discussions
        alert('Discussion deleted successfully!');
        loadDiscussions();
        
    } catch (error) {
        console.error('Error deleting discussion:', error);
        alert(`Error: ${error.message}`);
    }
}

// Initialize the discussion section when the page loads
initDiscussionSection();
</script>

</body>
</html>
