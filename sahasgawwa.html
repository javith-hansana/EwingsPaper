<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sahasgawwa 2025</title>
<link rel="icon" href="logo.png" type="image/png"/>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
/* ---------- Palettes: using only set1 and set3 ---------- */
/* set1: (0,0,0), (20,33,61), (252,163,17), (229,229,229), (255,255,255) */
/* set3: (142,202,230), (33,158,188), (2,48,71), (255,183,3), (251,133,0) */

:root{
  /* set1 */
  --black: rgb(0,0,0);
  --navy-1: rgb(20,33,61);
  --gold-1: rgb(252,163,17);
  --light-gray: rgb(229,229,229);
  --white: rgb(255,255,255);

  /* set3 */
  --sky-1: rgb(142,202,230);
  --teal-1: rgb(33,158,188);
  --deep-3: rgb(2,48,71);
  --gold-3: rgb(255,183,3);
  --orange-3: rgb(251,133,0);

  /* app vars */
  --bg-top: var(--sky-1);
  --bg-mid: rgba(250,250,252,0.85);
  --accent: var(--deep-3);
  --accent-2: var(--navy-1);
  --primary-gold: var(--gold-3);
  --cta-gold: var(--gold-1);
  --muted: rgba(2,48,71,0.72);
  --card-shadow: 0 16px 36px rgba(2,48,71,0.12);
}

/* base */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
body{
  background: linear-gradient(180deg, var(--bg-top) 0%, #e8f7ff 38%, var(--bg-mid) 100%);
  color:var(--accent); -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* header */
header{
  position:fixed; left:0; right:0; top:0; z-index:1000;
  display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
  background:linear-gradient(90deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94));
  border-bottom:1px solid rgba(2,48,71,0.06); box-shadow:var(--card-shadow);
}
.logo{display:flex;align-items:center;gap:12px}
.logo-img{height: 50px;}
nav{display:flex;align-items:center}
nav ul{display:flex;gap:12px;list-style:none;align-items:center;transition:all .28s ease}
nav a{color:var(--accent-2); text-decoration:none; font-weight:600; padding:8px 12px; border-radius:9px; transition:all .18s}
nav a:hover{transform:translateY(-3px); background: rgba(2,48,71,0.06); color:var(--deep-3)}
.mobile-menu-btn{display:none;border:0;background:none;font-size:20px;color:var(--accent-2)}

/* hero (original baseline; will be overridden by later rules) */
.hero{height:82vh;padding-top:84px;display:flex;align-items:center;justify-content:center}
.hero-wrap{max-width:980px;background:var(--white); padding:28px;border-radius:16px;box-shadow:var(--card-shadow); text-align:center; transition:transform .35s}
.hero-wrap:hover{transform:translateY(-6px)}
.hero h1{font-size:3rem;color:var(--deep-3);margin-bottom:8px}
.hero p{color:var(--muted);opacity:.95}
.cta{display:inline-block;margin-top:14px;padding:12px 22px;border-radius:999px;background:linear-gradient(90deg,var(--cta-gold),var(--primary-gold));color:var(--black);font-weight:700;transition:transform .18s}
.cta:hover{transform:translateY(-3px); box-shadow:0 12px 26px rgba(2,48,71,0.08)}

/* sections */
section{padding:72px 18px}
.section-title{text-align:center;margin-bottom:28px}
.section-title h2{font-size:1.9rem;color:var(--deep-3);display:inline-block;padding-bottom:6px;border-bottom:3px solid rgba(2,48,71,0.06)}

/* tabs */
.tabs, .competitions-tabs{display:flex;gap:8px;justify-content:center;margin-bottom:16px;flex-wrap:wrap}
.tab, .contest-tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(2,48,71,0.06);background:transparent;font-weight:700;cursor:pointer;transition:all .18s}
.tab:hover, .contest-tab:hover{transform:translateY(-4px)}
.tab.active, .contest-tab.active{background:linear-gradient(90deg,#fff,#fff); box-shadow:0 12px 30px rgba(2,48,71,0.06)}

/* committee */
.committee-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); max-width:1200px;margin:0 auto; perspective:1200px}
.member-card{background:linear-gradient(180deg,#fff,#fbfdff); padding:12px;border-radius:12px;text-align:center;box-shadow:var(--card-shadow); transition:transform .28s, box-shadow .28s; transform-style:preserve-3d;}
.member-card:hover{transform:translateY(-8px) rotateX(3deg) rotateY(2deg)}
.member-card img{width:78px;height:78px;border-radius:50%;object-fit:cover;margin:6px auto 8px;display:block}
.member-card h3{font-size:1rem;color:var(--accent-2);margin-bottom:6px}
.member-card p{color:var(--muted)}

/* winners */
.winners-wrapper{max-width:1200px;margin:0 auto}
.winners-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
.winner-card{background:linear-gradient(180deg,#fff,#fbfdff); padding:12px;border-radius:12px; text-align:center; box-shadow:var(--card-shadow); transition:transform .25s}
.winner-card:hover{transform:translateY(-8px)}
.winner-place{font-size:1.3rem;color:var(--gold-1); font-weight:800}

/* creations/gallery */
.creations-grid, .gallery-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); max-width:1200px;margin:0 auto}
.media-card{height:220px;border-radius:12px;overflow:hidden;background:#fff;position:relative;box-shadow:var(--card-shadow);transition:transform .28s, box-shadow .28s; transform-style:preserve-3d;cursor:pointer}
.media-card:hover{transform:translateY(-10px) rotateX(3deg) rotateY(2deg)}
.media-card img, .media-card video{width:100%;height:100%;object-fit:cover;display:block}
.like-badge{position:absolute;left:10px;top:10px;background:rgba(255,255,255,0.98);padding:6px 8px;border-radius:999px;display:flex;gap:8px;align-items:center;font-weight:700;color:var(--accent-2);box-shadow:0 8px 22px rgba(2,48,71,0.06);transition:transform .12s}
.like-badge button{border:0;background:none;cursor:pointer;font-size:16px;color:var(--accent-2)}
.like-badge .count{font-weight:800}
.media-title{position:absolute;left:10px;bottom:10px;right:10px;color:#fff;font-weight:800;text-shadow:0 6px 18px rgba(0,0,0,0.5)}

/* popup */
.popup{position:fixed; inset:0; background:rgba(2,48,71,0.78); display:flex;align-items:center;justify-content:center; z-index:3000; opacity:0; pointer-events:none; transition:opacity .2s}
.popup.active{opacity:1; pointer-events:auto}
.popup-box{width:96%; max-width:1100px; max-height:90vh; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; position:relative}
.popup-media{flex:1; background:#021025; display:flex; align-items:center; justify-content:center; min-height:360px}
.popup-media img, .popup-media video{max-width:100%; max-height:78vh; border-radius:6px}
.popup-info{padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.popup-title{font-weight:800;color:var(--accent-2)}
.popup-actions{display:flex;gap:12px;align-items:center}
.close-btn{position:absolute;top:12px;right:12px;background:#fff;border:0;padding:8px;border-radius:999px;cursor:pointer;box-shadow:0 8px 18px rgba(2,48,71,0.06)}
.nav-btn{position:absolute;top:50%;transform:translateY(-50%);border:0;background:rgba(255,255,255,0.95);padding:10px;border-radius:12px;cursor:pointer;box-shadow:0 12px 30px rgba(2,48,71,0.06)}
.nav-prev{left:12px}.nav-next{right:12px}

/* comments & footer */
.comments-section{max-width:900px;margin:0 auto}
.comment-item{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:12px;margin-bottom:10px; box-shadow:var(--card-shadow)}
footer{background:linear-gradient(90deg,var(--accent-2),var(--deep-3));color:var(--white);padding:24px 18px;text-align:center}
footer a{color:var(--white);text-decoration:none;font-weight:600}

/* micro transitions */
nav a, .tab, .contest-tab, .cta, .view-creation-btn { transition: all .18s cubic-bezier(.2,.9,.3,1); }
.view-creation-btn{padding:8px 10px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--cta-gold),var(--primary-gold));font-weight:800;cursor:pointer}

/* responsive */
@media (max-width:900px){
  nav ul{display:none; position:absolute; left:12px; right:12px; top:66px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94)); border-radius:10px; flex-direction:column; padding:12px; gap:8px; box-shadow:0 20px 60px rgba(2,48,71,0.08)}
  nav ul.show{display:flex}
  .mobile-menu-btn{display:block}
  .creations-grid, .gallery-grid{grid-template-columns:repeat(2,1fr)}
  .winners-grid{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:412px){
  .media-card{height:160px}
  .hero h1{font-size:1.8rem}
}
</style>

<!--
  === ADDITIONAL OVERRIDES FOR ENHANCED HERO & CONTACT (keeps original JS selectors intact) ===
  These rules intentionally come after the big block above so they override safely.
-->
<style>
/* Enhanced hero visual — keeps the same .hero and id="home" */
.hero {
  height: 100vh;
  padding-top: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(2,48,71,0.85) 0%, rgba(33,158,188,0.7) 100%);
  z-index: 1;
}
.hero-bg {
  position: absolute;
  inset: 0;
  background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat;
  filter: brightness(0.72);
  z-index: 0;
}
.hero-wrap {
  position: relative;
  z-index: 2;
  text-align: center;
  max-width: 980px;
  padding: 48px 28px;
  color: var(--white);
  animation: fadeInUp 1s ease forwards;
  opacity: 0;
  background: transparent;
  border-radius: 16px;
}
.hero-wrap h1, .hero h1 { /* ensure both names styled */
  font-size: 3.6rem;
  margin-bottom: 8px;
  letter-spacing: 1px;
  font-weight: 700;
  color: var(--white);
  text-shadow: 0 6px 20px rgba(0,0,0,0.45);
}
.hero-wrap p, .hero p {
  color: var(--white);
  opacity: 0.95;
  font-size: 1.15rem;
  margin-bottom: 18px;
  max-width: 860px;
  margin-left: auto;
  margin-right: auto;
}
.cta {
  display: inline-block;
  margin-top: 14px;
  padding: 12px 26px;
  border-radius: 999px;
  background: linear-gradient(90deg,var(--cta-gold),var(--primary-gold));
  color: var(--black);
  font-weight: 700;
  transition: transform .18s, box-shadow .18s;
}
.cta:hover { transform: translateY(-4px); box-shadow: 0 12px 26px rgba(0,0,0,0.15); }

/* small hero animation keyframes */
@keyframes fadeInUp {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Enhanced contact section: keep same id="contact" & form field IDs */
#contact .contact-grid, #contact .contact-section {
  max-width: 1100px;
  margin: 0 auto;
}
.contact-section {
  background: linear-gradient(135deg, var(--deep-3) 0%, var(--navy-1) 100%);
  color: var(--white);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 50px rgba(2,48,71,0.2);
}
.contact-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
}
.contact-info {
  padding: 36px;
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(6px);
}
.contact-title {
  font-size: 2.0rem;
  margin-bottom: 16px;
}
.contact-item { margin-bottom: 18px; display:flex; align-items:center; }
.contact-icon { width:44px; height:44px; border-radius:50%; background: rgba(255,255,255,0.08); display:flex;align-items:center;justify-content:center;margin-right:12px;color:var(--primary-gold); }
.contact-form-container { padding: 28px; background: #fff; color: var(--deep-3); }

/* responsive adjustments */
@media (max-width:900px) {
  .hero-wrap h1 { font-size: 2.6rem; }
  .contact-container { grid-template-columns: 1fr; }
  .hero { padding-top: 72px; }
}
@media (max-width:412px) {
  .hero-wrap h1 { font-size: 1.8rem; }
}
</style>
</head>
<body>

<header>
  <div class="logo" role="img" aria-label="Sahasgawwa">
    <img class="logo-img" src="logo.png" alt="Sahasgawwa 2025">
  </div>

  <button id="mobile-menu-btn" class="mobile-menu-btn" aria-expanded="false" aria-label="Open menu"><i class="fas fa-bars"></i></button>

  <nav>
    <ul id="nav-menu">
      <li><a href="#home">Home</a></li>
      <li><a href="#about">About</a></li>
      <li><a href="#committee">Committee</a></li>
      <li><a href="#competitions-winners">Competitions</a></li>
      <li><a href="#creations">Creations</a></li>
      <li><a href="#gallery">Gallery</a></li>
      <li><a href="#comments">Comments</a></li>
      <li><a href="#contact">Contact</a></li>
    </ul>
  </nav>
</header>

<!-- ENHANCED HERO (keeps id="home" so JS / nav works) -->
<section class="hero" id="home">
  <div class="hero-bg" aria-hidden="true"></div>

  <!-- keep hero-wrap class from original so any possible JS/CSS references remain OK -->
  <div class="hero-wrap">
    <h1>සහස්ගව්ව'25</h1>
    <p>සහස්‍රයේ මීළග සමතික්‍රමණය - රාජකීය විද්‍යාලයීය කලා මංගල්‍යය</p>
    <a class="cta" href="#about">Learn More</a>
    <a class="cta" style="margin-left:12px;background:transparent;color:#fff;border:2px solid rgba(255,255,255,0.18)" href="#gallery">View Gallery</a>
  </div>
</section>

<section id="about">
  <div class="section-title"><h2>About Sahasgawwa</h2></div>
  <div style="max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center">
    <div>
      <h3 style="color:var(--teal-1)">සහස්‍රයේ මීළග සමතික්‍රමණය</h3>
      <p style="color:var(--muted)">Sahas Gawwa’25 is a vibrant arts festival organized by the Sinhala Language and 
Literary Unit of Royal College, Colombo. This event is held with the goal of 
celebrating the beauty, creativity, and strength of the Sinhala language while 
giving talented students from across the island a stage to shine.
The main highlight of Sahas Gawwa'25 is the awarding of over 400 certificates 
to winners of Sinhala language-related competitions. This event is a proud 
moment not only for the winners but also for everyone who believes in the power 
of language and expression. <br>
In addition to student awards, Sahas Gawwa’25 will also appreciate and honor 
three legendary Sinhala songwriters and story writers, recognizing their lifelong 
contributions to the world of Sinhala literature and music. Their words have 
inspired generations, and their presence at this event will be a true source of 
inspiration to all. <br>
Adding more color to the occasion, the event will feature a variety of 
entertainment items such as dramas, traditional dances, musical performances, 
and short skits, all centered around the theme of Sinhala language and culture. 
These performances aim not only to entertain but also to showcase how language 
lives and breathes through art. <br>
Through Sahas Gawwa’25, we hope to ignite a deeper love for Sinhala, inspire 
young writers and artists, and remind everyone of the timeless value of our 
language and traditions.</p>
    </div>
    <div><img src="Logo.png" alt="hero" style="width:100%;border-radius:10px;display:block"></div>
  </div>
</section>

<section id="committee">
  <div class="section-title"><h2>Committee</h2></div>

  <div class="tabs" id="committee-tabs">
    <button class="tab active" data-filter="all">All</button>
    <button class="tab" data-filter="teachers">Teachers</button>
    <button class="tab" data-filter="committee">Committee Members</button>
  </div>

  <div class="committee-grid" id="committee-grid"></div>
</section>

<section id="competitions-winners">
  <div class="section-title"><h2>Competitions & Winners</h2></div>
  <div class="competitions-tabs" id="competitions-tabs"></div>
  <div class="winners-wrapper" id="winners-wrap"></div>
</section>

<section id="creations">
  <div class="section-title"><h2>Creations</h2></div>
  <div class="creations-grid" id="creations-container"></div>
</section>

<section id="gallery">
  <div class="section-title"><h2>Gallery</h2></div>
  <div class="gallery-grid" id="gallery-container"></div>
</section>

<section id="comments">
  <div class="section-title"><h2>Comments</h2></div>
  <div class="comments-section" style="max-width:900px;margin:0 auto">
    <div id="comments-container"></div>
    <div style="margin-top:12px;background:#fff;padding:12px;border-radius:10px">
      <form id="comment-form">
        <input id="comment-name" placeholder="Name (optional)" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
        <textarea id="comment-message" placeholder="Write your comment..." style="width:100%;min-height:90px;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></textarea>
        <button class="cta" style="margin-top:8px">Submit Comment</button>
      </form>
    </div>
  </div>
</section>

<!-- ENHANCED CONTACT — form IDs kept identical (contact-form, contact-name, contact-email, contact-message) -->
<section id="contact">
  <div class="section-title"><h2>Contact</h2></div>
  <div class="contact-section" aria-label="Contact section">
    <div class="contact-container">
      <div class="contact-info" aria-hidden="false">
        <h3 class="contact-title">Get In Touch</h3>
        <div class="contact-details">
          <div class="contact-item">
            <div class="contact-icon"><i class="fas fa-envelope"></i></div>
            <div class="contact-text">
              <h4>Email</h4>
              <p>sahasgawwa@gmail.com</p>
            </div>
          </div>
          <div class="contact-item">
            <div class="contact-icon"><i class="fas fa-phone"></i></div>
            <div class="contact-text">
              <h4>Phone</h4>
              <p>+94 71 491 4456</p>
              <p>සංගමය භාර ආචාර්ය ඉන්ද්‍රපිය උදිත කුමාර</p>
            </div>
          </div>
          <div class="contact-item">
            <div class="contact-icon"><i class="fas fa-map-marker-alt"></i></div>
            <div class="contact-text">
              <h4>Address</h4>
              <p>Royal College, Colombo 07, Sri Lanka</p>
            </div>
          </div>
        </div>
        <div class="social-links" style="margin-top:12px;display:flex;gap:10px">
          <a href="#" class="social-link" style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="social-link" style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none"><i class="fab fa-instagram"></i></a>
        </div>
      </div>

      <div class="contact-form-container">
        <!-- IMPORTANT: keep id="contact-form" and fields intact for original JS -->
        <form id="contact-form" style="display:flex;flex-direction:column;gap:10px;padding:0">
          <input id="contact-name" placeholder="Your name" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
          <input id="contact-email" placeholder="Your email" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
          <textarea id="contact-message" placeholder="Message" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-height:100px"></textarea>
          <button class="cta" type="submit" style="align-self:flex-start;padding:12px 22px;border-radius:999px;margin-top:4px">Send Message</button>
        </form>
      </div>
    </div>
  </div>
</section>

<footer>
  <div style="max-width:1100px;margin:0 auto">
    <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:8px">
      <img src="logo.png" alt="logo" style="height:36px">
      <div style="color:var(--white);font-weight:700">සහස්‍රයේ මීළග සමතික්‍රමණය</div>
    </div>
    <p style="color:var(--white)">රාජකීය විද්‍යාලයීය කලා මංගල්‍යයය — © 2025 Web Design <a href="https://www.javithhansana.com/">Javith Hansana</a> @ RCSLLU</p>
  </div>
</footer>

<!-- popup -->
<div class="popup" id="popup">
  <div class="popup-box" role="dialog" aria-modal="true">
    <button class="close-btn" id="popup-close"><i class="fas fa-times"></i></button>
    <button class="nav-btn nav-prev" id="popup-prev" aria-label="Previous"><i class="fas fa-chevron-left"></i></button>
    <button class="nav-btn nav-next" id="popup-next" aria-label="Next"><i class="fas fa-chevron-right"></i></button>

    <div class="popup-media" id="popup-media"></div>
    <div class="popup-info">
      <div>
        <div class="popup-title" id="popup-title"></div>
        <div style="color:var(--muted)" id="popup-desc"></div>
      </div>
      <div class="popup-actions">
        <div style="display:flex;align-items:center;gap:8px">
          <button id="popup-like-btn" style="border:0;background:linear-gradient(90deg,var(--cta-gold),var(--primary-gold));padding:8px;border-radius:999px;cursor:pointer"><i class="far fa-heart"></i></button>
          <div id="popup-like-count" style="font-weight:800;color:var(--accent-2)">0</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Firebase config: correct regional RTDB endpoint */
const firebaseConfig = {
  apiKey: "AIzaSyA_trksm5JBNwyQFGMljBIU2JUxB_87u8c",
  authDomain: "sahasgawwa-1a99d.firebaseapp.com",
  projectId: "sahasgawwa-1a99d",
  storageBucket: "sahasgawwa-1a99d.firebasestorage.app",
  messagingSenderId: "955108109669",
  appId: "1:955108109669:web:568ba200b3da1d0bcc058c",
  databaseURL: "https://sahasgawwa-1a99d-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const rdb = firebase.database();

/* Device id generation for per-device like tracking */
let deviceId = localStorage.getItem('sahasgawwa_device_id');
if(!deviceId){
  deviceId = 'd_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem('sahasgawwa_device_id', deviceId);
}

/* DOM refs */
const mobileMenuBtn = document.getElementById('mobile-menu-btn');
const navMenu = document.getElementById('nav-menu');
const committeeGrid = document.getElementById('committee-grid');
const creationsContainer = document.getElementById('creations-container');
const galleryContainer = document.getElementById('gallery-container');
const commentsContainer = document.getElementById('comments-container');
const commentForm = document.getElementById('comment-form');
const contactForm = document.getElementById('contact-form');
const competitionsTabs = document.getElementById('competitions-tabs');
const winnersWrap = document.getElementById('winners-wrap');
const popup = document.getElementById('popup');
const popupMedia = document.getElementById('popup-media');
const popupTitle = document.getElementById('popup-title');
const popupDesc = document.getElementById('popup-desc');
const popupClose = document.getElementById('popup-close');
const popupPrev = document.getElementById('popup-prev');
const popupNext = document.getElementById('popup-next');
const popupLikeBtn = document.getElementById('popup-like-btn');
const popupLikeCount = document.getElementById('popup-like-count');

/* Mobile nav */
mobileMenuBtn.addEventListener('click', () => {
  const open = navMenu.classList.toggle('show');
  mobileMenuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
});
navMenu.querySelectorAll('a').forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    const target = document.querySelector(a.getAttribute('href'));
    if (target) window.scrollTo({ top: target.offsetTop - 72, behavior: 'smooth' });
    navMenu.classList.remove('show');
    mobileMenuBtn.setAttribute('aria-expanded','false');
  });
});

/* helper */
function el(tag, cls, html){ const d=document.createElement(tag); if(cls) d.className = cls; if(html) d.innerHTML = html; return d; }

/* popup state */
let currentList = [], currentIndex = 0, currentCollection = '';

/* ---------------- Committee ---------------- */
async function loadCommittee(){
  try{
    const snap = await db.collection('committee').get();
    const arr = []; snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
    arr.forEach(i => { i._type = (i.type || i.role || '').toLowerCase(); if(!i._type) i._type='committee'; });
    document.getElementById('committee-tabs').querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        document.getElementById('committee-tabs').querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        renderCommittee(arr, btn.getAttribute('data-filter'));
      });
    });
    renderCommittee(arr, 'all');
  }catch(e){ console.error('committee load err', e); committeeGrid.innerHTML = '<p>Unable to load committee</p>'; }
}
function renderCommittee(items, filter){
  committeeGrid.innerHTML = '';
  const filtered = items.filter(it => { if(filter==='all') return true; if(filter==='teachers') return it._type.includes('teacher'); if(filter==='committee') return it._type.includes('committee'); return true;});
  if(!filtered.length){ committeeGrid.innerHTML = '<p style="text-align:center">No members</p>'; return; }
  filtered.forEach(m=>{
    const card = el('div','member-card');
    const img = m.photo || m.avatar || 'https://cdn-icons-png.flaticon.com/512/219/219983.png';
    card.innerHTML = `<img src="${img}" alt="${m.name||'Member'}"><h3>${m.name||'Unnamed'}</h3><p style="color:var(--muted)">${m.position||m.role||''}</p>`;
    card.addEventListener('pointermove', e => {
      const r = card.getBoundingClientRect();
      const px = (e.clientX - r.left)/r.width; const py = (e.clientY - r.top)/r.height;
      const rx = (py - 0.5) * 8; const ry = (px - 0.5) * 8;
      card.style.transform = `translateY(-6px) rotateX(${rx}deg) rotateY(${ry}deg)`;
    });
    card.addEventListener('pointerleave', ()=> card.style.transform = '');
    committeeGrid.appendChild(card);
  });
}

/* ---------------- Competitions & Winners ----------------
   competitions collection -> docs have name and categories array
   winners collection -> have competitionId and category fields
*/
async function loadCompetitionsAndWinners(){
  try{
    const compsSnap = await db.collection('competitions').orderBy('name').get();
    const competitions = []; compsSnap.forEach(d=>competitions.push({ id:d.id, ...d.data() }));
    const winnersSnap = await db.collection('winners').get();
    const winners = []; winnersSnap.forEach(d=>winners.push({ id:d.id, ...d.data() }));

    competitionsTabs.innerHTML = '';
    if(competitions.length === 0){
      const derived = [...new Set(winners.map(w => w.competition || 'General'))];
      derived.forEach((name, idx) => {
        const btn = el('button','contest-tab', name); if(idx===0) btn.classList.add('active');
        btn.addEventListener('click', ()=> { competitionsTabs.querySelectorAll('.contest-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); renderWinnersFallback(winners, name); });
        competitionsTabs.appendChild(btn);
      });
      renderWinnersFallback(winners, derived[0] || 'General'); return;
    }

    competitions.forEach((c, idx) => {
      const btn = el('button','contest-tab', c.name || `Competition ${idx+1}`); if(idx===0) btn.classList.add('active');
      btn.addEventListener('click', ()=> { competitionsTabs.querySelectorAll('.contest-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); renderWinnersForCompetition(competitions, winners, c.id); });
      competitionsTabs.appendChild(btn);
    });

    renderWinnersForCompetition(competitions, winners, competitions[0].id);
  }catch(e){ console.error('competitions/winners err', e); winnersWrap.innerHTML = '<p>Error loading competitions/winners</p>'; }
}

function renderWinnersForCompetition(competitions, winners, competitionId){
  winnersWrap.innerHTML = '';
  const comp = competitions.find(c=>c.id===competitionId) || {};
  const compName = comp.name || 'Competition';
  let categories = Array.isArray(comp.categories) && comp.categories.length ? comp.categories.slice() : [...new Set(winners.filter(w=>w.competitionId===competitionId).map(w=>w.category||'General'))];
  if(categories.length===0) categories = ['General'];
  winnersWrap.appendChild(el('h3','', compName));

  categories.forEach(cat => {
    winnersWrap.appendChild(Object.assign(el('h4','',cat), { style: 'margin:12px 0 8px' }));
    const grid = el('div','winners-grid');
    const items = winners.filter(w => (w.competitionId===competitionId) && ((w.category||'General')===cat));
    if(items.length===0) grid.appendChild(el('div','','<div style="padding:12px;color:var(--muted)">No winners in this category yet</div>'));
    else items.forEach(w => {
      const card = el('div','winner-card');
      card.innerHTML = `<div class="winner-place">${w.place||''}</div><div style="font-weight:800;margin-top:8px">${w.name||''}</div><div style="color:var(--muted);margin-top:6px">${w.school||''}</div>`;
      if(w.creationId){ const b = el('button','view-creation-btn','View Creation'); b.addEventListener('click', ()=> viewCreation(w.creationId)); card.appendChild(b); }
      grid.appendChild(card);
    });
    winnersWrap.appendChild(grid);
  });
}

function renderWinnersFallback(winners, compKey){
  winnersWrap.innerHTML = '';
  winnersWrap.appendChild(el('h3','',compKey));
  const cats = [...new Set(winners.filter(w=> (w.competition||w.category||'General')===compKey).map(w=>w.category||'General'))];
  cats.forEach(cat=>{
    winnersWrap.appendChild(Object.assign(el('h4','',cat), { style: 'margin:10px 0' }));
    const grid = el('div','winners-grid');
    winners.filter(w=> (w.competition||w.category||'General')===compKey && (w.category||'General')===cat).forEach(w=>{
      const card = el('div','winner-card'); card.innerHTML = `<div class="winner-place">${w.place||''}</div><div style="font-weight:800;margin-top:8px">${w.name||''}</div>`; grid.appendChild(card);
    });
    winnersWrap.appendChild(grid);
  });
}

/* ---------------- Creations & Gallery with user-aware transaction ----------------
   Realtime DB structure:
   /likes/{collection}/{id} => { count: N, users: { deviceId: true, ... } }
*/
async function loadCreations(){
  try{
    const snap = await db.collection('creations').get();
    const arr = []; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
    creationsContainer.innerHTML = '';
    if(!arr.length) creationsContainer.innerHTML = '<p style="text-align:center">No creations yet</p>';
    arr.forEach(item => {
      const card = el('div','media-card');
      const media = item.url || item.mediaUrl || item.imageUrl || '';
      const isVideo = media && (media.includes('.mp4')||media.includes('.webm'));
      card.innerHTML = isVideo? `<video src="${media}" muted loop></video>` : `<img src="${media}" alt="${item.title||''}">`;

      const likeBadge = el('div','like-badge'); likeBadge.innerHTML = `<button aria-label="Like"><i class="far fa-heart"></i></button><span class="count">0</span>`;
      card.appendChild(likeBadge);
      card.appendChild(el('div','media-title', item.title || ''));

      const path = `/likes/creations/${item.id}`;

      // initialize object if missing, then attach listener to update count and heart state
      rdb.ref(path).once('value').then(snap => {
        if(snap.val() === null) {
          return rdb.ref(path).set({count:0, users:{}}).catch(err => console.warn('rdb init failed:', err));
        }
      }).catch(err => console.warn('rdb once error:', err)).finally(() => {
        // attach listener to whole object
        rdb.ref(path).on('value', snap => {
          const val = snap.val() || {count:0, users:{}};
          likeBadge.querySelector('.count').textContent = val.count || 0;
          const has = val.users && val.users[deviceId];
          const icon = likeBadge.querySelector('i');
          if(icon) { icon.classList.toggle('fas', !!has); icon.classList.toggle('far', !has); }
        }, err => console.warn('rdb on error (creations):', err));
      });

      // like click toggles using a single transaction on the whole object
      likeBadge.querySelector('button').addEventListener('click', ev => {
        ev.stopPropagation();
        toggleLikeUserTransaction(path);
      });
      card.addEventListener('click', e => { if(e.target.closest('.like-badge')) return; openPopup(arr, item.id, 'creations'); });

      creationsContainer.appendChild(card);
    });
  }catch(e){ console.error('creations load err', e); creationsContainer.innerHTML = '<p>Unable to load creations</p>'; }
}

async function loadGallery(){
  try{
    const snap = await db.collection('gallery').get();
    const arr = []; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
    galleryContainer.innerHTML = '';
    if(!arr.length) galleryContainer.innerHTML = '<p style="text-align:center">No gallery items</p>';
    arr.forEach(item => {
      const card = el('div','media-card');
      const media = item.url || item.imageUrl || item.mediaUrl || item.media || '';
      const isVideo = media && (media.includes('.mp4')||media.includes('.webm'));
      card.innerHTML = isVideo? `<video src="${media}" muted loop></video>` : `<img src="${media}" alt="${item.title||''}">`;

      const likeBadge = el('div','like-badge'); likeBadge.innerHTML = `<button aria-label="Like"><i class="far fa-heart"></i></button><span class="count">0</span>`;
      card.appendChild(likeBadge);
      card.appendChild(el('div','media-title', item.title || ''));

      const path = `/likes/gallery/${item.id}`;

      rdb.ref(path).once('value').then(snap => {
        if(snap.val() === null) return rdb.ref(path).set({count:0, users:{}}).catch(err => console.warn('rdb init failed:', err));
      }).catch(err => console.warn('rdb once error:', err)).finally(() => {
        rdb.ref(path).on('value', snap => {
          const val = snap.val() || {count:0, users:{}};
          likeBadge.querySelector('.count').textContent = val.count || 0;
          const has = val.users && val.users[deviceId];
          const icon = likeBadge.querySelector('i');
          if(icon) { icon.classList.toggle('fas', !!has); icon.classList.toggle('far', !has); }
        }, err => console.warn('rdb on error (gallery):', err));
      });

      likeBadge.querySelector('button').addEventListener('click', ev => { ev.stopPropagation(); toggleLikeUserTransaction(path); });
      card.addEventListener('click', e => { if(e.target.closest('.like-badge')) return; openPopup(arr, item.id, 'gallery'); });

      galleryContainer.appendChild(card);
    });
  }catch(e){ console.error('gallery load err', e); galleryContainer.innerHTML = '<p>Unable to load gallery</p>'; }
}

/* Comments & contact */
async function loadComments(){
  try{
    const snap = await db.collection('comments').where('approved','==',true).orderBy('timestamp','desc').get();
    commentsContainer.innerHTML = '';
    if(snap.empty){ commentsContainer.innerHTML = '<p>No comments yet</p>'; return; }
    snap.forEach(d => {
      const c = { id:d.id, ...d.data() };
      const card = el('div','comment-item');
      const time = c.timestamp ? new Date(c.timestamp.toDate()).toLocaleString() : 'Recently';
      card.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${c.name||'Anonymous'}</strong><small style="color:var(--muted)">${time}</small></div><div style="margin-top:8px">${c.message||''}</div>`;
      commentsContainer.appendChild(card);
    });
  }catch(e){ console.error('comments load err', e); commentsContainer.innerHTML = '<p>Error loading comments</p>'; }
}
document.getElementById('comment-form').addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('comment-name').value || 'Anonymous';
  const message = document.getElementById('comment-message').value || '';
  if(!message.trim()) return alert('Please write a comment');
  try{ await db.collection('comments').add({ name, message, approved:false, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); alert('Submitted (awaiting moderation)'); e.target.reset(); loadComments(); }
  catch(e){ console.error('comment submit err', e); alert('Unable to submit comment'); }
});
contactForm.addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('contact-name').value || '';
  const email = document.getElementById('contact-email').value || '';
  const message = document.getElementById('contact-message').value || '';
  if(!message.trim()) return alert('Please write a message');
  try{ await db.collection('contacts').add({ name, email, message, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); alert('Message sent'); e.target.reset(); }
  catch(e){ console.error('contact submit err', e); alert('Unable to send message'); }
});

/* Popup + navigation */
function openPopup(list, itemId, collection){
  currentList = list; currentCollection = collection; currentIndex = list.findIndex(i => i.id === itemId); if(currentIndex < 0) currentIndex = 0;
  updatePopup(); popup.classList.add('active'); document.body.style.overflow='hidden';
}
function closePopup(){
  if(currentList[currentIndex]) rdb.ref(`/likes/${currentCollection}/${currentList[currentIndex].id}`).off();
  popup.classList.remove('active'); document.body.style.overflow='auto';
}
function updatePopup(){
  popupMedia.innerHTML = '';
  if(!currentList.length) return;
  const item = currentList[currentIndex];
  const media = item.url || item.mediaUrl || item.imageUrl || item.media || '';
  const isVideo = media && (media.includes('.mp4')||media.includes('.webm')||media.includes('.ogg'));
  if(isVideo){ const v=document.createElement('video'); v.src=media; v.controls=true; v.autoplay=true; v.style.maxHeight='78vh'; popupMedia.appendChild(v); }
  else { const img=document.createElement('img'); img.src = media; img.alt = item.title || ''; popupMedia.appendChild(img); }

  popupTitle.textContent = item.title || item.name || '';
  popupDesc.textContent = item.description || item.caption || '';

  const path = `/likes/${currentCollection}/${item.id}`;

  // ensure exists then attach listener for whole object
  rdb.ref(path).once('value').then(snap => {
    if(snap.val() === null) return rdb.ref(path).set({count:0, users:{}}).catch(err => console.warn('rdb init failed (popup):', err));
  }).catch(err => console.warn('rdb once err (popup):', err)).finally(() => {
    rdb.ref(path).off();
    rdb.ref(path).on('value', snap => {
      const val = snap.val() || {count:0, users:{}};
      popupLikeCount.textContent = val.count || 0;
      const has = val.users && val.users[deviceId];
      const icon = popupLikeBtn.querySelector('i');
      if(icon) { icon.classList.toggle('fas', !!has); icon.classList.toggle('far', !has); }
    }, err => console.warn('rdb on error (popup):', err));
  });

  popupLikeBtn.onclick = () => toggleLikeUserTransaction(path);
}

popupPrev.addEventListener('click', (e)=>{ e.stopPropagation(); navigatePopup(-1); });
popupNext.addEventListener('click', (e)=>{ e.stopPropagation(); navigatePopup(1); });
popupClose.addEventListener('click', closePopup);
popup.addEventListener('click', (e)=>{ if(e.target === popup) closePopup(); });
document.addEventListener('keydown', (e)=>{ if(!popup.classList.contains('active')) return; if(e.key==='Escape') closePopup(); if(e.key==='ArrowLeft') navigatePopup(-1); if(e.key==='ArrowRight') navigatePopup(1); });
function navigatePopup(dir){
  if(!currentList.length) return;
  const prev = currentList[currentIndex]; if(prev) rdb.ref(`/likes/${currentCollection}/${prev.id}`).off();
  currentIndex = (currentIndex + dir + currentList.length) % currentList.length;
  updatePopup();
}

/* ---------- New: user-aware transaction on the entire object ---------- */
function toggleLikeUserTransaction(path){
  rdb.ref(path).transaction(current => {
    if(current === null) {
      // initialize and mark this device as liking it
      const o = { count: 1, users: {} };
      o.users[deviceId] = true;
      return o;
    }
    // ensure structure
    if(typeof current !== 'object') current = { count: Number(current) || 0, users: {} };
    const users = current.users || {};
    const has = !!users[deviceId];
    if(has){
      // remove like
      const newCount = (Number(current.count) || 0) - 1;
      delete users[deviceId];
      return { count: Math.max(0, newCount), users };
    } else {
      // add like
      users[deviceId] = true;
      const newCount = (Number(current.count) || 0) + 1;
      return { count: newCount, users };
    }
  }, (err, committed, snapshot) => {
    if(err){
      console.error('Realtime DB transaction err:', err);
      alert('Unable to update like — check console for permission errors.');
    } else if(!committed){
      console.warn('Transaction not committed (likely permissions).');
    } else {
      // success - UI will update via listeners
      // nothing else required here
    }
  });
}

/* viewCreation for winner buttons */
async function viewCreation(creationId){
  try{
    const doc = await db.collection('creations').doc(creationId).get();
    if(!doc.exists) return alert('Creation not found');
    const c = { id: doc.id, ...doc.data() };
    openPopup([c], c.id, 'creations');
  }catch(e){ console.error('view creation err', e); alert('Unable to load creation'); }
}

/* init */
async function init(){
  try{
    await loadCommittee();
    await loadCompetitionsAndWinners();
    await loadCreations();
    await loadGallery();
    await loadComments();
    console.info('Sahasgawwa site initialized. RTDB URL:', firebase.app().options.databaseURL, ' deviceId:', deviceId);
  }catch(e){ console.error('init error', e); }
}
document.addEventListener('DOMContentLoaded', init);

/* helpful RTDB connection logging */
rdb.ref('.info/connected').on('value', snap => {
  if(snap.val() === true) console.info('Realtime DB: connected');
  else console.info('Realtime DB: disconnected/connecting');
});
</script>
</body>
</html>
